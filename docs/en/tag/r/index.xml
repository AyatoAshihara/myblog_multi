<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>R | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ</title>
    <link>/en/tag/r/</link>
      <atom:link href="/en/tag/r/index.xml" rel="self" type="application/rss+xml" />
    <description>R</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Thu, 10 Sep 2020 00:00:00 +0000</lastBuildDate>
    <image>
      <url>/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png</url>
      <title>R</title>
      <link>/en/tag/r/</link>
    </image>
    
    <item>
      <title>Rcpp to speed up data handling (using Tick data processing as an example)</title>
      <link>/en/post/post21/</link>
      <pubDate>Thu, 10 Sep 2020 00:00:00 +0000</pubDate>
      <guid>/en/post/post21/</guid>
      <description>
&lt;script src=&#34;../../../en/post/post21/index_files/header-attrs/header-attrs.js&#34;&gt;&lt;/script&gt;


&lt;div id=&#34;what-i-want-to-do&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;0. What I want to do&lt;/h2&gt;
&lt;p&gt;As mentioned above, what I will show you this time is the pre-processing (and analysis) of currency tick data. I won’t go into details since my main focus is to improve efficiency of analysis using Rcpp, but I will give you a rough idea of what I want to do.&lt;/p&gt;
&lt;p&gt;What we want to do is to detect &lt;strong&gt;jumps&lt;/strong&gt; in the 5-minute returns of the JPY/USD rate. A jump here is a sudden rise (or fall) in the exchange rate compared to the previous point. During the day, exchange rates move in small increments, but when there is an event, they rise (or fall) significantly. It is very interesting to see what kind of event causes a jump. In order to verify this, we first need to detect jumps. The following paper will be used as a reference.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://academic.oup.com/rfs/article-abstract/21/6/2535/1574138?redirectedFrom=fulltext&#34;&gt;Suzanne S. Lee &amp;amp; Per A. Mykland, 2008. “Jumps in Financial Markets: A New Nonparametric Test and Jump Dynamics,” Review of Financial Studies, Society for Financial Studies, vol. 21(6), pages 2535-2563, November.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;It is a highly regarded paper with a Citation of 204. I will explain the estimation method in brief. First, let the continuous compound return be &lt;span class=&#34;math inline&#34;&gt;\(d\log S(t)\)&lt;/span&gt; for &lt;span class=&#34;math inline&#34;&gt;\(t&amp;gt;0\)&lt;/span&gt;. where &lt;span class=&#34;math inline&#34;&gt;\(S(t)\)&lt;/span&gt; is the price of the asset at &lt;span class=&#34;math inline&#34;&gt;\(t\)&lt;/span&gt;. If there are no jumps in the market, &lt;span class=&#34;math inline&#34;&gt;\(S(t)\)&lt;/span&gt; is assumed to follow the following stochastic process&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
d\log S(t) = \mu(t)dt + \sigma(t)dW(t) \tag{1}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(W(t)\)&lt;/span&gt; is the standard Brownian motion, &lt;span class=&#34;math inline&#34;&gt;\(\mu(t)\)&lt;/span&gt; is the drift term, and &lt;span class=&#34;math inline&#34;&gt;\(\sigma(t)\)&lt;/span&gt; is the spot volatility. Also, when there is a Jump, &lt;span class=&#34;math inline&#34;&gt;\(S(t)\)&lt;/span&gt; is assumed to follow the following stochastic process&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
d\log S(t) = \mu(t)dt + \sigma(t)dW(t) + Y(t)dJ(t) \tag{2}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(J(t)\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(W(t)\)&lt;/span&gt; are counting processes independent of each other. &lt;a href=&#34;#fn1&#34; class=&#34;footnote-ref&#34; id=&#34;fnref1&#34;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; &lt;span class=&#34;math inline&#34;&gt;\(Y(t)\)&lt;/span&gt; represents the size of the jump and is a predictable process.&lt;/p&gt;
&lt;p&gt;Next, consider the logarithmic return of &lt;span class=&#34;math inline&#34;&gt;\(S(t)\)&lt;/span&gt;. That is, &lt;span class=&#34;math inline&#34;&gt;\(\log S(t_i)/S(t_{i-1})\)&lt;/span&gt;, which follows a normal distribution &lt;span class=&#34;math inline&#34;&gt;\(N(0, \sigma(t_i))\)&lt;/span&gt;. &lt;a href=&#34;#fn2&#34; class=&#34;footnote-ref&#34; id=&#34;fnref2&#34;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; Now, we define the statistic &lt;span class=&#34;math inline&#34;&gt;\(\mathcal{L(i)}\)&lt;/span&gt; at &lt;span class=&#34;math inline&#34;&gt;\(t_i\)&lt;/span&gt; when there is a jump from &lt;span class=&#34;math inline&#34;&gt;\(t_{i-1}\)&lt;/span&gt; to &lt;span class=&#34;math inline&#34;&gt;\(t_{i}\)&lt;/span&gt; as follows.&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\mathcal{L(i)} \equiv \frac{|\log S(t_i)/S(t_{i-1})|}{\hat{\sigma}_{t_i}} \tag{3}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;This is a simple standardization of the absolute value of the log return, but uses the “Realized Bipower Variation” defined below as an estimator of the standard deviation.&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\hat{\sigma}_{t_i} = \frac{1}{K-2}\sum_{j=i-K+2}^{i-2}|\log S(t_j)/\log S(t_{j-1})||\log S(t_{j-1})/\log S(t_{j-2})| \tag{4}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(K\)&lt;/span&gt; is the number of sample sizes contained in the Window. If we use a return in 5-minute increments and the jump occurs at 10:00 on 9/10/2020, and &lt;span class=&#34;math inline&#34;&gt;\(K=270\)&lt;/span&gt;, then we will calculate using samples from the previous day, 9/9/2020 11:30 to 9/11/2020 09:55. What we’re doing is adding up the absolute value of the return multiplied by the absolute value of the return, which seems to make it difficult for the estimate of the next instant after the jump occurs (i.e., &lt;span class=&#34;math inline&#34;&gt;\(t_{i+1}\)&lt;/span&gt; and so on) to be affected by the jump. Incidentally, &lt;span class=&#34;math inline&#34;&gt;\(K=270\)&lt;/span&gt; is introduced in another paper as a recommended value for returns in 5-minute increments.&lt;/p&gt;
&lt;p&gt;Let’s move on to how the Jump statistic calculated in this way can be used in a statistical test to detect a Jump. This is done by considering the maximum value of &lt;span class=&#34;math inline&#34;&gt;\(\mathcal{L(i)}\)&lt;/span&gt;, and when a value deviates greatly from its distribution (such as the 95th percentile), the return is considered to be a Jump.&lt;/p&gt;
&lt;p&gt;If we assume that there is no Jump in period &lt;span class=&#34;math inline&#34;&gt;\([t_{i-1},t_i]\)&lt;/span&gt;, then let the length of this period &lt;span class=&#34;math inline&#34;&gt;\(\Delta=t_i-t_{i-1}\)&lt;/span&gt;
close to 0, that is, &lt;span class=&#34;math inline&#34;&gt;\(\Delta\rightarrow 0\)&lt;/span&gt;, the (absolute) maximum of the standard normal variable converges to the Gumbel distribution. Therefore, Jump can be detected if the null hypothesis is rejected when the following conditions are met.&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
\mathcal{L(i)} &amp;gt; G^{-1}(1-\alpha)S_{n} + C_{n} \tag{5}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(G^{-1}(1-\alpha)\)&lt;/span&gt; is the &lt;span class=&#34;math inline&#34;&gt;\((1-\alpha)\)&lt;/span&gt; quantile function of the standard Gumbell distribution. If &lt;span class=&#34;math inline&#34;&gt;\(\alpha=10%\)&lt;/span&gt;, &lt;span class=&#34;math inline&#34;&gt;\(G^{-1}(1-\alpha)=2.25\)&lt;/span&gt;. Note that (We won’t derive it, but we can prove it using equations 1 and 2)&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
S_{n} = \frac{1}{c(2\log n)^{0.5}},~ \\
C_{n} = \frac{(2\log n)^{0.5}}{c}-\frac{\log \pi+\log(\log n)}{2c(2\log n)^{0.5}}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(c=(2/\pi)^{0.5}\)&lt;/span&gt; and &lt;span class=&#34;math inline&#34;&gt;\(n\)&lt;/span&gt; is the total sample size used for estimation.
Finally, &lt;span class=&#34;math inline&#34;&gt;\(Jump_{t_i}\)&lt;/span&gt; is calculated by&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;math display&#34;&gt;\[
Jump_{t_i} = \log\frac{S(t_i)}{S(t_{i-1})}×I(\mathcal{L(i)} - G^{-1}(1-\alpha)S_{n} + C_{n})\tag{6}
\]&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;where &lt;span class=&#34;math inline&#34;&gt;\(I(⋅)\)&lt;/span&gt; is an Indicator function that returns 1 if the content is greater than 0 and 0 otherwise.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;loading-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;1. Loading data&lt;/h2&gt;
&lt;p&gt;So now that we know how to estimate, let’s load the Tick data first. The data is csv from &lt;code&gt;QuantDataManager&lt;/code&gt; and saved in a working directory.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(magrittr)

# Read Tick data
strPath &amp;lt;- r&amp;quot;(C:\Users\hogehoge\JPYUSD_Tick_2011.csv)&amp;quot;
JPYUSD &amp;lt;- readr::read_csv(strPath)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On an unrelated note, I recently upgraded R to 4.0.2, and I’m quite happy to say that with 4.0 and above, you can escape the strings made by &lt;code&gt;Python&lt;/code&gt;, which relieves some of the stress I’ve been experiencing.&lt;/p&gt;
&lt;p&gt;The data looks like the following: in addition to the date, the Bid value, Ask value and the volume of transactions are stored. Here, we use the 2011 tick. The reason for this is to cover the dollar/yen at the time of the Great East Japan Earthquake.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(JPYUSD)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##     DateTime                        Bid             Ask            Volume     
##  Min.   :2011-01-03 07:00:00   Min.   :75.57   Min.   :75.58   Min.   : 1.00  
##  1st Qu.:2011-03-30 15:09:23   1st Qu.:77.43   1st Qu.:77.44   1st Qu.: 2.00  
##  Median :2011-06-15 14:00:09   Median :80.40   Median :80.42   Median : 2.00  
##  Mean   :2011-06-22 05:43:11   Mean   :79.91   Mean   :79.92   Mean   : 2.55  
##  3rd Qu.:2011-09-09 13:54:51   3rd Qu.:81.93   3rd Qu.:81.94   3rd Qu.: 3.00  
##  Max.   :2011-12-30 06:59:59   Max.   :85.52   Max.   :85.54   Max.   :90.00&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;By the way, &lt;code&gt;DateTime&lt;/code&gt; includes the period from 07:00:00 on 2011/1/3 to 06:59:59 on 2011-12-30 (16:59:59 on 2011-12-30) in Japan by UTC. The sample size is approximately 12 million entries.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;NROW(JPYUSD)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## [1] 11946621&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;preprocessing&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;2. Preprocessing&lt;/h2&gt;
&lt;p&gt;Then calculate the median value from Bid and Ask and take the logarithm to calculate the return later.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Calculate the median value of Ask and Bid and make it logarithmic (for calculating the logarithmic return).
JPYUSD &amp;lt;- JPYUSD %&amp;gt;% dplyr::mutate(Mid = (Ask+Bid)/2) %&amp;gt;% 
                     dplyr::mutate(logMid = log(Mid))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I format the currently irregularly arranged trading data into 5-minute increments of returns. The way to do it is:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;Create a &lt;code&gt;POSIXct&lt;/code&gt; vector with 1 year chopped every 5 minutes.&lt;/li&gt;
&lt;li&gt;create a function that calculates the logarithmic return from the first and last sample in the window of 5min in turn, if you pass 1. as an argument.&lt;/li&gt;
&lt;li&gt;execute. This is the plan. First, create the vector of 1.&lt;/li&gt;
&lt;/ol&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Create POSIX vector to calculate returns in 5min increments (288 x days)
start &amp;lt;- as.POSIXct(&amp;quot;2011-01-02 22:00:00&amp;quot;,tz=&amp;quot;UTC&amp;quot;)
end &amp;lt;- as.POSIXct(&amp;quot;2011-12-31 21:55:00&amp;quot;,tz=&amp;quot;UTC&amp;quot;)
from &amp;lt;- seq(from=start,to=end,by=5*60)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then, let’s move on to 2. If you have 12 million data, even if you use &lt;code&gt;purrr::map&lt;/code&gt; or &lt;code&gt;apply&lt;/code&gt; with &lt;code&gt;R&lt;/code&gt;, it takes a long time to call a function and it’s quite inefficient. I tried to use &lt;code&gt;sapply&lt;/code&gt;, but it didn’t complete the process and it was forced to terminate. &lt;code&gt;RCCp&lt;/code&gt; is useful in such a case. Although &lt;code&gt;R&lt;/code&gt; has many very useful functions for graphs and statistics, it is not very good at large repetition, including calls to user-defined functions (because it is a scripting language, rather than a compiling language, I mean). So, I write the part of repetitive process in &lt;code&gt;C++&lt;/code&gt; and compile it as &lt;code&gt;R&lt;/code&gt; function using &lt;code&gt;Rcpp&lt;/code&gt; and execute it. It is very efficient to compile and visualize the results and write them in &lt;code&gt;R&lt;/code&gt;. Also, &lt;code&gt;Rccp&lt;/code&gt; helps you to write &lt;code&gt;C++&lt;/code&gt; in a similar way to &lt;code&gt;R&lt;/code&gt; with less sense of discomfort. I think the following will give you a good idea of the details. It’s pretty well organized and is God, to say the least.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://teuder.github.io/rcpp4everyone_en/&#34;&gt;Rcpp for everyone&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Now, let’s write the code for the second step. In coding, I used articles on the net for reference. C++ has a longer history and more users than &lt;code&gt;R&lt;/code&gt;, so you can find information you want to know.&lt;/p&gt;
&lt;pre class=&#34;cpp&#34;&gt;&lt;code&gt;#include &amp;lt;Rcpp.h&amp;gt;
#include &amp;lt;algorithm&amp;gt;

using namespace Rcpp;
//[[Rcpp::plugins(cpp11)]]

// [[Rcpp::export]]
DataFrame Rolling_r_cpp(
    DataFrame input,               // Data frame of (measurement time, measured value data)
    newDatetimeVector from,        // The starting point vector for the timing of the calculation
    double time_window = 5*60)  // Calculated window width (in seconds)
{ 
  
  // Extract the measurement time and value as a vector
  newDatetimeVector time = input[&amp;quot;DateTime&amp;quot;]; // This time is assumed to be sorted in ascending order.
  NumericVector     data = input[&amp;quot;logMid&amp;quot;];
  
  // The endpoint vector of the timing to be calculated
  newDatetimeVector to = from + time_window;
  
  // Number to calculate
  R_xlen_t N = from.length();
  
  // vector for storage 
  NumericVector value(N);
  
  // An object representing the position of a vector element
  newDatetimeVector::iterator begin = time.begin();
  newDatetimeVector::iterator end   = time.end();
  newDatetimeVector::iterator p1    = begin;
  newDatetimeVector::iterator p2    = begin;
  
  // Loop for window i
  for(R_xlen_t i = 0; i &amp;lt; N; ++i){
    // Rcout &amp;lt;&amp;lt; &amp;quot;i=&amp;quot; &amp;lt;&amp;lt; i &amp;lt;&amp;lt; &amp;quot;\n&amp;quot;;
    
    double f = from[i];         // Time of the window&amp;#39;s start point
    double t = f + time_window; // The time of the window&amp;#39;s endpoint
    
    // If the endpoint of the window is before the first measurement time, it is NA or
    // If the starting point of the window is after the last measurement time, NA
    if(t &amp;lt;= *begin || f &amp;gt; *(end-1)){ 
      value[i]  = NA_REAL;
      continue;// Go to the next loop
    }
    
    // Vector time from position p1 and subsequent elements x
    // Let p1 be the position of the first element whose time is at the start point f &amp;quot;after&amp;quot; the window
    p1 = std::find_if(p1, end, [&amp;amp;f](double x){return f&amp;lt;=x;});
    // p1 = std::lower_bound(p1, end, f); //Same as above
    
    // Vector time from position p1 and subsequent elements x
    // Let p2 be the position of the last element whose time is &amp;quot;before&amp;quot; the endpoint t of the window
    // (In the below, this is accomplished by making the time one position before the &amp;#39;first element&amp;#39;, where the time is the window&amp;#39;s endpoint t &amp;#39;after&amp;#39;)
    p2 = std::find_if(p1, end, [&amp;amp;t](double x){return t&amp;lt;=x;}) - 1 ;
    // p2 = std::lower_bound(p1, end, t) - 1 ;//Same as above
    
    // Convert the position p1,p2 of an element to the element numbers i1, i2
    R_xlen_t i1 = p1 - begin;
    R_xlen_t i2 = p2 - begin; 
    
    
    // Checking the element number
    // C++ starts with the element number 0, so I&amp;#39;m adding 1 to match the R
    // Rcout &amp;lt;&amp;lt; &amp;quot;i1 = &amp;quot; &amp;lt;&amp;lt; i1+1 &amp;lt;&amp;lt; &amp;quot; i2 = &amp;quot; &amp;lt;&amp;lt; i2+1 &amp;lt;&amp;lt; &amp;quot;\n&amp;quot;;
    
    
    // Calculate the data in the relevant range
    if(i1&amp;gt;i2) {
      value[i] = NA_REAL; // When there is no data in the window
    } else { 
      value[i] = data[i2] - data[i1];
    }
    // ↑You can create various window functions by changing above
    
  }
  
  // Output the calculated time and the value as a data frame.
  DataFrame out =
    DataFrame::create(
      Named(&amp;quot;from&amp;quot;, from),
      Named(&amp;quot;r&amp;quot;, value*100));
  
  return out;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you compile the program with &lt;code&gt;Rcpp::sourceCpp&lt;/code&gt;, the function of &lt;code&gt;R&lt;/code&gt; can be executed as follows.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;system.time(results &amp;lt;- Rolling_r_cpp(JPYUSD,from))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    ユーザ   システム       経過  
##       0.04       0.02       0.07&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It takes less than a second to process 12 million records. So Convenient!!&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(results)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       from                           r         
##  Min.   :2011-01-02 22:00:00   Min.   :-1.823  
##  1st Qu.:2011-04-03 15:58:45   1st Qu.:-0.014  
##  Median :2011-07-03 09:57:30   Median : 0.000  
##  Mean   :2011-07-03 09:57:30   Mean   : 0.000  
##  3rd Qu.:2011-10-02 03:56:15   3rd Qu.: 0.015  
##  Max.   :2011-12-31 21:55:00   Max.   : 2.880  
##                                NA&amp;#39;s   :29977&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The return is precisely calculated. The recommended length of the window is 270 in 5 min increments, but we’ll make it flexible as well. And we carefully process the &lt;code&gt;NA&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;cpp&#34;&gt;&lt;code&gt;#include &amp;lt;Rcpp.h&amp;gt;
#include &amp;lt;cmath&amp;gt;

using namespace Rcpp;
//[[Rcpp::plugins(cpp11)]]

// [[Rcpp::export]]
float rbv_cpp(
    NumericVector x, // Return vector to calculate rbv
    bool na_rm = true) // If NA is included in x, remove it and calculate it or
{
  
  // Get the number of calculations
  R_xlen_t N = x.length();
  
  // Define variables to contain the results of a calculation
  float out = 0;

  // Check for missing x
  LogicalVector lg_NA = is_na(x);
  
  // If there is a NA in x, whether to exclude that NA and calculate
  if(any(lg_NA).is_true() and na_rm==FALSE){
    out = NA_REAL; // Output NA as a result of the calculation
  } else {
    
    // Excluding NA
    if (any(lg_NA).is_true() and na_rm==TRUE){
      x[is_na(x)==TRUE] = 0.00; // Fill in the NA with zeros and effectively exclude it from the calculation.
    }
    
    // Compute the numerator (sum of rbv)
    for(R_xlen_t i = 1; i &amp;lt; N; ++i){
      out = out + std::abs(x[i])*std::abs(x[i-1]);
    }
    
    // Calculate the average and take the route.
    long denomi; //denominator
    if(N-sum(lg_NA)-2&amp;gt;0){
      denomi = N-sum(lg_NA)-2;
    } else {
      denomi = 1;
    }
    out = out/denomi;
    out = std::sqrt(out);
  }
  
  return out;
}

// [[Rcpp::export]]
DataFrame Rolling_rbv_cpp(
    DataFrame input, //Data frame of (measurement time, measured value data)
    int K = 270, // Rolling Window width to calculate
    bool na_pad = false, // Returning NA when the window width is insufficient
    bool na_remove = false // If the NA exists in the window width, exclude it from the calculation
){
  // Extract the return vector and number of samples
  NumericVector data = input[&amp;quot;r&amp;quot;];
  R_xlen_t T = data.length();
  
  // Prepare a vector to store the results
  NumericVector value(T);
  
  // Calculate and store RBVs per Windows width
  if(na_pad==TRUE){
    value[0] = NA_REAL; // return NA.
    value[1] = NA_REAL; // return NA.
    value[2] = NA_REAL; // return NA.
  } else {
    value[0] = 0; // Return zero.
    value[1] = 0; // Return zero.
    value[2] = 0; // Return zero.
  }
  
  for(R_xlen_t t = 3; t &amp;lt; T; ++t){
    // Bifurcation of the process depending on whether or not there is enough Windows width
    if (t-K&amp;gt;=0){
      value[t] = rbv_cpp(data[seq(t-K,t-1)],na_remove); // Run a normal calculation
    } else if(na_pad==FALSE) {
      value[t] = rbv_cpp(data[seq(0,t-1)],na_remove); // Run a calculation with an incomplete Widnows width of less than K
    } else {
      value[t] = NA_REAL; // return NA.
    }
  }
  
  // Output the calculated time and value as a data frame.
  DataFrame out =
    DataFrame::create(
      Named(&amp;quot;from&amp;quot;, input[&amp;quot;from&amp;quot;]),
      Named(&amp;quot;r&amp;quot;, data),
      Named(&amp;quot;rbv&amp;quot;,value));
  
  return out;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, compile it and run it with &lt;code&gt;R&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;system.time(results &amp;lt;- results %&amp;gt;% Rolling_rbv_cpp(na_remove = FALSE))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##    ユーザ   システム       経過  
##       1.00       0.36       1.36&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So fast!&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;calculating-jump-statistics&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;3. Calculating Jump Statistics&lt;/h2&gt;
&lt;p&gt;Now let’s calculate the statistic &lt;span class=&#34;math inline&#34;&gt;\(\mathcal{L}_{t_i}\)&lt;/span&gt; from the returns and standard deviation we just calculated.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Standardize the absolute value of the log return = Jump statistic
results &amp;lt;- results %&amp;gt;% dplyr::mutate(J=ifelse(rbv&amp;gt;0,abs(r)/rbv,NA))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is what it looks like now.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;summary(results)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       from                           r               rbv              J        
##  Min.   :2011-01-02 22:00:00   Min.   :-1.823   Min.   :0.00    Min.   : 0.00  
##  1st Qu.:2011-04-03 15:58:45   1st Qu.:-0.014   1st Qu.:0.02    1st Qu.: 0.28  
##  Median :2011-07-03 09:57:30   Median : 0.000   Median :0.02    Median : 0.64  
##  Mean   :2011-07-03 09:57:30   Mean   : 0.000   Mean   :0.03    Mean   : 0.93  
##  3rd Qu.:2011-10-02 03:56:15   3rd Qu.: 0.015   3rd Qu.:0.03    3rd Qu.: 1.23  
##  Max.   :2011-12-31 21:55:00   Max.   : 2.880   Max.   :0.16    Max.   :58.60  
##                                NA&amp;#39;s   :29977    NA&amp;#39;s   :44367   NA&amp;#39;s   :44423&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now let’s move on to the Jump test. First, we need to define the useful functions.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Preparing Constants &amp;amp; Functions for Calculating Jump Test
c &amp;lt;- (2/pi)^0.5
Cn &amp;lt;- function(n){
  return((2*log(n))^0.5/c - (log(pi)+log(log(n)))/(2*c*(2*log(n))^0.5))
}
Sn &amp;lt;- function(n){
  1/(c*(2*log(n))^0.5)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now we perform the test. Rejected samples return 1 and all others 0.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Perform a jump test (10%) (return value is logical)
N &amp;lt;- NROW(results$J)
results &amp;lt;- results %&amp;gt;% dplyr::mutate(Jump = J &amp;gt; 2.25*Sn(N) + Cn(N))
summary(results)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##       from                           r               rbv              J        
##  Min.   :2011-01-02 22:00:00   Min.   :-1.823   Min.   :0.00    Min.   : 0.00  
##  1st Qu.:2011-04-03 15:58:45   1st Qu.:-0.014   1st Qu.:0.02    1st Qu.: 0.28  
##  Median :2011-07-03 09:57:30   Median : 0.000   Median :0.02    Median : 0.64  
##  Mean   :2011-07-03 09:57:30   Mean   : 0.000   Mean   :0.03    Mean   : 0.93  
##  3rd Qu.:2011-10-02 03:56:15   3rd Qu.: 0.015   3rd Qu.:0.03    3rd Qu.: 1.23  
##  Max.   :2011-12-31 21:55:00   Max.   : 2.880   Max.   :0.16    Max.   :58.60  
##                                NA&amp;#39;s   :29977    NA&amp;#39;s   :44367   NA&amp;#39;s   :44423  
##     Jump        
##  Mode :logical  
##  FALSE:59864    
##  TRUE :257      
##  NA&amp;#39;s :44423    
##                 
##                 
## &lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;visualization-using-ggplot2&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;4. Visualization using ggplot2&lt;/h2&gt;
&lt;p&gt;Now that the numbers have been calculated, let’s visualize them by plotting the intraday logarithmic return of JPY/USD in 5-minute increments for 2011/03/11 and the jump. By the way, the horizontal axis has been adjusted to Japan time.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# Plotting about Jump at the time of the 2011/03/11 Great East Japan Earthquake
results %&amp;gt;% 
  dplyr::filter(from &amp;gt;= as.POSIXct(&amp;quot;2011-03-11 00:00:00&amp;quot;,tz=&amp;quot;UTC&amp;quot;),from &amp;lt; as.POSIXct(&amp;quot;2011-03-12 00:00:00&amp;quot;,tz=&amp;quot;UTC&amp;quot;)) %&amp;gt;% 
  ggplot2::ggplot(ggplot2::aes(x=from,y=r)) +
  ggplot2::geom_path(linetype=3) +
  ggplot2::geom_path(ggplot2::aes(x=from,y=r*Jump,colour=&amp;quot;red&amp;quot;)) +
  ggplot2::scale_x_datetime(date_breaks = &amp;quot;2 hours&amp;quot;, labels = scales::date_format(format=&amp;quot;%H:%M&amp;quot;,tz=&amp;quot;Asia/Tokyo&amp;quot;)) +
  ggplot2::ggtitle(&amp;quot;JPY/USD Jumps within Tohoku earthquake on 2011-3-11&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: Removed 36 row(s) containing missing values (geom_path).

## Warning: Removed 36 row(s) containing missing values (geom_path).&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;../../../en/post/post21/index_files/figure-html/unnamed-chunk-16-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;I’ve spent quite a bit of time writing this, and it’s 23:37 right now, so I’ll refrain from discussing it in depth, but since the earthquake occurred at 14:46:18, you can see that the market reacted to the weakening of the yen immediately after the disaster. After that, for some reason, the yen moved higher and peaked at 19:00. It is said that the yen is a safe asset, but this is the only time it is not safe given the heightened uncertainty.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;summary&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;5. Summary&lt;/h2&gt;
&lt;p&gt;I introduced the use of &lt;code&gt;Rcpp&lt;/code&gt; to improve the efficiency of &lt;code&gt;R&lt;/code&gt; analysis. The &lt;code&gt;C++&lt;/code&gt; is much faster than &lt;code&gt;R&lt;/code&gt; even if you write the code in a simple way, so it is hard to make coding mistakes. Also, even if a compile error occurs, RStudio gives you a clue as to where the compile error is occurring, so there is no stress in that respect either, which is why I recommend it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&#34;footnotes&#34;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&#34;fn1&#34;&gt;&lt;p&gt;A stochastic process with non-negative, integer, non-decreasing values.&lt;a href=&#34;#fnref1&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&#34;fn2&#34;&gt;&lt;p&gt;The mean is not necessarily zero, depending on the shape of the drift term, but we are assuming a small enough drift term now. In the paper, it is defined more precisely.&lt;a href=&#34;#fnref2&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Fitting the 10-year long-term interest rate</title>
      <link>/en/post/post14/</link>
      <pubDate>Tue, 16 Jul 2019 00:00:00 +0000</pubDate>
      <guid>/en/post/post14/</guid>
      <description>&lt;p&gt;Hi. I wanted to do a fitting of the 10 year long term interest rate for a certain reason. So, we will use US data to analyze the results. First, let&amp;rsquo;s collect the data. We will use the &lt;code&gt;quantmod&lt;/code&gt; package to drop the data from FRED. The command &lt;code&gt;getsymbols(key,from=start date,src=&amp;quot;FRED&amp;quot;, auto.assign=TRUE)&lt;/code&gt; is easy to use. You can find the key on the FRED website.&lt;/p&gt;
&lt;h2 id=&#34;1-data-collection&#34;&gt;1. Data collection&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(quantmod)

&lt;span style=&#34;color:#75715e&#34;&gt;# data name collected&lt;/span&gt;
symbols.name &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;10-Year Treasury Constant Maturity Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Effective Federal Funds Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;Consumer Price Index for All Urban Consumers: All Items&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Civilian Unemployment Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;3-Month Treasury Bill: Secondary Market Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Industrial Production Index&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;10-Year Breakeven Inflation Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Trade Weighted U.S. Dollar Index: Broad, Goods&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;Smoothed U.S. Recession Probabilities&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Moody&amp;#39;s Seasoned Baa Corporate Bond Yield&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;5-Year, 5-Year Forward Inflation Expectation Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Personal Consumption Expenditures&amp;#34;&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;# Collect economic data&lt;/span&gt;
symbols &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GS10&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;FEDFUNDS&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CPIAUCSL&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;UNRATE&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;TB3MS&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;INDPRO&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;T10YIEM&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;TWEXBMTH&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;RECPROUSM156N&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;BAA&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;T5YIFRM&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;PCE&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;getSymbols&lt;/span&gt;(symbols, from &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;1980-01-01&amp;#39;&lt;/span&gt;, src &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;FRED&amp;#34;&lt;/span&gt;, auto.assign &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;GS10&amp;quot;          &amp;quot;FEDFUNDS&amp;quot;      &amp;quot;CPIAUCSL&amp;quot;      &amp;quot;UNRATE&amp;quot;       
##  [5] &amp;quot;TB3MS&amp;quot;         &amp;quot;INDPRO&amp;quot;        &amp;quot;T10YIEM&amp;quot;       &amp;quot;TWEXBMTH&amp;quot;     
##  [9] &amp;quot;RECPROUSM156N&amp;quot; &amp;quot;BAA&amp;quot;           &amp;quot;T5YIFRM&amp;quot;       &amp;quot;PCE&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;macro_indicator &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(GS10,FEDFUNDS,CPIAUCSL,UNRATE,TB3MS,INDPRO,T10YIEM,TWEXBMTH,RECPROUSM156N,BAA,T5YIFRM,PCE)
&lt;span style=&#34;color:#a6e22e&#34;&gt;rm&lt;/span&gt;(GS10,FEDFUNDS,CPIAUCSL,UNRATE,TB3MS,INDPRO,T10YIEM,TWEXBMTH,RECPROUSM156N,BAA,T5YIFRM,PCE,USEPUINDXD)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;2-monthly-analysis-part&#34;&gt;2. Monthly Analysis Part&lt;/h2&gt;
&lt;p&gt;The data are &lt;a href=&#34;htmlwidget/macro_indicator.html&#34;&gt;here&lt;/a&gt;. We will create a dataset for the estimation. The dependent variable is the &lt;code&gt;10-Year Treasury Constant Maturity Rate(GS10)&lt;/code&gt;. The explanatory variables are as follows&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;explanatory variable&lt;/th&gt;
&lt;th&gt;key&lt;/th&gt;
&lt;th&gt;proxy variable&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Federal Funds Rate&lt;/td&gt;
&lt;td&gt;FEDFUNDS&lt;/td&gt;
&lt;td&gt;Short term rate&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Consumer Price Index&lt;/td&gt;
&lt;td&gt;CPIAUCSL&lt;/td&gt;
&lt;td&gt;Price&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Unemployment Rate&lt;/td&gt;
&lt;td&gt;UNRATE&lt;/td&gt;
&lt;td&gt;Employment&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;3-Month Treasury Bill&lt;/td&gt;
&lt;td&gt;TB3MS&lt;/td&gt;
&lt;td&gt;Short term rate&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Industrial Production Index&lt;/td&gt;
&lt;td&gt;INDPRO&lt;/td&gt;
&lt;td&gt;Business conditions&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Breakeven Inflation Rate&lt;/td&gt;
&lt;td&gt;T10YIEM&lt;/td&gt;
&lt;td&gt;Price&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Trade Weighted Dollar Index&lt;/td&gt;
&lt;td&gt;TWEXBMTH&lt;/td&gt;
&lt;td&gt;Exchange rates&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Recession Probabilities&lt;/td&gt;
&lt;td&gt;RECPROUSM156N&lt;/td&gt;
&lt;td&gt;Business condition&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Moody&amp;rsquo;s Seasoned Baa Corporate Bond Yield&lt;/td&gt;
&lt;td&gt;BAA&lt;/td&gt;
&lt;td&gt;Risk premium&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Inflation Expectation Rate&lt;/td&gt;
&lt;td&gt;T5YIFRM&lt;/td&gt;
&lt;td&gt;Price&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Personal Consumption Expenditures&lt;/td&gt;
&lt;td&gt;PCE&lt;/td&gt;
&lt;td&gt;Business condition&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Economic Policy Uncertainty Index&lt;/td&gt;
&lt;td&gt;USEPUINDXD&lt;/td&gt;
&lt;td&gt;Politics&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;It&amp;rsquo;s a pretty appropriate choice of variables, but in many cases, we haven&amp;rsquo;t done it properly in terms of how to model long-term interest rates from a macro modeling perspective&amp;hellip; In DSGE, we formulate the path of short-term interest rates linked to the path of short-term interest rates up to 10 years into the future according to the efficient market hypothesis and long-term interest rates equal to the path of short-term interest rates when I was a graduate student It was modeling (which seems to be done properly in macro finance circles). That&amp;rsquo;s why I&amp;rsquo;ve added short-term interest rates as an explanatory variable. And I also added three indicators for prices that would have an impact on the short-term interest rate. In addition, I added data on the economy because it is well known that it is highly correlated with the economy. This is due to the fact that in the first place, it is common in macro models to model short-term interest rates as following the Taylor rule.&lt;/p&gt;
&lt;p&gt;$$
r_t = \rho r_{t-1} + \alpha \pi_{t} + \beta y_{t}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(r_t\)&lt;/code&gt; is the policy interest rate (short-term interest rate), &lt;code&gt;\(\pi_t\)&lt;/code&gt; is the inflation rate, and &lt;code&gt;\(y_t\)&lt;/code&gt; is the output. The $R_rho, \\alpha, and &lt;code&gt;\(y_t\)&lt;/code&gt; are called deep parameters, which represent inertia, the sensitivity of the interest rate to inflation, and the sensitivity of the interest rate to output, respectively. It is well known as the &amp;ldquo;Taylor&amp;rsquo;s Principle&amp;rdquo; that when $\rho=0, &lt;code&gt;\(\beta=0\)&lt;/code&gt;, a reasonably expected equilibrium solution can only be obtained when &lt;code&gt;\(\alpha&amp;gt;=1\)&lt;/code&gt;. Other explanatory variables include &lt;code&gt;Moody&#39;s Seasoned Baa Corporate Bond Yield&lt;/code&gt;, which may also have an arbitrage relationship with corporate bonds. Also, we would like to add the &lt;code&gt;VIX&lt;/code&gt; index and an index related to finances if we wanted to. The fiscal index is either Quatery or Annualy and cannot be used for monthly estimation. This is the most difficult part. I will re-estimate if I come up with something.&lt;/p&gt;
&lt;p&gt;Now, let&amp;rsquo;s get into the estimation. Since there are many explanatory variables in this case, we want to do a &lt;code&gt;lasso&lt;/code&gt; regression to narrow down the valid variables. We will also do an &lt;code&gt;OLS&lt;/code&gt; for comparison. The explanatory variables will be the values of the dependent variable one period ago. Probably, even one period ago, depending on when the data are published, it may not be in time for the next month&amp;rsquo;s estimates, but I&amp;rsquo;ll do this anyway.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# make dataset&lt;/span&gt;
traindata &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(macro_indicator[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2003-01-01::2015-12-31&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],stats&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lag&lt;/span&gt;(macro_indicator[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2003-01-01::2015-12-31&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)))
testdata  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(macro_indicator[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2016-01-01::&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],stats&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lag&lt;/span&gt;(macro_indicator[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2016-01-01::&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)))

&lt;span style=&#34;color:#75715e&#34;&gt;# fitting OLS&lt;/span&gt;
trial1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;lm&lt;/span&gt;(GS10&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;.,data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; traindata)
&lt;span style=&#34;color:#a6e22e&#34;&gt;summary&lt;/span&gt;(trial1)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## 
## Call:
## lm(formula = GS10 ~ ., data = traindata)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.7593 -0.2182  0.0041  0.2143  0.7051 
## 
## Coefficients:
##                 Estimate Std. Error t value Pr(&amp;gt;|t|)    
## (Intercept)   15.0576773  4.3419245   3.468 0.000693 ***
## FEDFUNDS      -0.2075752  0.1413832  -1.468 0.144253    
## CPIAUCSL      -0.0750111  0.0204871  -3.661 0.000352 ***
## UNRATE        -0.2183796  0.0784608  -2.783 0.006109 ** 
## TB3MS          0.3031085  0.1393904   2.175 0.031310 *  
## INDPRO        -0.0705997  0.0263855  -2.676 0.008328 ** 
## T10YIEM        1.1476564  0.1758964   6.525 1.10e-09 ***
## TWEXBMTH      -0.0313911  0.0117338  -2.675 0.008338 ** 
## RECPROUSM156N -0.0103854  0.0021233  -4.891 2.66e-06 ***
## BAA            0.7802368  0.0858538   9.088 7.60e-16 ***
## T5YIFRM       -0.4529529  0.1881510  -2.407 0.017342 *  
## PCE            0.0009815  0.0002477   3.963 0.000116 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2953 on 143 degrees of freedom
## Multiple R-squared:  0.9218,	Adjusted R-squared:  0.9158 
## F-statistic: 153.2 on 11 and 143 DF,  p-value: &amp;lt; 2.2e-16
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It&amp;rsquo;s a higher degree of freedom-adjusted coefficient of determination; we use the model through 12/31/2015 to predict the out-sample data (01/01/2016~) and calculate the mean squared error.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;est.OLS.Y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(trial1,testdata[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;])
Y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(testdata[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
mse.OLS &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;((Y &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; est.OLS.Y)^2) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(Y)
mse.OLS
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.2422673
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The next step is the &lt;code&gt;lasso&lt;/code&gt; regression, using the &lt;code&gt;cv.glmnet&lt;/code&gt; function of the &lt;code&gt;glmnet&lt;/code&gt; package to perform Cross Validation and determine &lt;code&gt;\(\lambda\)&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# fitting lasso regression&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(glmnet)
trial2 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cv.glmnet&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(traindata[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;]),&lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(traindata[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]),family&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gaussian&amp;#34;&lt;/span&gt;,alpha&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;plot&lt;/span&gt;(trial2)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post14/index_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;trial2&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.001106745
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;coef&lt;/span&gt;(trial2,s&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;trial2&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## 12 x 1 sparse Matrix of class &amp;quot;dgCMatrix&amp;quot;
##                         s1
## (Intercept)    9.560938684
## FEDFUNDS      -0.007306457
## CPIAUCSL      -0.045386980
## UNRATE        -0.174775320
## TB3MS          0.126669996
## INDPRO        -0.059539752
## T10YIEM        1.188103243
## TWEXBMTH      -0.015425929
## RECPROUSM156N -0.009488571
## BAA            0.743677181
## T5YIFRM       -0.459542956
## PCE            0.000602374
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;Unemployment Rate&lt;/code&gt;, &lt;code&gt;3-Month Treasury Bill&lt;/code&gt;, &lt;code&gt;Breakeven Inflation Rate&lt;/code&gt;, &lt;code&gt;Moody&#39;s Seasoned Baa Corporate Bond Yield&lt;/code&gt; and &lt;code&gt;Inflation Expectation Rate&lt;/code&gt;. That&amp;rsquo;s the result of a larger regression coefficient. Other than the unemployment rate, the results are within expectations. However, the correlation with the economy seems to be low as far as this result is concerned (does it only work in the opposite direction?). Calculate the MSE.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;est.lasso.Y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(trial2, newx &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(testdata[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;]), s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; trial2&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min, type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;response&amp;#39;&lt;/span&gt;)
mse.lasso &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;((Y &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; est.lasso.Y)^2) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(Y)
mse.lasso
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.1842137
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The &lt;code&gt;lasso&lt;/code&gt; regression gives better results. Let&amp;rsquo;s plot the predicted and actual values from the &lt;code&gt;lasso&lt;/code&gt; regression as a time series.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(tidyverse)

&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;gather&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(actual&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Y[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],lasso_prediction&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;est.lasso.Y[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],OLS_prediction&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;est.OLS.Y,date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.POSIXct&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rownames&lt;/span&gt;(Y))),key&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;data,value&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;rate,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;date),&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;date,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;rate, colour&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;data)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(size&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.5&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;scale_x_datetime&lt;/span&gt;(breaks &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;6 month&amp;#34;&lt;/span&gt;,date_labels &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;%Y-%m&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;scale_y_continuous&lt;/span&gt;(breaks&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1.5&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2.5&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3.5&lt;/span&gt;),limits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3.5&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post14/index_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The sense of direction is good. On the other hand, I am not predicting a sharp decline in interest rates from January 2016 or after December 2018. It looks like we&amp;rsquo;ll have to try to do one of the following to improve the accuracy of this part of the projections: consider some variables OR run a rolling estimate.&lt;/p&gt;
&lt;h2 id=&#34;3-daily-analysis-part&#34;&gt;3. Daily Analysis Part&lt;/h2&gt;
&lt;p&gt;In addition to monthly analysis, I would like to do daily analysis. In the case of daily data, the &lt;code&gt;jagged edge&lt;/code&gt; problem is unlikely to occur because the data is often released after the market closes. We will start by collecting daily data.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# data name collected&lt;/span&gt;
symbols.name &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;10-Year Treasury Constant Maturity Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Effective Federal Funds Rate&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;based on U.S. Dollar&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NASDAQ Composite Index&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;3-Month Treasury Bill: Secondary Market Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Economic Policy Uncertainty Index for United States&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;
&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;10-Year Breakeven Inflation Rate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Trade Weighted U.S. Dollar Index: Broad, Goods&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Moody&amp;#39;s Seasoned Baa Corporate Bond Yield&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;5-Year, 5-Year Forward Inflation Expectation Rate&amp;#34;&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;# Collect economic data&lt;/span&gt;
symbols &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DGS10&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DFF&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NASDAQCOM&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DTB3&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;USEPUINDXD&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;T10YIE&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DTWEXB&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DBAA&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;T5YIFR&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;getSymbols&lt;/span&gt;(symbols, from &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;1980-01-01&amp;#39;&lt;/span&gt;, src &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;FRED&amp;#34;&lt;/span&gt;, auto.assign &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] &amp;quot;DGS10&amp;quot;      &amp;quot;DFF&amp;quot;        &amp;quot;NASDAQCOM&amp;quot;  &amp;quot;DTB3&amp;quot;       &amp;quot;USEPUINDXD&amp;quot;
## [6] &amp;quot;T10YIE&amp;quot;     &amp;quot;DTWEXB&amp;quot;     &amp;quot;DBAA&amp;quot;       &amp;quot;T5YIFR&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;NASDAQCOM.r &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ROC&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(NASDAQCOM))
macro_indicator.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(DGS10,DFF,NASDAQCOM.r,DTB3,USEPUINDXD,T10YIE,DTWEXB,DBAA,T5YIFR)
&lt;span style=&#34;color:#a6e22e&#34;&gt;rm&lt;/span&gt;(DGS10,DFF,NASDAQCOM,NASDAQCOM.r,DTB3,USEPUINDXD,T10YIE,DTWEXB,DBAA,T5YIFR)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The next step is to build the data set. We separate the data for training and for training. Considering the actual prediction process, we use data from two business days ago as the explanatory variables.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# make dataset&lt;/span&gt;
traindata.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(macro_indicator.d[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1980-01-01::2010-12-31&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],stats&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lag&lt;/span&gt;(macro_indicator.d[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;1980-01-01::2010-12-31&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)))
testdata.d  &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(macro_indicator.d[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2010-01-01::&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],stats&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;lag&lt;/span&gt;(macro_indicator.d[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2010-01-01::&amp;#34;&lt;/span&gt;][,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;],&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)))

&lt;span style=&#34;color:#75715e&#34;&gt;# fitting OLS&lt;/span&gt;
trial1.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;lm&lt;/span&gt;(DGS10&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;.,data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; traindata.d)
&lt;span style=&#34;color:#a6e22e&#34;&gt;summary&lt;/span&gt;(trial1.d)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## 
## Call:
## lm(formula = DGS10 ~ ., data = traindata.d)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.81961 -0.12380  0.00509  0.14514  0.72712 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&amp;gt;|t|)    
## (Intercept) -3.5168438  0.1664198 -21.132  &amp;lt; 2e-16 ***
## DFF          0.0770736  0.0217208   3.548 0.000403 ***
## NASDAQCOM   -0.4301865  0.4280568  -1.005 0.315121    
## DTB3         0.1137128  0.0238678   4.764 2.14e-06 ***
## USEPUINDXD  -0.0006591  0.0001073  -6.144 1.11e-09 ***
## T10YIE       0.6957403  0.0351666  19.784  &amp;lt; 2e-16 ***
## DTWEXB       0.0276208  0.0010896  25.350  &amp;lt; 2e-16 ***
## DBAA         0.2879946  0.0131335  21.928  &amp;lt; 2e-16 ***
## T5YIFR       0.3433321  0.0376058   9.130  &amp;lt; 2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2167 on 1148 degrees of freedom
## Multiple R-squared:  0.8902,	Adjusted R-squared:  0.8894 
## F-statistic:  1163 on 8 and 1148 DF,  p-value: &amp;lt; 2.2e-16
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The coefficient of determination remains high.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;est.OLS.Y.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(trial1.d,testdata.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;])
Y.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(testdata.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
mse.OLS.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;((Y.d &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; est.OLS.Y.d)^2) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(Y.d)
mse.OLS.d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.8350614
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Next is the &lt;code&gt;lasso&lt;/code&gt; regression. Determine &lt;code&gt;\(lambda\)&lt;/code&gt; in &lt;code&gt;CV&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# fitting lasso regression&lt;/span&gt;
trial2.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cv.glmnet&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(traindata.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;]),&lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(traindata.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]),family&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;gaussian&amp;#34;&lt;/span&gt;,alpha&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;plot&lt;/span&gt;(trial2.d)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post14/index_files/figure-html/unnamed-chunk-10-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;trial2.d&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.001339007
&lt;/code&gt;&lt;/pre&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;coef&lt;/span&gt;(trial2.d,s&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;trial2.d&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## 9 x 1 sparse Matrix of class &amp;quot;dgCMatrix&amp;quot;
##                        s1
## (Intercept) -3.4297225594
## DFF          0.0707532975
## NASDAQCOM   -0.3512778327
## DTB3         0.1204390843
## USEPUINDXD  -0.0006453775
## T10YIE       0.6894098221
## DTWEXB       0.0272773903
## DBAA         0.2831306290
## T5YIFR       0.3411269206
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The coefficient of &lt;code&gt;libor&lt;/code&gt; became zero, and the MSE of &lt;code&gt;OLS&lt;/code&gt; was higher than that of &lt;code&gt;libor&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;est.lasso.Y.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;predict&lt;/span&gt;(trial2.d, newx &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(testdata.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;]), s &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; trial2.d&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;lambda.min, type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;response&amp;#39;&lt;/span&gt;)
mse.lasso.d &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;((Y.d &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; est.lasso.Y.d)^2) &lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(Y.d)
mse.lasso.d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;## [1] 0.8492769
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Plot the predictions.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;gather&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(actual&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Y.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],lasso_prediction&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;est.lasso.Y.d[,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;],OLS_prediction&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;est.OLS.Y.d,date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.POSIXct&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rownames&lt;/span&gt;(Y.d))),key&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;data,value&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;rate,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;date),&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;date,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;rate, colour&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;data)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;(size&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.5&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;scale_x_datetime&lt;/span&gt;(breaks &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2 year&amp;#34;&lt;/span&gt;,date_labels &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;%Y-%m&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;scale_y_continuous&lt;/span&gt;(breaks&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1.5&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2.5&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;3.5&lt;/span&gt;),limits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1.25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post14/index_files/figure-html/unnamed-chunk-12-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;As with the monthly, there is very little difference between the predicted values for &lt;code&gt;OLS&lt;/code&gt; and &lt;code&gt;lasso&lt;/code&gt;. We have been able to capture the fluctuations quite nicely, but we have not been able to capture the interest rate decline caused by the &lt;code&gt;United States federal government credit-rating downgrades&lt;/code&gt; in 2011 or the interest rate increase associated with the economic recovery in 2013. The only daily economic indicator I have is POS data, but I might be able to use the recently used nightlight satellite imagery data, if I had to say so. I&amp;rsquo;ll try it if I have time. For now, I&amp;rsquo;d like to end this article for now. Thank you for reading this article.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Scraping past race results on yahoo horse racing on rvest (for the second time)</title>
      <link>/en/post/post11/</link>
      <pubDate>Sat, 13 Jul 2019 00:00:00 +0000</pubDate>
      <guid>/en/post/post11/</guid>
      <description>&lt;p&gt;For the second time, I&amp;rsquo;d like to drop past race results in rvest again. If you haven&amp;rsquo;t seen the past articles, I suggest you look at that one first.&lt;/p&gt;
&lt;p&gt;The reason I decided to take back the data this time is because I wanted to add more items to the explanatory variables when analyzing horse racing. So this time I created the program as an addition to the previous R script. The 14 new data items I added are as follows&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;grass or dirt.&lt;/li&gt;
&lt;li&gt;right-handed or left-handed.&lt;/li&gt;
&lt;li&gt;race conditions (good or slight)&lt;/li&gt;
&lt;li&gt;weather&lt;/li&gt;
&lt;li&gt;the color of the horse&amp;rsquo;s coat (chestnut, deer hair, etc.)&lt;/li&gt;
&lt;li&gt;horse owner&lt;/li&gt;
&lt;li&gt;producers&lt;/li&gt;
&lt;li&gt;place of origin&lt;/li&gt;
&lt;li&gt;date of birth&lt;/li&gt;
&lt;li&gt;the father&amp;rsquo;s horse&lt;/li&gt;
&lt;li&gt;the mother&amp;rsquo;s horse&lt;/li&gt;
&lt;li&gt;winnings up to that race (available from 2003)&lt;/li&gt;
&lt;li&gt;jockey&amp;rsquo;s weight.&lt;/li&gt;
&lt;li&gt;increase or decrease in the weight of the jockey.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Actually, I haven&amp;rsquo;t finished collecting data yet, and the R program has been running for a long time (I&amp;rsquo;ve been running it for about 3 days). However, the program itself is running tightly and I&amp;rsquo;ll try to introduce the script. Maybe I&amp;rsquo;ll write the results in a postscript.&lt;/p&gt;
&lt;h2 id=&#34;1-script&#34;&gt;1. Script&lt;/h2&gt;
&lt;p&gt;The first step is to call the package.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Web scraping of horse racing data by rvest&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;#install.packages(&amp;#34;rvest&amp;#34;)&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#if (!require(&amp;#34;pacman&amp;#34;)) install.packages(&amp;#34;pacman&amp;#34;)&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#install.packages(&amp;#34;beepr&amp;#34;)&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#install.packages(&amp;#34;RSQLite&amp;#34;)&lt;/span&gt;
pacman&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;p_load&lt;/span&gt;(qdapRegex)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(rvest)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(stringr)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(dplyr)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(beepr)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(RSQLite)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I&amp;rsquo;m pretty much warnning out, so I&amp;rsquo;m banning it and connecting to SQLite&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# warning prohibition&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;options&lt;/span&gt;(warn&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;# Connecting to SQLite&lt;/span&gt;
con &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dbConnect&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;SQLite&lt;/span&gt;(), &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;horse_data.db&amp;#34;&lt;/span&gt;, synchronous&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;off&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Since the odds are only available since 1994, the data is taken from 1994 up to the most recent date. yahoo horse racing has races organized by month, so the data is taken using that as a variable. Basically, you go to &lt;a href=&#34;https://keiba.yahoo.co.jp/schedule/list/2018/?month=7&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;List of race results for the relevant year and month&lt;/a&gt; and then go to &lt;a href=&#34;https://keiba.yahoo.co.jp/race/list/18020106/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Timetable for each day of the race&lt;/a&gt; for each day on that page. Since there are roughly a dozen or so races at each individual track, get the link and go to the &lt;a href=&#34;https://keiba.yahoo.co.jp/race/result/1802010601/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;race results page&lt;/a&gt; for each race. Then you will get the race results. The first step is to get a link to the timetable for each individual racecourse for each day.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;for&lt;/span&gt;(year in &lt;span style=&#34;color:#ae81ff&#34;&gt;1994&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2019&lt;/span&gt;){
  start.time &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.time&lt;/span&gt;() &lt;span style=&#34;color:#75715e&#34;&gt;# calculate time&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# Retrieve the race results page on Yahoo!&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(k in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;12&lt;/span&gt;){ &lt;span style=&#34;color:#75715e&#34;&gt;# K is for the month.&lt;/span&gt;
    
    &lt;span style=&#34;color:#a6e22e&#34;&gt;tryCatch&lt;/span&gt;(
      {
        keiba.yahoo &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;read_html&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://keiba.yahoo.co.jp/schedule/list/&amp;#34;&lt;/span&gt;, year,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/?month=&amp;#34;&lt;/span&gt;,k)) &lt;span style=&#34;color:#75715e&#34;&gt;# Access to the list of race results for a given year and month&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.sleep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
        race_lists &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; keiba.yahoo &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
          &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
          &lt;span style=&#34;color:#a6e22e&#34;&gt;html_attr&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;href&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;# Retrieve all URLs&lt;/span&gt;
        
        &lt;span style=&#34;color:#75715e&#34;&gt;# Get the list of races for each day by track&lt;/span&gt;
        race_lists &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_lists&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(race_lists, pattern&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;race/list/\\d+/&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#75715e&#34;&gt;# Extracts URLs containing &amp;#34;results&amp;#34;.&lt;/span&gt;
      }
      , error &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e){signal &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;}
    )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here, we only extract the links we get that contain the word result in the url. In essence, it is a link to the race tables of each racecourse. From here, we use the links to the race tables of the tracks to access that page and get the links to the pages that contain the results of all 12 races.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(j in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race_lists)){ &lt;span style=&#34;color:#75715e&#34;&gt;# where j is the link to the race table for the year in question.&lt;/span&gt;
      
      &lt;span style=&#34;color:#a6e22e&#34;&gt;tryCatch&lt;/span&gt;(
        {
          race_list &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;read_html&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://keiba.yahoo.co.jp&amp;#34;&lt;/span&gt;,race_lists[j]))
          race_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_list &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_attr&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;href&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;# 全urlを取得&lt;/span&gt;
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# Get the URL of the race results&lt;/span&gt;
          race_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_url&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(race_url, pattern&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;result&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#75715e&#34;&gt;# Extracts URLs containing &amp;#34;results&amp;#34;.&lt;/span&gt;
        }
        , error &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e){signal &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;}
      )
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Now that we have the links to the results of each race, it&amp;rsquo;s time to get the race results and the formatting part of the code. It&amp;rsquo;s quite a long and complicated code. The race results are stored in the following table attributes, so we&amp;rsquo;ll simply pull them first.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;      &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(i in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race_url)){ &lt;span style=&#34;color:#75715e&#34;&gt;# where i is the race that was held at the racecourse in question&lt;/span&gt;
        
        &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(year, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;, k, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;,j, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; group &amp;#34;&lt;/span&gt;, i,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34; order&amp;#34;&lt;/span&gt;))
        
        &lt;span style=&#34;color:#a6e22e&#34;&gt;tryCatch&lt;/span&gt;(
          {
            race1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;read_html&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://keiba.yahoo.co.jp&amp;#34;&lt;/span&gt;,race_url[i])) &lt;span style=&#34;color:#75715e&#34;&gt;# Get the URL of the race results&lt;/span&gt;
            signal &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
            &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.sleep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
          }
          , error &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e){signal &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;}
        )
        
        &lt;span style=&#34;color:#75715e&#34;&gt;# If the race is aborted or there are no errors in the process so far, run the process&lt;/span&gt;
        &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;identical&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
                      &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//div[@class = &amp;#39;resultAtt mgnBL fntSS&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
                      &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;(),&lt;span style=&#34;color:#a6e22e&#34;&gt;character&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; signal &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;){
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# Scraping the race results&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//table[@id = &amp;#39;raceScore&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_table&lt;/span&gt;()
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;do.call&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;data.frame&amp;#34;&lt;/span&gt;,race_result) &lt;span style=&#34;color:#75715e&#34;&gt;# Change the list to a data frame.&lt;/span&gt;
          
          &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(race_result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;order&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;frame_number&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;horse_number&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;horse_name/age&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;time/margin&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;passing_rank/last_3F&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;jockey/weight&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;popularity/odds&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;trainer&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;#　column renaming&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;If you just get a table, it will not be useful for analysis because of the following \n or multiple information in one cell. So, we need to mold the data into a form.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;          &lt;span style=&#34;color:#75715e&#34;&gt;# Passing order and time for 3 furlongs uphill&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,passing_rank&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`passing_rank/last_3F`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;(\\d{2}-\\d{2}-\\d{2}-\\d{2})|(\\d{2}-\\d{2}-\\d{2})|(\\d{2}-\\d{2})&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,last_3F&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`passing_rank/last_3F`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d{2}\\.\\d&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result[&lt;span style=&#34;color:#ae81ff&#34;&gt;-6&lt;/span&gt;]
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# Time and Difference&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,time&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`time/margin`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d\\.\\d{2}\\.\\d|\\d{2}\\.\\d&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,margin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`time/margin`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./.馬身|.馬身|.[:space:]./.馬身|[ア-ン-]+&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;margin[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;order&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;トップ&amp;#34;&lt;/span&gt;
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;margin[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;margin&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;character(0)&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;大差&amp;#34;&lt;/span&gt;
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;margin[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;order&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result[&lt;span style=&#34;color:#ae81ff&#34;&gt;-5&lt;/span&gt;]
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# Horse&amp;#39;s name, age and weight&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,horse_name&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`horse_name/age`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[ァ-ヴー・]+&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,horse_age&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`horse_name/age`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;牡\\d+|牝\\d+|せん\\d+&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_sex &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_age, pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;牡|牝|せん&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_age &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_age, pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d&amp;#34;&lt;/span&gt;)
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,horse_weight&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`horse_name/age`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d{3}&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,horse_weight_change&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`horse_name/age`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\([\\+|\\-]\\d+\\)|\\([\\d+]\\)&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_weight_change &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sapply&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rm_round&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_weight_change, extract&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;), paste, collapse&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,brinker&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`horse_name/age`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;B&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;brinker[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;brinker&lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;B&amp;#34;&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;N&amp;#34;&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result[&lt;span style=&#34;color:#ae81ff&#34;&gt;-4&lt;/span&gt;]
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# jockey&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,jockey&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`jockey/weight`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;[ぁ-ん一-龠]+\\s[ぁ-ん一-龠]+|[:upper:].[ァ-ヶー]+&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,jockey_weight&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`jockey/weight`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d{2}&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;jockey_weight_change &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;jockey_weight_change&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`jockey/weight`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;☆&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;jockey_weight_change&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`jockey/weight`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;△&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;jockey_weight_change&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`jockey/weight`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;△&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result[&lt;span style=&#34;color:#ae81ff&#34;&gt;-4&lt;/span&gt;]
          
          &lt;span style=&#34;color:#75715e&#34;&gt;# Odds and popularity&lt;/span&gt;
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,odds&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`popularity/odds`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\(.+\\)&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,popularity&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;`popularity/odds`,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d+[^(\\d+.\\d)]&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;odds &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sapply&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rm_round&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;odds, extract&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;), paste, collapse&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result[&lt;span style=&#34;color:#ae81ff&#34;&gt;-4&lt;/span&gt;]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Next, we&amp;rsquo;ll import information other than the table we just retrieved. Specifically, race names, weather conditions, track conditions, dates, racecourses, etc. These information are listed at the top of the race results page.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;          &lt;span style=&#34;color:#75715e&#34;&gt;# Race Information&lt;/span&gt;
          race_date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//div[@id = &amp;#39;raceTitName&amp;#39;]/p[@id = &amp;#39;raceTitDay&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
          race_name &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//div[@id = &amp;#39;raceTitName&amp;#39;]/h1[@class = &amp;#39;fntB&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
          race_distance &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//p[@id = &amp;#39;raceTitMeta&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
        
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,race_date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_date,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d+年\\d+月\\d+日&amp;#34;&lt;/span&gt;)))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;年&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;月&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_date)
          race_course &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_date,pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;札幌|函館|福島|新潟|東京|中山|中京|京都|阪神|小倉&amp;#34;&lt;/span&gt;))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_course &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_course
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,race_name&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_name,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\s&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)))
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;mutate&lt;/span&gt;(race_result,race_distance&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_distance,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d+m&amp;#34;&lt;/span&gt;)))
          race_type&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_distance,pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;芝|ダート&amp;#34;&lt;/span&gt;))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;type &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_type
          race_turn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(race_distance,pattern &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;右|左&amp;#34;&lt;/span&gt;))
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_turn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_turn
          
          &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg ryou&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_condition &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;良&amp;#34;&lt;/span&gt;
          } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
                            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg yayaomo&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_condition &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;稍重&amp;#34;&lt;/span&gt;
          } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt;
                            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg omo&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_condition &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;重&amp;#34;&lt;/span&gt;
          } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
                            &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg furyou&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_condition &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;不良&amp;#34;&lt;/span&gt;
          } else race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_condition &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NA&amp;#34;&lt;/span&gt;
          
          &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg hare&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_weather &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;晴れ&amp;#34;&lt;/span&gt;
          } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg ame&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_weather &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;曇り&amp;#34;&lt;/span&gt;
          } else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//img[@class = &amp;#39;spBg kumori&amp;#39;]&amp;#34;&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_weather &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;雨&amp;#34;&lt;/span&gt;
          } else race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;race_weather &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;その他&amp;#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The next step is to get information about each horse. In fact, the horse&amp;rsquo;s name in the table we got earlier is a link, and if you follow the link, you can get [information about each horse] (&lt;a href=&#34;https://keiba.yahoo.co.jp/directory/horse/2015105508/&#34;&gt;https://keiba.yahoo.co.jp/directory/horse/2015105508/&lt;/a&gt;) (such as coat color and date of birth).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;          horse_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_attr&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;href&amp;#34;&lt;/span&gt;) 
          horse_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; horse_url&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(horse_url, pattern&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;directory/horse&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;] &lt;span style=&#34;color:#75715e&#34;&gt;# Extract only links to horse information.&lt;/span&gt;
          
          &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(l in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(horse_url)){
            &lt;span style=&#34;color:#a6e22e&#34;&gt;tryCatch&lt;/span&gt;(
              {
                horse1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;read_html&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://keiba.yahoo.co.jp&amp;#34;&lt;/span&gt;,horse_url[l]))
                &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.sleep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;)
                horse_name &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; horse1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//div[@id = &amp;#39;dirTitName&amp;#39;]/h1[@class = &amp;#39;fntB&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
                horse &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; horse1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//div[@id = &amp;#39;dirTitName&amp;#39;]/ul&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; 
                  &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;colour[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(horse,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;毛色：.+&amp;#34;&lt;/span&gt;)) 
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;owner[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(horse,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;馬主：.+&amp;#34;&lt;/span&gt;))
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;farm[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(horse,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;生産者：.+&amp;#34;&lt;/span&gt;))
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;locality[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(horse,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;産地：.+&amp;#34;&lt;/span&gt;))
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_birthday[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(horse,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d+年\\d+月\\d+日&amp;#34;&lt;/span&gt;))
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;father[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; horse1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//td[@class = &amp;#39;bloodM&amp;#39;][@rowspan = &amp;#39;4&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;mother[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; horse1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//td[@class = &amp;#39;bloodF&amp;#39;][@rowspan = &amp;#39;4&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_text&lt;/span&gt;()
              }
              , error &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(e){
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;colour[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt; 
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;owner[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;farm[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;locality[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_birthday[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;father[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;mother[race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;horse_name&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;horse_name] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
                }
            )
          }
          
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;colour &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;colour,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;毛色：&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;owner &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;owner,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;馬主：&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;farm &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;farm,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;生産者：&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;locality &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;locality,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;産地：&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;)
          &lt;span style=&#34;color:#75715e&#34;&gt;#race_result$horse_birthday &amp;lt;- str_replace_all(race_result$horse_birthday,&amp;#34;年&amp;#34;,&amp;#34;/&amp;#34;)&lt;/span&gt;
          &lt;span style=&#34;color:#75715e&#34;&gt;#race_result$horse_birthday &amp;lt;- str_replace_all(race_result$horse_birthday,&amp;#34;月&amp;#34;,&amp;#34;/&amp;#34;)&lt;/span&gt;
          &lt;span style=&#34;color:#75715e&#34;&gt;#race_result$horse_birthday &amp;lt;- as.Date(race_result$horse_birthday)&lt;/span&gt;
          
          race_result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dplyr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;arrange&lt;/span&gt;(race_result,horse_number) &lt;span style=&#34;color:#75715e&#34;&gt;# arrange in order of precedence&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The next step is to go and drop the amount of money you have won up to that race. You can access this by following the link marked [Runoffs] (&lt;a href=&#34;https://keiba.yahoo.co.jp/race/denma/1802010601/&#34;&gt;https://keiba.yahoo.co.jp/race/denma/1802010601/&lt;/a&gt;) on the race results page. This is where you will find the prize money and you will get it.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;          yosou_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;a&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_attr&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;href&amp;#34;&lt;/span&gt;) 
          yosou_url &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; yosou_url&lt;span style=&#34;color:#a6e22e&#34;&gt;[str_detect&lt;/span&gt;(yosou_url, pattern&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;denma&amp;#34;&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
          
          &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(yosou_url)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
          yosou1 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  &lt;span style=&#34;color:#a6e22e&#34;&gt;read_html&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;https://keiba.yahoo.co.jp&amp;#34;&lt;/span&gt;,yosou_url)) 
          &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.sleep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
          yosou &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; yosou1 &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;html_nodes&lt;/span&gt;(xpath &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;//td[@class = &amp;#39;txC&amp;#39;]&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;()
          prize &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; yosou&lt;span style=&#34;color:#a6e22e&#34;&gt;[grepl&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;万&amp;#34;&lt;/span&gt;,yosou)&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;] &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_extract_all&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;\\d+万&amp;#34;&lt;/span&gt;)
          prize &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;do.call&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;data.frame&amp;#34;&lt;/span&gt;,prize)) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.character&lt;/span&gt;()
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;prize &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; prize
          race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;prize &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;str_replace_all&lt;/span&gt;(race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;prize,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;万&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&amp;#34;&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;%&amp;gt;%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;()
          } else race_result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;prize &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;NA&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;We create a data frame called dataset to store the results of each race and store the data.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;          &lt;span style=&#34;color:#75715e&#34;&gt;## file storage&lt;/span&gt;
          &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(k &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; i &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; j &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;){
            dataset &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; race_result
          } else {
            dataset &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(dataset,race_result)
          }
        }else
        {
          &lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;We couldn&amp;#39;t save it.&amp;#34;&lt;/span&gt;) 
        }
      }
    }
  }
  &lt;span style=&#34;color:#a6e22e&#34;&gt;beep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;3&lt;/span&gt;)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;write.csv&lt;/span&gt;(dataset,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;race_result2.csv&amp;#34;&lt;/span&gt;, row.names &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;FALSE&lt;/span&gt;)
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(year &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1994&lt;/span&gt;){
    &lt;span style=&#34;color:#a6e22e&#34;&gt;dbWriteTable&lt;/span&gt;(con, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;race_result&amp;#34;&lt;/span&gt;, dataset)
  } else {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;dbWriteTable&lt;/span&gt;(con, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;temp&amp;#34;&lt;/span&gt;, dataset)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;dbSendQuery&lt;/span&gt;(con, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;INSERT INTO race_result select * from temp&amp;#34;&lt;/span&gt;)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;dbSendQuery&lt;/span&gt;(con, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DROP TABLE temp&amp;#34;&lt;/span&gt;)
  }
}
end.time &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Sys.time&lt;/span&gt;()
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;str_c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;処理時間は&amp;#34;&lt;/span&gt;,end.time&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;start.time,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;です。&amp;#34;&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;beep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;5&lt;/span&gt;)

&lt;span style=&#34;color:#a6e22e&#34;&gt;options&lt;/span&gt;(warn &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)

&lt;span style=&#34;color:#a6e22e&#34;&gt;dbDisconnect&lt;/span&gt;(con)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;That&amp;rsquo;s all. The data taken is as follows&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;head&lt;/span&gt;(race_result)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;##   order frame_number horse_number   trainer passing_rank last_3F   time
## 1    10            1            1   田中 剛        09-09    39.0 1.14.3
## 2    16            1            2 天間 昭一        11-11    40.3 1.15.7
## 3    15            2            3 田中 清隆        14-14    39.4 1.15.1
## 4     9            2            4 中舘 英二        08-08    39.1 1.14.3
## 5    12            3            5 根本 康広        11-11    39.0 1.14.4
## 6     4            3            6 杉浦 宏昭        04-04    38.4 1.13.2
##      margin         horse_name horse_age horse_sex horse_weight
## 1    アタマ     サトノジョニー         3        牡          512
## 2 3 1/2馬身       ツギノイッテ         3        牡          464
## 3     3馬身           ギュウホ         3        牡          444
## 4 2 1/2馬身 セイウンメラビリア         3        牝          466
## 5      クビ サバイバルトリック         3        牝          450
## 6    アタマ       ステイホット         3        牝          474
##   horse_weight_change brinker      jockey jockey_weight jockey_weight_change
## 1                 +30       N   松岡 正海            56                    0
## 2                  +8       N 西田 雄一郎            56                    0
## 3                  +8       N   杉原 誠人            56                    0
## 4                 +10       N   村田 一誠            54                    0
## 5                  -2       N 野中 悠太郎            51                    0
## 6                  -2       N   大野 拓弥            54                    0
##    odds popularity  race_date race_course       race_name race_distance   type
## 1  40.3         9  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
## 2 340.9        16  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
## 3 283.1        14  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
## 4 299.7        15  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
## 5  26.7         8  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
## 6   2.4         1  2019-01-05        中山 サラ系3歳未勝利         1200m ダート
##   race_turn race_condition race_weather colour                           owner
## 1        右             良         晴れ   栗毛 株式会社 サトミホースカンパニー
## 2        右             良         晴れ 黒鹿毛                     西村 新一郎
## 3        右             良         晴れ   鹿毛           有限会社 ミルファーム
## 4        右             良         晴れ 青鹿毛                       西山 茂行
## 5        右             良         晴れ 黒鹿毛                       福田 光博
## 6        右             良         晴れ   栗毛                       小林 善一
##           farm   locality horse_birthday                 father
## 1   千代田牧場 新ひだか町  2016年1月29日         オルフェーヴル
## 2    織笠 時男     青森県  2016年4月17日 スクワートルスクワート
## 3    神垣 道弘 新ひだか町  2016年4月19日     ジャングルポケット
## 4  石郷岡 雅樹     新冠町  2016年4月21日     キンシャサノキセキ
## 5     原田牧場     日高町  2016年4月30日       リーチザクラウン
## 6 社台ファーム     千歳市  2016年3月13日     キャプテントゥーレ
##               mother prize
## 1 スパークルジュエル     0
## 2   エプソムアイリス     0
## 3     デライトシーン     0
## 4     ドリームシップ     0
## 5   フリーダムガール   180
## 6     ステイアライヴ   455
&lt;/code&gt;&lt;/pre&gt;</description>
    </item>
    
    <item>
      <title>I built the Asset Allocation Model in R.</title>
      <link>/en/post/post2/</link>
      <pubDate>Sun, 17 Feb 2019 00:00:00 +0000</pubDate>
      <guid>/en/post/post2/</guid>
      <description>&lt;p&gt;Hi. I attended a workshop on asset allocation at my place of work, so I&amp;rsquo;d like to run some simulations here, even though this field is completely outside my expertise. In this article, I would like to do an exercise on how to estimate the variance-covariance matrix (predictions) of a minimum variance portfolio as the base portfolio, referring to previous studies. The reference research is in the following paper (in the Journal of Operations Research).&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2947643&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Asset Allocation with Correlation: A Composite Trade-Off&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;1-minimum-variance-portfolio&#34;&gt;1. Minimum Variance Portfolio&lt;/h2&gt;
&lt;p&gt;I won&amp;rsquo;t go into a detailed explanation of the minimum variance portfolio here, but it is a portfolio that calculates the average return and variance of each asset (domestic stocks, foreign stocks, domestic bonds, foreign bonds, and alternatives), plots them on a quadratic plane of average return vertical and variance horizontal axes, calculates the range of possible investments, and then calculates the smallest variance in the set (see the chart below).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Minimum_variance_flontier_of_MPT.svg/1280px-Minimum_variance_flontier_of_MPT.svg.png&#34; alt=&#34;minimum variance portfolio&#34;&gt;&lt;/p&gt;
&lt;p&gt;In an earlier study, Carroll et. al. (2017), the following is stated&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;this paper focusses on minimum-variance portfolios requiring only estimates of asset covariance, hence bypassing the well-known problem of estimation error in forecasting expected asset returns.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Even at present, it is difficult to estimate expected returns, and a minimum variance portfolio, which does not require it, is a useful and practical technique. The objective function of a minimum variance portfolio is, as the name implies, &lt;strong&gt;to minimize diversification&lt;/strong&gt;. If we now denote the vector of collected returns for each asset by &lt;code&gt;\(r\)&lt;/code&gt;, the holding weight of each asset by &lt;code&gt;\(\theta\)&lt;/code&gt;, and the portfolio return by &lt;code&gt;\(R_{p}\)&lt;/code&gt;, then the overall portfolio variance &lt;code&gt;\(var(R_{p})\)&lt;/code&gt; can be written as follows.&lt;/p&gt;
&lt;p&gt;$$
var(R_{p}) = var(r^{T}\theta) = E( (r^{T}\theta)(r^{T}\theta)^{T}) = \theta^{T}\Sigma\theta
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(Sigma\)&lt;/code&gt; is the variance-covariance matrix of &lt;code&gt;\(r\)&lt;/code&gt;. Thus, the minimization problem is as follows&lt;/p&gt;
&lt;p&gt;$$
\min_{\theta}(\theta^{T}\Sigma\theta) \&lt;br&gt;
s.t 1^{T}\theta = 1
$$&lt;/p&gt;
&lt;p&gt;Here we have added full investment as a constraint. Let&amp;rsquo;s use the Lagrangian to solve this problem. The Lagrange function &lt;code&gt;\(L\)&lt;/code&gt; is as follows&lt;/p&gt;
&lt;p&gt;$$
L = \theta^{T}\Sigma\theta + \lambda(1^{T}\theta - 1)
$$&lt;/p&gt;
&lt;p&gt;The first condition is&lt;/p&gt;
&lt;p&gt;$$
\displaystyle\frac{\partial L}{\partial \theta} = 2\Sigma\theta + 1\lambda = 0 \&lt;br&gt;
\displaystyle \frac{\partial L}{\partial \lambda} = 1^{T} \theta = 1
$$&lt;/p&gt;
&lt;p&gt;Solving the first equation for &lt;code&gt;\(\theta\)&lt;/code&gt;, we find that&lt;/p&gt;
&lt;p&gt;$$
\theta = \Sigma^{-1}1\lambda^{*}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\lambda^{*}=-1/2\lambda\)&lt;/code&gt;. Substitute this into the second formula and solve for &lt;code&gt;\(\lambda^{*}\)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;$$
1^{T}\Sigma1\lambda^{&lt;em&gt;} = 1 \&lt;br&gt;
\displaystyle \lambda^{&lt;/em&gt;} = \frac{1}{1^{T}\Sigma^{-1}1}
$$&lt;/p&gt;
&lt;p&gt;Since &lt;code&gt;\(\theta = \Sigma^{-1}1\lambda^{*}\)&lt;/code&gt;, erasing &lt;code&gt;\(\lambda^{*}\)&lt;/code&gt; will cause it to be&lt;/p&gt;
&lt;p&gt;$$
\displaystyle \theta_{gmv} = \frac{\Sigma^{-1}1}{1^{T}\Sigma^{-1}1}
$$&lt;/p&gt;
&lt;p&gt;and we can now find the optimal weight. For now, I&amp;rsquo;ll implement this in R.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;gmv &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(r_dat,r_cov){
  &lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(MASS)
  i &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat),&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  r_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;ginv&lt;/span&gt;(r_cov)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;i)&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(i)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;ginv&lt;/span&gt;(r_cov)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;i)
  wr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; r_dat&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;(r_weight)
  portfolio &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(wr_dat,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,sum)
  pr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(wr_dat,portfolio)
  sd &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sd&lt;/span&gt;(portfolio)
  result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(r_weight,pr_dat,sd)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;names&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;weight&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;return&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;portfolio risk&amp;#34;&lt;/span&gt;) 
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(result)
}

nlgmv &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(r_dat,r_cov){
  qp.out &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;solve.QP&lt;/span&gt;(Dmat&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;r_cov,dvec&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat)),Amat&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;cbind&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat)),&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat))),
           bvec&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat))),meq&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)
  r_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; qp.out&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;solution
  wr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; r_dat&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;r_weight
  portfolio &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(wr_dat,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,sum)
  pr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(wr_dat,portfolio)
  sd &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sd&lt;/span&gt;(portfolio)
  result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(r_weight,pr_dat,sd)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;names&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;weight&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;return&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;portfolio risk&amp;#34;&lt;/span&gt;)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(result)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;The input is a return and variance-covariance matrix for each asset. The output is the weight, return and risk. &lt;code&gt;nlgmv&lt;/code&gt; is a short-sale constrained version of the minimum variance portfolio. Since we cannot get an analytical solution, we are trying to get a numerical solution.&lt;/p&gt;
&lt;h2 id=&#34;2-how-to-predict-the-variance-covariance-matrix&#34;&gt;2. How to predict the variance-covariance matrix&lt;/h2&gt;
&lt;p&gt;We have found the formula for the minimum variance portfolio. The next step is to analyze how to find the input, the variance-covariance matrix. I think the most primitive approach would be the historical approach of finding the covariance matrix for a sample of return data available before that point in time, and then finding the minimum variance portfolio by fixing the value of the covariance matrix (i.e., the weights are also fixed). However, since this is just using historical averages for future projections, I&amp;rsquo;m sure there will be all sorts of problems. As a non-specialist, I can think of a situation where the return on asset A declined significantly the day before, but the variance of this asset is expected to remain high tomorrow, and the effect of yesterday is diluted by using the average. And I feel that not changing the weights from the start would also move away from the optimal point over time. However, there seems to be some trial and error in this area as to how to estimate it then. Also, in Carroll et. al. (2017), it is stated that,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The estimation of covariance matrices for portfolios with a large number of assets still remains a fundamental challenge in portfolio optimization.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The estimates in this paper are based on the following models. All of them are unique in that the variance-covariance matrix is time-varying.&lt;/p&gt;
&lt;h3 id=&#34;a-constant-conditional-correlation-ccc-model&#34;&gt;A. Constant conditional correlation (CCC) model&lt;/h3&gt;
&lt;p&gt;The original paper is &lt;a href=&#34;https://www.jstor.org/stable/2109358?read-now=1&amp;amp;seq=3#page_scan_tab_contents&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;First, from the relationship between the variance-covariance matrix and the correlation matrix, we have &lt;code&gt;\(\Sigma_{t} = D_{t}R_{t}D_{t}\)&lt;/code&gt;, where &lt;code&gt;\(R_{t}\)&lt;/code&gt; is the variance-covariance matrix and &lt;code&gt;\(D_{t}\)&lt;/code&gt; is &lt;code&gt;\(diag(\sigma_{1,t},...,\sigma_{N,t})\)&lt;/code&gt;, a matrix whose diagonal components are the standard deviation of each asset in &lt;code&gt;\(tt\)&lt;/code&gt; period. From here, we estimate &lt;code&gt;\(D_{t}\)&lt;/code&gt; and &lt;code&gt;\(R_{t}\)&lt;/code&gt; separately. First, &lt;code&gt;\(D_{t}\)&lt;/code&gt; is estimated using the following multivariate GARCH model (1,1).&lt;/p&gt;
&lt;p&gt;$$
r_{t} = \mu + u_{t} \&lt;br&gt;
u_{t} = \sigma_{t}\epsilon \&lt;br&gt;
\sigma_{t}^{2} = \alpha_{0} + \alpha_{1}u_{t-1}^{2} + \alpha_{2}\sigma_{t-1}^{2} \&lt;br&gt;
\epsilon_{t} = NID(0,1) \&lt;br&gt;
E(u_{t}|u_{t-1}) = 0
$$ 
where &lt;code&gt;\(\mu\)&lt;/code&gt; is the sample mean of the returns. &lt;code&gt;\(\alpha_{i}\)&lt;/code&gt; is the parameter to be estimated. Since we are estimating &lt;code&gt;\(D_{t}\)&lt;/code&gt; with GARCH, we can say that we are modeling a relationship where the distribution of returns follows a thicker base distribution than the normal distribution and where the change in returns is not constant but depends on the variance of the previous day. We can say that we have estimated &lt;code&gt;\(D_{t}\)&lt;/code&gt; in this way. The next step in the estimation of &lt;code&gt;\(R_{t}\)&lt;/code&gt; is to take a historical approach to the estimation of &lt;code&gt;\(R_{t}\)&lt;/code&gt;, in which the returns are sampled. In other words, &lt;code&gt;\(R_{t}\)&lt;/code&gt; is a constant. Thus, we are making the assumption that the magnitude of return variation varies with time, but the relative relationship of each asset is invariant.&lt;/p&gt;
&lt;h3 id=&#34;b-dynamic-conditional-correlation-dcc-model&#34;&gt;B. Dynamic Conditional Correlation (DCC) model&lt;/h3&gt;
&lt;p&gt;The original paper is &lt;a href=&#34;http://www.cass.city.ac.uk/__data/assets/pdf_file/0003/78960/Week7Engle_2002.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;こちらのモデルでは、$D_{t}$を求めるところまでは①と同じですが、[$R_{t}$の求め方が異なっており、ARMA(1,1)を用いて推計します。相関行列はやはり定数ではないということで、$tex:t$期までに利用可能なリターンを用いて推計をかけようということになっています。このモデルの相関行列$R_{t}$は、&lt;/p&gt;
&lt;p&gt;This model is the same as (1) up to the point of finding &lt;code&gt;\(D_{t}\)&lt;/code&gt;, but the way of finding &lt;code&gt;\(R_{t}\)&lt;/code&gt; is different, and we use &lt;code&gt;ARMA(1,1)&lt;/code&gt; to estimate it. Since the correlation matrix is still not a constant, we are going to use the available returns up to the &lt;code&gt;\(t\)&lt;/code&gt; period to make the estimate. The correlation matrix &lt;code&gt;\(R_{t}\)&lt;/code&gt; in this model is&lt;/p&gt;
&lt;p&gt;$$
R_{t} = diag(Q_{t})^{-1/2}Q_{t}diag(Q_{t})^{-1/2}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(Q_{t}\)&lt;/code&gt; is a conditional variance-covariance matrix in the &lt;code&gt;\(t\)&lt;/code&gt; period, formulated as follows,&lt;/p&gt;
&lt;p&gt;$$
Q_{t} = \bar{Q}(1-a-b) + adiag(Q_{t-1})^{1/2}\epsilon_{i,t-1}\epsilon_{i,t-1}diag(Q_{t-1})^{1/2} + bQ_{t-1}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\bar{Q}\)&lt;/code&gt; is the variance-covariance matrix calculated in a historical way and &lt;code&gt;\(a,b\)&lt;/code&gt; is the parameter. This method differs from the previous one in that it assumes that not only does the magnitude of return variation vary with time, but also the relative relationship of each asset changes over time. Since we have observed some events in which the returns of all assets fall and the correlation of each asset becomes positive during a financial crisis, this formulation may be attractive.&lt;/p&gt;
&lt;h3 id=&#34;c-dynamic-equicorrelation-deco-model&#34;&gt;C. Dynamic Equicorrelation (DECO) model&lt;/h3&gt;
&lt;p&gt;The original paper is &lt;a href=&#34;https://faculty.chicagobooth.edu/bryan.kelly/research/pdf/deco.pdf&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;I haven&amp;rsquo;t read this paper exactly yet, but from the definition of the correlation matrix &lt;code&gt;\(R_{t}\)&lt;/code&gt; becomes&lt;/p&gt;
&lt;p&gt;$$
R_{t} = (1-\rho_{t})I_{N} + \rho_{t}1
$$&lt;/p&gt;
&lt;p&gt;Here, &lt;code&gt;\(\rho_{t}\)&lt;/code&gt; is a scalar and a coefficient for the degree of equicorrelation, and I understand that equicorrelation is an average pair-wise correlation. In other words, if there are no missing values, it&amp;rsquo;s no different than a normal correlation. However, it seems to be a good estimator in that respect, because as assets increase, such problems need to be addressed. We can calculate &lt;code&gt;\(\rho_{t}\)&lt;/code&gt; as follows.&lt;/p&gt;
&lt;p&gt;$$
\displaystyle \rho_{t} = \frac{1}{N(N-1)}(\iota^{T}R_{t}^{DCC}\iota - N) = \frac{2}{N(N-1)}\sum_{i&amp;gt;j}\frac{q_{ij,t}}{\sqrt{q_{ii,t} q_{jj,t}}}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\iota\)&lt;/code&gt; is an &lt;code&gt;\(N×1\)&lt;/code&gt; vector with all elements being 1. And &lt;code&gt;\(q_{ij,t}\)&lt;/code&gt; is the &lt;code&gt;\(i,j\)&lt;/code&gt; element of &lt;code&gt;\(Q_{t}\)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now that we&amp;rsquo;ve modeled the variance-covariance matrix, we&amp;rsquo;ll implement it so far in &lt;code&gt;R&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;carroll &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(r_dat,FLG){
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(rmgarch)
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt;(FLG &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;){
    H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cov&lt;/span&gt;(r_dat)
  }else{
    &lt;span style=&#34;color:#75715e&#34;&gt;#1. define variables&lt;/span&gt;
    N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NCOL&lt;/span&gt;(r_dat) &lt;span style=&#34;color:#75715e&#34;&gt;# the number of assets&lt;/span&gt;
    
    &lt;span style=&#34;color:#75715e&#34;&gt;#2. estimate covariance matrix&lt;/span&gt;
    basic_garch &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ugarchspec&lt;/span&gt;(mean.model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(armaOrder &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;),include.mean&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;), variance.model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(garchOrder &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;sGARCH&amp;#39;&lt;/span&gt;), distribution.model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;norm&amp;#39;&lt;/span&gt;)
    multi_garch &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;multispec&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;replicate&lt;/span&gt;(N, basic_garch))
    dcc_set &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dccspec&lt;/span&gt;(uspec &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; multi_garch, dccOrder &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;), distribution &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;mvnorm&amp;#34;&lt;/span&gt;,model &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;)
    fit_dcc_garch &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dccfit&lt;/span&gt;(dcc_set, data &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; r_dat, fit.control &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(eval.se &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;))
    forecast_dcc_garch &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;dccforecast&lt;/span&gt;(fit_dcc_garch)
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(FLG &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;){
      &lt;span style=&#34;color:#75715e&#34;&gt;#Constant conditional correlation (CCC) model&lt;/span&gt;
      D &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sigma&lt;/span&gt;(forecast_dcc_garch)
      R_ccc &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cor&lt;/span&gt;(r_dat)
      H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(D[,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;R_ccc&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(D[,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
      &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(H) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(r_dat)
      &lt;span style=&#34;color:#a6e22e&#34;&gt;rownames&lt;/span&gt;(H) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(r_dat)
    }
    else{
      &lt;span style=&#34;color:#75715e&#34;&gt;#Dynamic Conditional Correlation (DCC) model&lt;/span&gt;
      H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.matrix&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;rcov&lt;/span&gt;(forecast_dcc_garch)[[1]][,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
      &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(FLG &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;){
        &lt;span style=&#34;color:#75715e&#34;&gt;#Dynamic Equicorrelation (DECO) model&lt;/span&gt;
        one &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,N,N)
        iota &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,N)
        Q_dcc &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rcor&lt;/span&gt;(forecast_dcc_garch,type&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Q&amp;#34;&lt;/span&gt;)[[1]][,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;]
        rho &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.vector&lt;/span&gt;((N&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(N&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;))&lt;span style=&#34;color:#a6e22e&#34;&gt;^&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(iota)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;Q_dcc&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;iota&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;N))
        D &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sigma&lt;/span&gt;(forecast_dcc_garch)
        R_deco &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; (&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;rho)&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,N,N) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; rho&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;one
        H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(D[,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;R_deco&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(D[,,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;])
        &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(H) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(r_dat)
        &lt;span style=&#34;color:#a6e22e&#34;&gt;rownames&lt;/span&gt;(H) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(r_dat)
      }
    }
  }
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(H)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;I shouldn&amp;rsquo;t normally use the package, but since it&amp;rsquo;s an exercise today I&amp;rsquo;m only going to pursue the results of the estimates, and I&amp;rsquo;ll be writing a post about GARCH in the next week or so.
Now we&amp;rsquo;re ready to go. We can now put the return data into this function to calculate the variance-covariance matrix and use it to calculate the minimum variance portfolio.&lt;/p&gt;
&lt;h2 id=&#34;3-collection-of-data-for-testing&#34;&gt;3. Collection of data for testing&lt;/h2&gt;
&lt;p&gt;The data was based on the following article.&lt;/p&gt;
&lt;p&gt;(Introduction to Asset Allocation)[https://www.r-bloggers.com/introduction-to-asset-allocation/]&lt;/p&gt;
&lt;p&gt;We used NAV data for an ETF (iShares) that is linked to the following index&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;S&amp;amp;P500&lt;/li&gt;
&lt;li&gt;NASDAQ100&lt;/li&gt;
&lt;li&gt;MSCI Emerging Markets&lt;/li&gt;
&lt;li&gt;Russell 2000&lt;/li&gt;
&lt;li&gt;MSCI EAFE&lt;/li&gt;
&lt;li&gt;US 20 Year Treasury(the Barclays Capital 20+ Year Treasury Index)&lt;/li&gt;
&lt;li&gt;U.S. Real Estate(the Dow Jones US Real Estate Index)&lt;/li&gt;
&lt;li&gt;gold bullion market&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The first step is to collect data.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(quantmod)

&lt;span style=&#34;color:#75715e&#34;&gt;#**************************&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# ★8 ASSETS SIMULATION&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# SPY - S&amp;amp;P 500 &lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# QQQ - Nasdaq 100&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# EEM - Emerging Markets&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# IWM - Russell 2000&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# EFA - EAFE&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# TLT - 20 Year Treasury&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# IYR - U.S. Real Estate&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;# GLD - Gold&lt;/span&gt;
&lt;span style=&#34;color:#75715e&#34;&gt;#**************************&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# load historical prices from Yahoo Finance&lt;/span&gt;
symbol.names &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;S&amp;amp;P 500&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Nasdaq 100&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Emerging Markets&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Russell 2000&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;EAFE&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;20 Year Treasury&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;U.S. Real Estate&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Gold&amp;#34;&lt;/span&gt;)
symbols &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;SPY&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;QQQ&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;EEM&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;IWM&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;EFA&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;TLT&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;IYR&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GLD&amp;#34;&lt;/span&gt;)
&lt;span style=&#34;color:#a6e22e&#34;&gt;getSymbols&lt;/span&gt;(symbols, from &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;1980-01-01&amp;#39;&lt;/span&gt;, auto.assign &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;TRUE&lt;/span&gt;)

&lt;span style=&#34;color:#75715e&#34;&gt;#gn dates for all symbols &amp;amp; convert to monthly&lt;/span&gt;
hist.prices &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(SPY,QQQ,EEM,IWM,EFA,TLT,IYR,GLD)
month.ends &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;endpoints&lt;/span&gt;(hist.prices, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;day&amp;#39;&lt;/span&gt;)
hist.prices &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Cl&lt;/span&gt;(hist.prices)[month.ends, ]
&lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(hist.prices) &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; symbols

&lt;span style=&#34;color:#75715e&#34;&gt;# remove any missing data&lt;/span&gt;
hist.prices &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;(hist.prices[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;1995::&amp;#39;&lt;/span&gt;])

&lt;span style=&#34;color:#75715e&#34;&gt;# compute simple returns&lt;/span&gt;
hist.returns &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;na.omit&lt;/span&gt;( &lt;span style=&#34;color:#a6e22e&#34;&gt;ROC&lt;/span&gt;(hist.prices, type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;discrete&amp;#39;&lt;/span&gt;) )

&lt;span style=&#34;color:#75715e&#34;&gt;# compute historical returns, risk, and correlation&lt;/span&gt;
ia &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;()
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;expected.return &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(hist.returns, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, mean, na.rm &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; T)
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;risk &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(hist.returns, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, sd, na.rm &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; T)
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;correlation &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;cor&lt;/span&gt;(hist.returns, use &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;complete.obs&amp;#39;&lt;/span&gt;, method &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;pearson&amp;#39;&lt;/span&gt;)

ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;symbols &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; symbols
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;symbol.names &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; symbol.names
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;n &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(symbols)
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;hist.returns &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; hist.returns

&lt;span style=&#34;color:#75715e&#34;&gt;# convert to annual, year = 12 months&lt;/span&gt;
annual.factor &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;12&lt;/span&gt;
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;expected.return &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; annual.factor &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;expected.return
ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;risk &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(annual.factor) &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; ia&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;risk

&lt;span style=&#34;color:#a6e22e&#34;&gt;rm&lt;/span&gt;(SPY,QQQ,EEM,IWM,EFA,TLT,IYR,GLD)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here&amp;rsquo;s how the returns are plotted.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;PerformanceAnalytics&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;charts.PerformanceSummary&lt;/span&gt;(hist.returns, main &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Performance summary&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post2/index_files/figure-html/unnamed-chunk-6-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Next, we&amp;rsquo;ll code the backtest. We&amp;rsquo;ll publish the code all at once.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# BACK TEST&lt;/span&gt;
backtest &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(r_dat,FLG,start_date,span,learning_term,port){
  &lt;span style=&#34;color:#75715e&#34;&gt;#-----------------------------------------&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# BACKTEST&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# r_dat - return data(xts object) &lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# FLG - flag(CCC,DCC,DECO)&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# start_date - start date for backtest&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# span - rebalance frequency&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# learning_term - learning term (days)&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;# port - method of portfolio optimization&lt;/span&gt;
  &lt;span style=&#34;color:#75715e&#34;&gt;#-----------------------------------------&lt;/span&gt;
  
  &lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(stringi)

  initial_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; r_dat&lt;span style=&#34;color:#a6e22e&#34;&gt;[stri_c&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(start_date)&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;learning_term,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;::&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;as.Date&lt;/span&gt;(start_date))]
  &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(i in &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(initial_dat)&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(r_dat)) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(i &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(initial_dat)){
      H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;carroll&lt;/span&gt;(initial_dat[1&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(initial_dat)&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;),],FLG)
      &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(port &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nlgmv&amp;#34;&lt;/span&gt;){
        result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;nlgmv&lt;/span&gt;(initial_dat,H)
      }else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(port &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;){
        result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;risk_parity&lt;/span&gt;(initial_dat,H)
      }
      weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)
      &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(weight) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(initial_dat)
      p_return &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; initial_dat&lt;span style=&#34;color:#a6e22e&#34;&gt;[NROW&lt;/span&gt;(initial_dat),]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight
    } else {
      &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(i &lt;span style=&#34;color:#f92672&#34;&gt;%in%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;endpoints&lt;/span&gt;(r_dat,span)){
        H &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;carroll&lt;/span&gt;(test_dat[1&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(test_dat)&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;),],FLG)
        &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(port &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;nlgmv&amp;#34;&lt;/span&gt;){
          result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;nlgmv&lt;/span&gt;(test_dat,H)
        }else &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(port &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;){
          result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;risk_parity&lt;/span&gt;(test_dat,H)
        }
        
      }
      weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(weight,&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight))
      p_return &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(p_return,test_dat&lt;span style=&#34;color:#a6e22e&#34;&gt;[NROW&lt;/span&gt;(test_dat),]&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;result&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)
    }
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(i &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(r_dat)){
      term &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;stri_c&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(r_dat[i&lt;span style=&#34;color:#ae81ff&#34;&gt;+1&lt;/span&gt;,])&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;learning_term,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;::&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(r_dat[i&lt;span style=&#34;color:#ae81ff&#34;&gt;+1&lt;/span&gt;,])) 
      test_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; r_dat[term]
    }
  }
  p_return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;xts&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(p_return,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,sum),order.by &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(p_return))
  weight.xts &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;xts&lt;/span&gt;(weight,order.by &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(p_return))

  result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(p_return,weight.xts)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;names&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;return&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;weight&amp;#34;&lt;/span&gt;)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(result)
}

CCC &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
DCC &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
DECO &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
benchmark &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)

result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio)
&lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here&amp;rsquo;s a graph of the calculation results.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;PerformanceAnalytics&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;charts.PerformanceSummary&lt;/span&gt;(result,main &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;BACKTEST&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post2/index_files/figure-html/unnamed-chunk-9-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;I did not use the minimum variance portfolio defined above because I imposed a short sale constraint. Apparently it&amp;rsquo;s difficult to solve analytically with this alone, so I&amp;rsquo;m going to solve numerically. I used a weekly rebalancing period, so it took me a while to calculate the results on my own PC, but I was able to calculate the results.&lt;/p&gt;
&lt;p&gt;Since Lehman, it appears to have outperformed the benchmark equal weighted portfolio. In particular, DECO is looking good. I would like to rethink the meaning of Equicorrelation. The change in each incorporation ratio is as follows.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# plot allocation weighting&lt;/span&gt;
d_allocation &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(ggweight,title){
  &lt;span style=&#34;color:#75715e&#34;&gt;#install.packages(&amp;#34;tidyverse&amp;#34;)&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(tidyverse)
  ggweight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;gather&lt;/span&gt;(ggweight,key&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ASSET,value&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;weight,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;Date,&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;method)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(ggweight, &lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Date, y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;weight,fill&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ASSET)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_area&lt;/span&gt;(colour&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;black&amp;#34;&lt;/span&gt;,size&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;.1&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;scale_y_continuous&lt;/span&gt;(limits &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;labs&lt;/span&gt;(title&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;title) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;facet_grid&lt;/span&gt;(method&lt;span style=&#34;color:#f92672&#34;&gt;~&lt;/span&gt;.)
}

gmv_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)))

&lt;span style=&#34;color:#75715e&#34;&gt;# plot allocation weighting&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;d_allocation&lt;/span&gt;(gmv_weight,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;GMV Asset Allocation&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post2/index_files/figure-html/unnamed-chunk-11-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;They seem to have increased their allocation to TLT, or U.S. Treasuries, during Lehman, while CCC and DCC have a high allocation to U.S. Treasuries in other areas as well, and the often-cited problem of a minimally diversified portfolio seems to be occurring here as well. On the other hand, DECO has a unique mix ratio, and I think we need to go back and read the paper again.&lt;/p&gt;
&lt;p&gt;PS（2019/3/3）
So far, I&amp;rsquo;ve been doing the analysis with a minimum variance portfolio, but I also wanted to see the results of risk parity, so I wrote the code for that as well.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;risk_parity &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(r_dat,r_cov){
  fn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(weight, r_cov) {
    N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(r_cov)
    risks &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt;  weight &lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt; (r_cov &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; weight)
    g &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(risks, times &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; N) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(risks, each &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; N)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(g^2))
  }
  dfn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(weight,r_cov){
    out &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; weight
    &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(i in &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(weight)) {
      up &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dn &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; weight
      up[i] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; up[i]&lt;span style=&#34;color:#ae81ff&#34;&gt;+.0001&lt;/span&gt;
      dn[i] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; dn[i]&lt;span style=&#34;color:#ae81ff&#34;&gt;-.0001&lt;/span&gt;
      out[i] &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;fn&lt;/span&gt;(up,r_cov) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;fn&lt;/span&gt;(dn,r_cov))&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;.0002&lt;/span&gt;
    }
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(out)
  }
  std &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(r_cov)) 
  x0 &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;std&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;std)
  res &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; nloptr&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;nloptr&lt;/span&gt;(x0&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;x0,
                 eval_f&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;fn,
                 eval_grad_f&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;dfn,
                 eval_g_eq&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(weight,r_cov) { &lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(weight) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; },
                 eval_jac_g_eq&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(weight,r_cov) { &lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(std)) },
                 lb&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(std)),ub&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(std)),
                 opts &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;algorithm&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;NLOPT_LD_SLSQP&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;print_level&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;xtol_rel&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1.0e-8&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;maxeval&amp;#34;&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;),
                 r_cov &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; r_cov)
  r_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; res&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;solution
  &lt;span style=&#34;color:#a6e22e&#34;&gt;names&lt;/span&gt;(r_weight) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(r_cov)
  wr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; r_dat&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;r_weight
  portfolio &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;apply&lt;/span&gt;(wr_dat,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,sum)
  pr_dat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(wr_dat,portfolio)
  sd &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;sd&lt;/span&gt;(portfolio)
  result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;list&lt;/span&gt;(r_weight,pr_dat,sd)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;names&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;weight&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;return&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;portfolio risk&amp;#34;&lt;/span&gt;)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(result)
  }

CCC &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
DCC &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
DECO &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)
benchmark &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;backtest&lt;/span&gt;(hist.returns,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;2007-01-04&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;months&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;365&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;risk parity&amp;#34;&lt;/span&gt;)

result &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;merge&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio,benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;return&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;portfolio)
&lt;span style=&#34;color:#a6e22e&#34;&gt;colnames&lt;/span&gt;(result) &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Here&amp;rsquo;s the result.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;PerformanceAnalytics&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;charts.PerformanceSummary&lt;/span&gt;(result, main &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;BACKTEST COMPARISON&amp;#34;&lt;/span&gt;)

&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(plotly)

&lt;span style=&#34;color:#75715e&#34;&gt;# plot allocation weighting&lt;/span&gt;
riskparity_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;PerformanceAnalytics&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;charts.PerformanceSummary&lt;/span&gt;(result, main &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;BACKTEST COMPARISON&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post2/index_files/figure-html/unnamed-chunk-15-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;riskparity_weight &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;rbind&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;CCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(CCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DCC&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DCC&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;DECO&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(DECO&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)),&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight,method&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;benchmark&amp;#34;&lt;/span&gt;,Date&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;index&lt;/span&gt;(benchmark&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;weight)))

&lt;span style=&#34;color:#75715e&#34;&gt;# plot allocation weighting&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;d_allocation&lt;/span&gt;(riskparity_weight, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Risk Parity Asset Allocation&amp;#34;&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;../../../en/post/post2/index_files/figure-html/unnamed-chunk-15-2.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The results are positive, with all methods outperforming benchmark.
As expected, the estimation of the variance-covariance matrix seems to be performing well. The good performance of DECO may also be due to the fact that it uses the average of the correlation coefficients of each asset pair in the correlation matrix, which resulted in a greater inclusion of risk assets than the other methods. The weights are as follows&lt;/p&gt;
&lt;p&gt;That&amp;rsquo;s it for today, for now.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Implementing Gaussian regression.</title>
      <link>/en/post/post1/</link>
      <pubDate>Sun, 02 Dec 2018 00:00:00 +0000</pubDate>
      <guid>/en/post/post1/</guid>
      <description>&lt;p&gt;　Hi. Yesterday, I wrote an article about &lt;code&gt;Bayesian Vector Autoregression&lt;/code&gt;.
　In the article, the topic of hyperparameter tuning came up, and looking for some efficient way to tune it, I found &lt;code&gt;Bayesian Optimization&lt;/code&gt;. Since I am planning to use machine learning methods in daily GDP, I thought that &lt;code&gt;Bayesian Optimization&lt;/code&gt; could be quite useful, and I spent all night yesterday to understand it.&lt;br&gt;
　I will implement it here, but &lt;code&gt;Bayesian Optimization&lt;/code&gt; uses &lt;code&gt;Gaussian Pocess Regression&lt;/code&gt; (&lt;code&gt;GPR&lt;/code&gt;), and my motivation for writing this entry was to implement it first. I will write about the implementation of &lt;code&gt;Bayesian Optimization&lt;/code&gt; after this entry.&lt;/p&gt;
&lt;h2 id=&#34;1-what-is-gpr&#34;&gt;1. What is &lt;code&gt;GPR&lt;/code&gt;?&lt;/h2&gt;
&lt;p&gt;　The &lt;code&gt;GRP&lt;/code&gt; is, simply put, &lt;strong&gt;a type of nonlinear regression method using Bayesian estimation&lt;/strong&gt;. Although the model itself is linear, it is characterized by its ability to estimate &lt;strong&gt;infinite nonlinear transformations of input variables using a kernel trick&lt;/strong&gt; as explanatory variables (depending on what you choose for the kernel).
　The &lt;code&gt;GPR&lt;/code&gt; assumes that &lt;code&gt;\(N\)&lt;/code&gt; input and teacher data are available for training, and the &lt;code&gt;\(N+1\)&lt;/code&gt; of input data are also available. From this situation, we can predict the &lt;code&gt;\(N+1\)&lt;/code&gt;th teacher data.&lt;br&gt;
　The data contains noise and follows the following probability model.
　
$$
t_{i} = y_{i} + \epsilon_{i}
$$
where &lt;code&gt;\(t_{i}\)&lt;/code&gt; is the &lt;code&gt;\(i\)&lt;/code&gt;th observable teacher data (scalar), &lt;code&gt;\(y_{i}\)&lt;/code&gt; is the unobservable output data (scalar), and &lt;code&gt;\(\beta_{i}\)&lt;/code&gt; follows a normal distribution &lt;code&gt;\(N(0, \beta^{-1})\)&lt;/code&gt; with measurement error. &lt;code&gt;\(y_{i}\)&lt;/code&gt; follows the following probability model.&lt;/p&gt;
&lt;p&gt;$$
\displaystyle y_{i}  = \textbf{w}^{T}\phi(x_{i})
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(x_{i}\)&lt;/code&gt; is the ith input data vector, &lt;code&gt;\(\phi(・)\)&lt;/code&gt; is the non-linear function and &lt;code&gt;\(\bf{w}^{T}\)&lt;/code&gt; is the weight coefficient (regression coefficient) vector for each input data. As a nonlinear function, I assume &lt;code&gt;\(\psi(x_{i}) = (x_{1,i}, x_{1,i}^{2},... ,x_{1,i}x_{2,i},...)\)&lt;/code&gt;. ($x_{1,i}$ is the first variable in the &lt;code&gt;\(i\)&lt;/code&gt;th input data &lt;code&gt;\(x_{i}\)&lt;/code&gt;). The conditional probability of obtaining &lt;code&gt;\(t_{i}\)&lt;/code&gt; from the probabilistic model of the teacher data, with the &lt;code&gt;\(i\)&lt;/code&gt;th output data &lt;code&gt;\(y_{i}\)&lt;/code&gt; obtained, is&lt;/p&gt;
&lt;p&gt;$$
p(t_{i}|y_{i}) = N(t_{i}|y_{i},\beta^{-1})
$$&lt;/p&gt;
&lt;p&gt;&lt;code&gt;\(\displaystyle \textbf{t} = (t_{1},... ,t_{n})^{T}\)&lt;/code&gt; and &lt;code&gt;\(\displaystyle \textbf{y} = (y_{1},... ,y_{n})^{T}\)&lt;/code&gt;, then by extending the above equation, we have&lt;/p&gt;
&lt;p&gt;$$
\displaystyle p(\textbf{t}|\textbf{y}) = N(\textbf{t}|\textbf{y},\beta^{-1}\textbf{I}_{N})
$$&lt;/p&gt;
&lt;p&gt;We assume that the expected value of &lt;code&gt;\(\textbf{w}\)&lt;/code&gt; as a prior distribution is 0, and all variances are  &lt;code&gt;\(\alpha\)&lt;/code&gt;. We also assume that &lt;code&gt;\(\displaystyle \textbf{y}\)&lt;/code&gt; follows a Gaussian process. A Gaussian process is one where the simultaneous distribution of &lt;code&gt;\(\displaystyle \textbf{y}\)&lt;/code&gt; follows a multivariate Gaussian distribution. In code, it looks like this&lt;/p&gt;
&lt;p&gt;\normalsize&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# Define Kernel function&lt;/span&gt;
Kernel_Mat &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(X,sigma,beta){
  N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(X)
  K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,N,N)
  &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(i in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N) {
    &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(k in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;N) {
      &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt;(i&lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt;k) kdelta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt; else kdelta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
      K[i,k] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K[k,i] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(X[i,]&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;X[k,])&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;(X[i,]&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;X[k,])&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;sigma^2)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; beta^{&lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;}&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;kdelta
    }
  }
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(K)
}

N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# max value of X&lt;/span&gt;
M &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# sample size&lt;/span&gt;
X &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;seq&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,N,length&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;M),M,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;# create X&lt;/span&gt;
testK &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;Kernel_Mat&lt;/span&gt;(X,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.5&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1e+18&lt;/span&gt;) &lt;span style=&#34;color:#75715e&#34;&gt;# calc kernel matrix&lt;/span&gt;

&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(MASS)

P &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;6&lt;/span&gt; &lt;span style=&#34;color:#75715e&#34;&gt;# num of sample path&lt;/span&gt;
Y &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;matrix&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,M,P) &lt;span style=&#34;color:#75715e&#34;&gt;# define Y&lt;/span&gt;

&lt;span style=&#34;color:#a6e22e&#34;&gt;for&lt;/span&gt;(i in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;P){
  Y[,i] &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;mvrnorm&lt;/span&gt;(n&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,&lt;span style=&#34;color:#a6e22e&#34;&gt;rep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,M),testK) &lt;span style=&#34;color:#75715e&#34;&gt;# sample Y&lt;/span&gt;
}

&lt;span style=&#34;color:#75715e&#34;&gt;# Plot&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;matplot&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;X,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;Y,type &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;l&amp;#34;&lt;/span&gt;,lwd &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;\normalsize&lt;img src=&#34;../../../en/post/post1/index_files/figure-html/unnamed-chunk-1-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;　The covariance matrix &lt;code&gt;\(K\)&lt;/code&gt; between the elements of &lt;code&gt;\(\displaystyle \textbf{y}\)&lt;/code&gt;, &lt;code&gt;\(\displaystyle y_{i}  = \textbf{w}^{T}\phi(x_{i})\)&lt;/code&gt; is calculated using the kernel method from the input &lt;code&gt;\(x\)&lt;/code&gt;. Then, from this &lt;code&gt;\(K\)&lt;/code&gt; and average 0, we generate six series of multivariate normal random numbers and plot them.As these series are computed from a covariance matrix, we model that &lt;strong&gt;the more positive the covariance of each element, the more likely they are to be the same&lt;/strong&gt;. Also, as you can see in the graphs, the graphs are very smooth and very flexible in their representation. The code samples and plots 1000 input points, limiting the input to 0 to 10 due to computational cost, but in principle, &lt;code&gt;\(x\)&lt;/code&gt; is defined in the real number space, so &lt;code&gt;\(p(\textbf{y})\)&lt;/code&gt; follows an infinite dimensional multivariate normal distribution.&lt;/p&gt;
&lt;p&gt;As described above, since &lt;code&gt;\(\displaystyle \textbf{y}\)&lt;/code&gt; is assumed to follow a Gaussian process, &lt;code&gt;\(p(\textbf{y})\)&lt;/code&gt; follows a multivariate normal distribution &lt;code&gt;\(N(\textbf{y}|0,K)\)&lt;/code&gt; with simultaneous probability &lt;code&gt;\(p(\textbf{y})\)&lt;/code&gt; averaging 0 and the variance covariance matrix &lt;code&gt;\(K\)&lt;/code&gt;. Each element &lt;code&gt;\(K_{i,j}\)&lt;/code&gt; of &lt;code&gt;\(K\)&lt;/code&gt; is&lt;/p&gt;
&lt;p&gt;$$
&lt;code&gt;\begin{eqnarray} K_{i,j} &amp;amp;=&amp;amp; cov[y_{i},y_{j}] = cov[\textbf{w}\phi(x_{i}),\textbf{w}\phi(x_{j})] \\ &amp;amp;=&amp;amp;\phi(x_{i})\phi(x_{j})cov[\textbf{w},\textbf{w}]=\phi(x_{i})\phi(x_{j})\alpha \end{eqnarray}&lt;/code&gt;
$$&lt;/p&gt;
&lt;p&gt;Here, the &lt;code&gt;\(\phi(x_{i})\phi(x_{j})\alpha\)&lt;/code&gt; is more expensive &lt;strong&gt;as the dimensionality of the &lt;code&gt;\(\phi(x_{i})\)&lt;/code&gt; is increased&lt;/strong&gt; (i.e., the more non-linear transformation is applied, the less the calculation is completed). However, when the kernel function &lt;code&gt;\(k(x,x&#39;)\)&lt;/code&gt; is used, the computational complexity is higher in the dimensions of the sample size of the input data &lt;code&gt;\(x_{i},x_{j}\)&lt;/code&gt;, so the computation becomes easier. There are several types of kernel functions, but the following Gaussian kernels are commonly used.&lt;/p&gt;
&lt;p&gt;$$
k(x,x&#39;) = a \exp(-b(x-x&#39;)^{2})
$$&lt;/p&gt;
&lt;p&gt;Now that we have defined the concurrent probability of &lt;code&gt;\(\displaystyle \textbf{y}\)&lt;/code&gt;, we can find the joint probability of &lt;code&gt;\(\displaystyle \textbf{t}\)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;$$
&lt;code&gt;\begin{eqnarray} \displaystyle p(\textbf{t}) &amp;amp;=&amp;amp; \int p(\textbf{t}|\textbf{y})p(\textbf{y}) d\textbf{y} \\ \displaystyle &amp;amp;=&amp;amp; \int N(\textbf{t}|\textbf{y},\beta^{-1}\textbf{I}_{N})N(\textbf{y}|0,K)d\textbf{y} \\ &amp;amp;=&amp;amp; N(\textbf{y}|0,\textbf{C}_{N}) \end{eqnarray}&lt;/code&gt;
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\textbf{C}_{N} = K + \beta^{-1}\beta^{I}_{N}\)&lt;/code&gt;. Note that the last expression expansion uses the regenerative nature of the normal distribution (the proof can be easily derived from the moment generating function of the normal distribution). The point is just to say that the covariance is the sum of the covariances of the two distributions, since they are independent. Personally, I imagine that &lt;code&gt;\(p(\textbf{y})\)&lt;/code&gt; is the prior distribution of the Gaussian process I just described, &lt;code&gt;\(p(\textbf{t}|\textbf{y})\)&lt;/code&gt; is the likelihood function, and &lt;code&gt;\(p(\textbf{t})\)&lt;/code&gt; is the posterior distribution. The only constraint on the prior distribution &lt;code&gt;\(p(\textbf{y})\)&lt;/code&gt; is that it is smooth with a loosely constrained distribution.
The joint probability of &lt;code&gt;\(N\)&lt;/code&gt; observable teacher data &lt;code&gt;\(\textbf{t}\)&lt;/code&gt; and &lt;code&gt;\(t_{N+1}\)&lt;/code&gt; is&lt;/p&gt;
&lt;p&gt;$$
p(\textbf{t},t_{N+1}) = N(\textbf{t},t_{N+1}|0,\textbf{C}_{N+1})
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\textbf{C}_{N+1}\)&lt;/code&gt; is&lt;/p&gt;
&lt;p&gt;$$
\textbf{C}&lt;em&gt;{N+1} = \left(
\begin{array}{cccc}
\textbf{C}&lt;/em&gt;{N} &amp;amp; \textbf{k} \&lt;br&gt;
\textbf{k}^{T} &amp;amp; c \&lt;br&gt;
\end{array}
\right)
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(\textbf{k} = (k(x_{1},x_{N+1}),...,k(x_{N},x_{N+1}))\)&lt;/code&gt; and &lt;code&gt;\(c = k(x_{N+1},x_{N+1})\)&lt;/code&gt;. The conditional distribution &lt;code&gt;\(p(t_{N+1}|\textbf{t})\)&lt;/code&gt; can be obtained from the joint distribution of &lt;code&gt;\(\textbf{t}\)&lt;/code&gt; and &lt;code&gt;\(t_{N+1}\)&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;$$
p(t_{N+1}|\textbf{t}) = N(t_{N+1}|\textbf{k}^{T}\textbf{C}_{N+1}^{-1}\textbf{t},c-\textbf{k}^{T}\textbf{C}_{N+1}^{-1}\textbf{k})
$$&lt;/p&gt;
&lt;p&gt;In calculating the conditional distribution, we use &lt;a href=&#34;https://qiita.com/kilometer/items/34249479dc2ac3af5706&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Properties of the conditional multivariate normal distribution&lt;/a&gt;. As you can see from the above equation, the conditional distribution &lt;code&gt;\(p(t_{N+1}|\textbf{t})\)&lt;/code&gt; can be calculated if &lt;code&gt;\(N+1\)&lt;/code&gt; input data, &lt;code&gt;\(N\)&lt;/code&gt; teacher data, and parameters &lt;code&gt;\(a,b\)&lt;/code&gt; of the kernel function are known, so if any point is given as input data, it is possible to approximate the Generating Process. The nice thing about the &lt;code&gt;GPR&lt;/code&gt; is that it gives predictions without the direct estimation of the above defined probabilistic model &lt;code&gt;\(\displaystyle y_{i}  = \textbf{w}^{T}\phi(x_{i})\)&lt;/code&gt;. The stochastic model has &lt;code&gt;\(\phi(x_{i})\)&lt;/code&gt;, which converts the input data to a high-dimensional vector through a nonlinear transformation. Therefore, the higher the dimensionality, the larger the computational complexity of the &lt;code&gt;\(\phi(x_{i})\phi(x_{j})\alpha\)&lt;/code&gt; will be, but the &lt;code&gt;GPR&lt;/code&gt; uses a kernel trick, so the computational complexity of the sample size dimension of the input data vector will be sufficient.&lt;/p&gt;
&lt;h2 id=&#34;2-implementation-of-the-gpr&#34;&gt;2. Implementation of the `GPR&#39;&lt;/h2&gt;
&lt;p&gt;　For now, let&amp;rsquo;s implement this in &lt;code&gt;R&lt;/code&gt;, which I&amp;rsquo;ve implemented in PRML test data, so I tweaked it.
　
\normalsize&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(ggplot2)
&lt;span style=&#34;color:#a6e22e&#34;&gt;library&lt;/span&gt;(grid)

&lt;span style=&#34;color:#75715e&#34;&gt;# 1.Gaussian Process Regression&lt;/span&gt;

&lt;span style=&#34;color:#75715e&#34;&gt;# PRML&amp;#39;s synthetic data set&lt;/span&gt;
curve_fitting &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(
  x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.000000&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.111111&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.222222&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.333333&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.444444&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.555556&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.666667&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.777778&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.888889&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1.000000&lt;/span&gt;),
  t&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;c&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0.349486&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.830839&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1.007332&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.971507&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.133066&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.166823&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.848307&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.445686&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.563567&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.261502&lt;/span&gt;))

f &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(beta, sigma, xmin, xmax, input, train) {
  kernel &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1, x2) &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;sigma^2)); &lt;span style=&#34;color:#75715e&#34;&gt;# define Kernel function&lt;/span&gt;
  K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, kernel); &lt;span style=&#34;color:#75715e&#34;&gt;# calc gram matrix&lt;/span&gt;
  C_N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(input))&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;beta
  m &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x) (&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; train) &lt;span style=&#34;color:#75715e&#34;&gt;# coditiona mean &lt;/span&gt;
  m_sig &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x)(&lt;span style=&#34;color:#a6e22e&#34;&gt;kernel&lt;/span&gt;(x,x) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel)))) &lt;span style=&#34;color:#75715e&#34;&gt;#conditional variance&lt;/span&gt;
  x &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;seq&lt;/span&gt;(xmin,xmax,length&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)
  output &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;x,m&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x),sig1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x)&lt;span style=&#34;color:#ae81ff&#34;&gt;+1.96&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;m_sig&lt;/span&gt;(x)),sig2&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x)&lt;span style=&#34;color:#ae81ff&#34;&gt;-1.96&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;m_sig&lt;/span&gt;(x)),
                              tx&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;input,ty&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;train),
                   &lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;x1,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;m)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_ribbon&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(ymin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;sig1,ymax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;sig2),alpha&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_point&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;tx,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ty))
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(output)
}

&lt;span style=&#34;color:#a6e22e&#34;&gt;grid.newpage&lt;/span&gt;() &lt;span style=&#34;color:#75715e&#34;&gt;# make a palet&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;pushViewport&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;grid.layout&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))) &lt;span style=&#34;color:#75715e&#34;&gt;# divide the palet into 2 by 2&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.10&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.30&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.030&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)) 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;\normalsize&lt;img src=&#34;../../../en/post/post1/index_files/figure-html/unnamed-chunk-2-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;\(beta^{-1}\)&lt;/code&gt; represents the measurement error. The higher the value of &lt;strong&gt;$\beta$ (i.e., the smaller the measurement error), the easier it is to overfit, since the error of the predictions is less than that of the data already available.&lt;/strong&gt; This is the case in the top left corner of the figure above. The top left corner is &lt;code&gt;\(\beta=400\)&lt;/code&gt;, which means that it overfits the current data available. Conversely, a small value of &lt;code&gt;\(\beta\)&lt;/code&gt; will produce predictions that ignore the errors with the teacher data, but may improve the generalization performance. The top right figure shows this. For &lt;code&gt;\(beta=4\)&lt;/code&gt;, the average barely passes through the data points we have, and &lt;code&gt;\(b\)&lt;/code&gt; is currently available. &lt;code&gt;\(b\)&lt;/code&gt; represents the magnitude of the effect of the data we have at the moment on the surroundings. If &lt;code&gt;\(b\)&lt;/code&gt; is small, the adjacent points will interact strongly with each other, which may reduce the accuracy but increase the generalization performance. Conversely, if &lt;code&gt;\(b\)&lt;/code&gt; is large, the result will be unnatural, fitting only individual points. This is illustrated in the figure below right ($b=\frac{1}{0.03}, \beta=25$). As you can see, the graph is overfitting because of the large &lt;code&gt;\(\beta\)&lt;/code&gt; and because &lt;code&gt;\(b\)&lt;/code&gt; is also large, so it fits only individual points, resulting in an absurdly large graph. The bottom left graph is the best. It has &lt;code&gt;\(b=\frac{1}{0.3}\)&lt;/code&gt;, and &lt;code&gt;\(b=2\)&lt;/code&gt;. Let&amp;rsquo;s try extending the x interval of this graph to [0,2]. Then we get the following graph.&lt;/p&gt;
&lt;p&gt;\normalsize&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;grid.newpage&lt;/span&gt;() &lt;span style=&#34;color:#75715e&#34;&gt;# make a palet&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;pushViewport&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;grid.layout&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, &lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;))) &lt;span style=&#34;color:#75715e&#34;&gt;# divide the palet into 2 by 2&lt;/span&gt;
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.1&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;)) 
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;4&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.10&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)) 
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.30&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;f&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;25&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0.030&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;)) 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;\normalsize&lt;img src=&#34;../../../en/post/post1/index_files/figure-html/unnamed-chunk-3-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;As you can see, all the graphs except the bottom left one have a band of 95% confidence intervals that immediately widen and are completely useless where there are no data points. On the other hand, the lower left graph has a decent band up to 1.3 to 1.4, and the average value seems to pass through a point that is consistent with our intuitive understanding of the function. You can also see that if you are too far away from the observable data points, you will get a normal distribution with a mean of 0 and a variance of 1 no matter what you give to the parameters.
Now that we have shown that the accuracy of the prediction of the out-sample varies depending on the value of the parameters, the question here is how to estimate these hyperparameters. This is done by using the gradient method to find the hyperparameters that maximize the log-likelihood function &lt;code&gt;\(\ln p(\bf{t}|a,b)\)&lt;/code&gt; (($\beta$ seems to be of a slightly different type, and the developmental discussion appears to take other tuning methods. We haven&amp;rsquo;t gotten to that level yet, so we&amp;rsquo;ll calibrate it here).  Since &lt;code&gt;\(p(\textbf{t}) = N(\textbf{y}|0, \textbf{C}_{N})\)&lt;/code&gt;, the log-likelihood function is&lt;/p&gt;
&lt;p&gt;$$
\displaystyle \ln p(\textbf{t}|a,b,\beta) = -\frac{1}{2}\ln|\textbf{C}&lt;em&gt;{N}| - \frac{N}{2}\ln(2\pi) - \frac{1}{2}\textbf{t}^{T}\textbf{C}&lt;/em&gt;{N}^{-1}\textbf{k}
$$&lt;/p&gt;
&lt;p&gt;After that, we can differentiate this with the parameters and solve the obtained simultaneous equations to get the maximum likelihood estimator. Now let&amp;rsquo;s get the derivatives.&lt;/p&gt;
&lt;p&gt;$$
\displaystyle \frac{\partial}{\partial \theta_{i}} \ln p(\textbf{t}|\theta) = -\frac{1}{2}Tr(\textbf{C}_{N}^{-1}\frac{\partial \textbf{C}_{N}}{\partial \theta_{i}}) + \frac{1}{2}\textbf{t}^{T}\textbf{C}_{N}^{-1}
\frac{\partial\textbf{C}_{N}}{\partial\theta_{i}}\textbf{C}_{N}^{-1}\textbf{t}
$$&lt;/p&gt;
&lt;p&gt;where &lt;code&gt;\(theta\)&lt;/code&gt; is the parameter set and &lt;code&gt;\(theta_{i}\)&lt;/code&gt; represents the &lt;code&gt;\(i\)&lt;/code&gt;th parameter. If you don&amp;rsquo;t understand this derivative [here](&lt;a href=&#34;http://users.isr.ist.utl.pt/~wurmd/Livros/school/Bishop%20-%20Pattern%20Recognition%20And%20Machine%20Learning&#34;&gt;http://users.isr.ist.utl.pt/~wurmd/Livros/school/Bishop%20-%20Pattern%20Recognition%20And%20Machine%20Learning&lt;/a&gt; %20-%20Springer%20Springer%20%202006.pdf) in the supplement to (C.21) and (C.22) equations. Since we are using the Gaussian kernel in this case, we get&lt;/p&gt;
&lt;p&gt;$$
\displaystyle \frac{\partial k(x,x&#39;)}{\partial a} = \exp(-b(x-x&#39;)^{2}) \&lt;br&gt;
\displaystyle \frac{\partial k(x,x&#39;)}{\partial b} = -a(x-x&#39;)^{2}\exp(-b(x-x&#39;)^{2})
$$&lt;/p&gt;
&lt;p&gt;from the above formula. However, this time we will use the gradient method to find the best parameters. Here&amp;rsquo;s the code for the implementation (it&amp;rsquo;s pretty much a lost cause).&lt;/p&gt;
&lt;p&gt;\normalsize&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-r&#34; data-lang=&#34;r&#34;&gt;g &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(xmin, xmax, input, train){
  &lt;span style=&#34;color:#75715e&#34;&gt;# initial value&lt;/span&gt;
  beta &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;
  b &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  a &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;
  learning_rate &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0.1&lt;/span&gt;
  itermax &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
  &lt;span style=&#34;color:#a6e22e&#34;&gt;if &lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;(input) &lt;span style=&#34;color:#f92672&#34;&gt;==&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;numeric&amp;#34;&lt;/span&gt;){
    N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(input)
  } else
  {
    N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NROW&lt;/span&gt;(input)
  }
  kernel &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1, x2) a&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2); &lt;span style=&#34;color:#75715e&#34;&gt;# define kernel&lt;/span&gt;
  derivative_a &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1,x2) &lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2)
  derivative_b &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1,x2) &lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2)
  dloglik_a &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(C_N,y,x1,x2) {
    &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_a)))&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(y)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_a)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;y 
  }
  dloglik_b &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(C_N,y,x1,x2) {
    &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_b)))&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(y)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_b)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;y 
  }
  &lt;span style=&#34;color:#75715e&#34;&gt;# loglikelihood function&lt;/span&gt;
  likelihood &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(b,a,x,y){
    kernel &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1, x2) a&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2)
    K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, x, kernel)
    C_N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(N)&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;beta
    itermax &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1000&lt;/span&gt;
    l &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;-1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;det&lt;/span&gt;(C_N)) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; N&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;pi&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(y)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;y
    &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(l)
  }
  K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, kernel) 
  C_N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(N)&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;beta
  &lt;span style=&#34;color:#a6e22e&#34;&gt;for &lt;/span&gt;(i in &lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt;itermax){
    kernel &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1, x2) a&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2)
    derivative_b &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x1,x2) &lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;a&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;exp&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;-0.5&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;b&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;x2)^2)
    dloglik_b &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(C_N,y,x1,x2) {
      &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sum&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_b)))&lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(y)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, derivative_b)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N)&lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt;y 
    }
    K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, kernel) &lt;span style=&#34;color:#75715e&#34;&gt;# calc gram matrix&lt;/span&gt;
    C_N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(N)&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;beta
    l &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;if&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;abs&lt;/span&gt;(l&lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;likelihood&lt;/span&gt;(b,a,input,train))&lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.0001&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;&amp;amp;&lt;/span&gt;i&lt;span style=&#34;color:#f92672&#34;&gt;&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;2&lt;/span&gt;){
      break
    }else{
      a &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;(a &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; learning_rate&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;dloglik_a&lt;/span&gt;(C_N,train,input,input))
      b &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;as.numeric&lt;/span&gt;(b &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; learning_rate&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;dloglik_b&lt;/span&gt;(C_N,train,input,input))
    }
    l &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;likelihood&lt;/span&gt;(b,a,input,train)
  }
  K &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(input, input, kernel)
  C_N &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; K &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;length&lt;/span&gt;(input))&lt;span style=&#34;color:#f92672&#34;&gt;/&lt;/span&gt;beta
  m &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x) (&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; train)  
  m_sig &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;function&lt;/span&gt;(x)(&lt;span style=&#34;color:#a6e22e&#34;&gt;kernel&lt;/span&gt;(x,x) &lt;span style=&#34;color:#f92672&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;diag&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;solve&lt;/span&gt;(C_N) &lt;span style=&#34;color:#f92672&#34;&gt;%*%&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;t&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;outer&lt;/span&gt;(x, input, kernel))))
  x &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;seq&lt;/span&gt;(xmin,xmax,length&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;100&lt;/span&gt;)
  output &lt;span style=&#34;color:#f92672&#34;&gt;&amp;lt;-&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ggplot&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;data.frame&lt;/span&gt;(x1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;x,m&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x),sig1&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x)&lt;span style=&#34;color:#ae81ff&#34;&gt;+1.96&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;m_sig&lt;/span&gt;(x)),sig2&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;m&lt;/span&gt;(x)&lt;span style=&#34;color:#ae81ff&#34;&gt;-1.96&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;*&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;sqrt&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;m_sig&lt;/span&gt;(x)),
                              tx&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;input,ty&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;train),
                   &lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;x1,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;m)) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt; 
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_line&lt;/span&gt;() &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_ribbon&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(ymin&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;sig1,ymax&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;sig2),alpha&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;0.2&lt;/span&gt;) &lt;span style=&#34;color:#f92672&#34;&gt;+&lt;/span&gt;
    &lt;span style=&#34;color:#a6e22e&#34;&gt;geom_point&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;aes&lt;/span&gt;(x&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;tx,y&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;ty))
  &lt;span style=&#34;color:#a6e22e&#34;&gt;return&lt;/span&gt;(output)
}

&lt;span style=&#34;color:#a6e22e&#34;&gt;print&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;g&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;,&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;x,curve_fitting&lt;span style=&#34;color:#f92672&#34;&gt;$&lt;/span&gt;t), vp&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;viewport&lt;/span&gt;(layout.pos.row&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;, layout.pos.col&lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt;&lt;span style=&#34;color:#ae81ff&#34;&gt;1&lt;/span&gt;))
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;\normalsize&lt;img src=&#34;../../../en/post/post1/index_files/figure-html/unnamed-chunk-4-1.png&#34; width=&#34;672&#34; /&gt;&lt;/p&gt;
&lt;p&gt;Yes, it does sound like good (lol).
That&amp;rsquo;s it for today, for now.&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
