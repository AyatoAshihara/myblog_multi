<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  
  
  <meta name="generator" content="Wowchemy 4.8.0 for Hugo">
  

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Ayato Ashihara">

  
  
  
    
  
  <meta name="description" content="We created a horse racing prediction model from a new perspective of horse body photography.">

  
  <link rel="alternate" hreflang="ja" href="../../../post/post18/">
  
  <link rel="alternate" hreflang="en-us" href="../../../en/post/post18/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="../../../js/mathjax-config.js"></script>
  

  
  
  
  
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.2/lazysizes.min.js" integrity="sha512-TmDwFLhg3UA4ZG0Eb4MIyT1O1Mb+Oww5kFG0uHqXsdbyZz9DcvYQhKpGgNkamAI6h2lGGZq2X8ftOJvF/XjTUg==" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="../../../css/wowchemy.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140804055-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-140804055-1', { 'anonymize_ip': true });

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="../../../en/index.webmanifest">
  <link rel="icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="../../../en/post/post18/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@vdjgdkhvskcndj">
  <meta property="twitter:creator" content="@vdjgdkhvskcndj">
  
  <meta property="og:site_name" content="京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:url" content="/en/post/post18/">
  <meta property="og:title" content="I predicted the standings based on horse photos using CNN. | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:description" content="We created a horse racing prediction model from a new perspective of horse body photography."><meta property="og:image" content="/en/post/post18/featured.jpg">
  <meta property="twitter:image" content="/en/post/post18/featured.jpg"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-07-05T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2020-07-05T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/en/post/post18/"
  },
  "headline": "I predicted the standings based on horse photos using CNN.",
  
  "image": [
    "/en/post/post18/featured.jpg"
  ],
  
  "datePublished": "2020-07-05T00:00:00Z",
  "dateModified": "2020-07-05T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Ayato Ashihara"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "京都の電子部品メーカーで働く社会人が研究に没頭するブログ",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "We created a horse racing prediction model from a new perspective of horse body photography."
}
</script>

  

  


  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://www.cookiesandyou.com"
      }
    })});
  </script>



  





  <title>I predicted the standings based on horse photos using CNN. | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class=" ">

  
  
  
    <script>window.wcDarkLightEnabled = true;</script>
  
  
    <script>const isSiteThemeDark = false;</script>
  
  
  <script src="../../../js/load-theme.js"></script>

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="../../../en/post"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/publication"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      
      <li class="nav-item dropdown i18n-dropdown">
        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-globe mr-1" aria-hidden="true"></i><span class="d-none d-lg-inline">English</span></a>
        <div class="dropdown-menu">
          <div class="dropdown-item dropdown-item-active">
            <span>English</span>
          </div>
          
          <a class="dropdown-item" href="../../../post/post18/">
            <span>日本語</span>
          </a>
          
        </div>
      </li>
      

    </ul>

  </div>
</nav>



  <div class="container-fluid docs">
  <div class="row flex-xl-nowrap">

    <div class="d-none d-xl-block col-xl-2 docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-crawling-for-data-collection">1. Crawling for data collection</a>
          <ul>
            <li><a href="#where-to-get-the-data-from">Where to get the data from</a></li>
            <li><a href="#running-crawling-by-selenium">Running crawling by selenium</a></li>
          </ul>
        </li>
        <li><a href="#2-training-cnn-using-keras">2. Training CNN using <code>Keras</code></a>
          <ul>
            <li><a href="#what-is-keras">What is Keras?</a></li>
            <li><a href="#what-is-cnn">What is CNN?</a></li>
            <li><a href="#coding">Coding</a></li>
            <li><a href="#undersampling-for-unbalanced-data-adjustment">Undersampling for unbalanced data adjustment</a></li>
          </ul>
        </li>
        <li><a href="#3-interpretation-of-results-using-shap-values">3. Interpretation of results using Shap values</a></li>
        <li><a href="#4-finally">4. Finally</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>

    <main class="col-12 col-md-0 col-xl-10 py-md-3 pl-md-5 docs-content" role="main">
      <article class="article">

        




















  
  


<div class="article-container pt-3">
  <h1>I predicted the standings based on horse photos using CNN.</h1>

  

  

<div id="code-folding-buttons" class="dropdown btn-group pull-right">
  <a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" id="allCodeToggleButton"
     data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Code
  </a>
  <div class="dropdown-menu" aria-labelledby="allCodeToggleButton">
    <a id="rmd-show-all-code" class="dropdown-item small" href="#">Show all</a>
    <a id="rmd-hide-all-code" class="dropdown-item small" href="#">Hide all</a>
  </div>
</div>



  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Jul 5, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    5 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="../../../en/post/post18/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="../../../en/category/horse_racing/">horse_racing</a></span>
  

</div>

  














</div>


<div class="article-header container featured-image-wrapper mt-4 mb-4" style="max-width: 728px; max-height: 484px;">
  <div style="position: relative">
    <img src="../../../en/post/post18/featured.jpg" alt="" class="featured-image">
    
  </div>
</div>



        <div class="article-container">

          <div class="article-style">
            <p>Hi. This time I would like to write an article about predicting horse racing. In the last post, I created a prediction model for horse racing rankings using table data obtained from yahoo horse racing using <code>LightGBM</code>. I used structural data last time, but anyone can do this kind of analysis in these days. So this time, I developed a <code>Convolutional Neural Network</code> (CNN) which extracts features from a horse&rsquo;s body image and predicts its ranking. This is the second time I&rsquo;ve used <code>Earth Engine</code> to analyze satellite images, and the first time I&rsquo;ve used deep learning in this blog. The code is written in Python.</p>
<h2 id="1-crawling-for-data-collection">1. Crawling for data collection</h2>
<p>The first step is to collect images of the horse&rsquo;s body from the internet; the best thing to do would be to use pictures of the paddock on race day. However, as far as I&rsquo;ve been able to find, there are no sites that post photos of the paddock in a cohesive format. It may be interesting to use it as a clipped image or to apply it as a video to the <code>Encoder-Decoder</code> model of CNN to RNN, because it may be that a horse racing fan may have a paddock video on Youtube. However, I don&rsquo;t have the ability to do that much.</p>
<h3 id="where-to-get-the-data-from">Where to get the data from</h3>
<p>So in this case, the data is taken from <a href="https://www.daily.co.jp/horse/horsecheck/photo/" target="_blank" rel="noopener">Daley&rsquo;s Web site</a>. Here you can find pre-race photos of horses running in the last 1 year? You can find pre-race photos of horses running in G1 races in the past year? Horse bettors who can&rsquo;t go to the actual racecourse can look at these pictures and analyze the condition of the horses.<br>
Please note that this site does not include body photos of all the horses that are entered in the race. Also, since this is only a limited number of G1 races, it&rsquo;s entirely possible that all the horses are finished to begin with, and it&rsquo;s entirely possible that you won&rsquo;t be able to tell the difference. However, I&rsquo;ll make it a priority to try and do it quickly and use this data for this one.</p>
<h3 id="running-crawling-by-selenium">Running crawling by selenium</h3>
<p>For crawling, we&rsquo;ll use selenium. I won&rsquo;t go into web crawling as I&rsquo;m mainly using CNN in this article. The code I used is as follows.<br>
[Note] If you use the following codes, please do so at your own risk.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver
<span style="color:#f92672">from</span> selenium.webdriver.chrome.options <span style="color:#f92672">import</span> Options
<span style="color:#f92672">from</span> selenium.webdriver.support.select <span style="color:#f92672">import</span> Select
<span style="color:#f92672">from</span> selenium.webdriver.common.by <span style="color:#f92672">import</span> By
<span style="color:#f92672">from</span> selenium.webdriver.common.keys <span style="color:#f92672">import</span> Keys
<span style="color:#f92672">from</span> selenium.webdriver.common.alert <span style="color:#f92672">import</span> Alert
<span style="color:#f92672">from</span> selenium.webdriver.support.ui <span style="color:#f92672">import</span> WebDriverWait
<span style="color:#f92672">from</span> selenium.webdriver.support <span style="color:#f92672">import</span> expected_conditions <span style="color:#66d9ef">as</span> EC
<span style="color:#f92672">from</span> selenium.common.exceptions <span style="color:#f92672">import</span> TimeoutException
<span style="color:#f92672">from</span> selenium.webdriver.common.action_chains <span style="color:#f92672">import</span> ActionChains
<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> sleep
<span style="color:#f92672">from</span> urllib <span style="color:#f92672">import</span> request
<span style="color:#f92672">import</span> random

<span style="color:#75715e"># selenium option settings (spell)</span>
options <span style="color:#f92672">=</span> Options()
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--disable-gpu&#39;</span>);
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--disable-extensions&#39;</span>);
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--proxy-server=&#34;direct://&#34;&#39;</span>);
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--proxy-bypass-list=*&#39;</span>);
options<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#39;--start-maximized&#39;</span>);

<span style="color:#75715e"># driver specification</span>
DRIVER_PATH <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:/Users/aashi/Desktop/chromedriver_win32/chromedriver.exe&#39;</span>
driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome(executable_path<span style="color:#f92672">=</span>DRIVER_PATH, chrome_options<span style="color:#f92672">=</span>options)

<span style="color:#75715e"># Pass the url and go to the site</span>
url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://www.daily.co.jp/horse/horsecheck/photo/&#39;</span>
driver<span style="color:#f92672">.</span>get(url)
driver<span style="color:#f92672">.</span>implicitly_wait(<span style="color:#ae81ff">15</span>) <span style="color:#75715e"># Maximum time to wait for an object to load, and if this is exceeded, an error</span>
sleep(<span style="color:#ae81ff">5</span>) <span style="color:#75715e"># 1 second sleep as the web page transition is performed</span>

<span style="color:#75715e"># Image data is saved for each race.</span>
selector0 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;body &gt; div &gt; main &gt; div &gt; div.primaryContents &gt; article &gt; div &gt; section &gt; a&#34;</span>
elements <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_elements_by_css_selector(selector0)
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,len(elements)):
  elements <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_elements_by_css_selector(selector0)
  element <span style="color:#f92672">=</span> elements[i]
  element<span style="color:#f92672">.</span>click()
  sleep(<span style="color:#ae81ff">5</span>) <span style="color:#75715e"># 5 seconds sleep as the web page transition is performed</span>

  target <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_link_text(<span style="color:#e6db74">&#39;Ｇ１馬体診断写真集のTOP&#39;</span>)
  actions <span style="color:#f92672">=</span> ActionChains(driver)
  actions<span style="color:#f92672">.</span>move_to_element(target)
  actions<span style="color:#f92672">.</span>perform()
  sleep(<span style="color:#ae81ff">5</span>) <span style="color:#75715e"># 5 seconds sleep as the web page transition is performed</span>
  selector <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;body &gt; div.wrapper.horse.is-fixedHeader.is-fixedAnimation &gt; main &gt; div &gt; div.primaryContents &gt; article &gt; article &gt; div.photoDetail-wrapper &gt; section &gt; div &gt; figure&#34;</span>
  figures <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_elements_by_css_selector(selector)
  download_dir <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\aashi\umanalytics\photo\image&#39;</span>
  selector <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;body &gt; div &gt; main &gt; div &gt; div.primaryContents &gt; article &gt; article &gt; div.photoDetail-wrapper &gt; section &gt; h1&#34;</span>
  race_name <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_css_selector(selector)<span style="color:#f92672">.</span>text
  <span style="color:#66d9ef">for</span> figure <span style="color:#f92672">in</span> figures:
    img_name <span style="color:#f92672">=</span> figure<span style="color:#f92672">.</span>find_element_by_tag_name(<span style="color:#e6db74">&#39;figcaption&#39;</span>)<span style="color:#f92672">.</span>text
    horse_src <span style="color:#f92672">=</span> figure<span style="color:#f92672">.</span>find_element_by_tag_name(<span style="color:#e6db74">&#39;img&#39;</span>)<span style="color:#f92672">.</span>get_attribute(<span style="color:#e6db74">&#34;src&#34;</span>)    
    save_name <span style="color:#f92672">=</span> download_dir <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/&#39;</span> <span style="color:#f92672">+</span> race_name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;_&#39;</span> <span style="color:#f92672">+</span> img_name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.jpg&#39;</span>
    request<span style="color:#f92672">.</span>urlretrieve(horse_src,save_name)
  driver<span style="color:#f92672">.</span>back()
</code></pre></div><p>The saved images were cross-checked with the actual race results and manually divided into the top three groups and the rest of the groups. The images are saved as follows.</p>
<p><img src="horse_photo.PNG" alt="Stored Horse Image"></p>
<p>This completes the collection of the original data.</p>
<h2 id="2-training-cnn-using-keras">2. Training CNN using <code>Keras</code></h2>
<h3 id="what-is-keras">What is Keras?</h3>
<p>Now, let&rsquo;s train CNN using <code>Keras</code>. <code>Keras</code> is one of the <code>Neural Network</code> libraries that runs on <code>Tensorflow</code> and <code>Theano</code>. <code>Keras</code> is one of the <code>Neural Network</code> libraries that runs on <code>Tensorflow</code> and <code>Theano</code>. <code>Keras</code> is characterized by its ability to build models with relatively short code and its many learning algorithms.</p>
<h3 id="what-is-cnn">What is CNN?</h3>
<p>CNN is a type of <code>(Deep) Neural Network</code> often used in image analysis, and as its name suggests, it is an additional <code>convolution</code>. Convolution is a process like the following.</p>
<p><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/t/tdualdir/20180501/20180501211957.png" alt="Convolutional Layer Processing"></p>
<p>The input here is the image data. Image analysis recognizes and analyzes images as numerical values. The image on the computer is represented by the <code>RGB</code> value, which is a numerical value from 0 to 255 of three colors, red (Red), green (Green) and blue (Blue). There are three layers of vectors in the form of 255 red, 0 green, 0 blue, and so on, and in this case a perfect red is represented. In the case above, you can think of a, b, c, etc. as representing one of the <code>RGB</code> values of each pixel. Convolution calculates the features of an image by taking the inner product of these <code>RGB</code> values with a matrix called the kernel. The following video(Japanese) is a good example of what the convolution layer means.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/vU-JfZNBdYU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>By learning the kernel to successfully get the distinctive parts of that image, it is possible to identify the image. I think the convolutional layer is the most important part of the CNN.</p>
<p><img src="https://th.bing.com/th/id/OIP.F2Ik_XFzmu5jZF-byiAKQQHaCg?w=342&amp;h=118&amp;c=7&amp;o=5&amp;dpr=1.25&amp;pid=1.7" alt="The Big Picture of CNN"></p>
<p>As shown in the above figure, CNN has not only convolutional layers but also input and output layers as well as usual <code>Neural Network</code> layers. If you want to know about the <code>MaxPooling</code> layer, see the following movie(Japanese).</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/MLixg9K6oeU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>Although the gradient method is known as the most orthodox training method for deep learning, various extension algorithms such as <code>Adam</code> have been proposed. Basically, <code>Adam</code> or <code>momentum</code> is often used.</p>
<h3 id="coding">Coding</h3>
<p>Now, let&rsquo;s get to the coding.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> keras.utils <span style="color:#f92672">import</span> np_utils
</code></pre></div><pre><code>## Using TensorFlow backend.
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> keras.layers.convolutional <span style="color:#f92672">import</span> MaxPooling2D
<span style="color:#f92672">from</span> keras.layers <span style="color:#f92672">import</span> Activation, Conv2D, Flatten, Dense,Dropout
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
<span style="color:#f92672">from</span> keras.optimizers <span style="color:#f92672">import</span> SGD, Adadelta, Adagrad, Adam, Adamax, RMSprop, Nadam
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> glob
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> time
<span style="color:#f92672">import</span> os
</code></pre></div><p>The first step is to convert the collected image data to numerical data to create the training data.
The directory structure is as follows, with the top image and other images being stored in separate directories. When we read in the images from each directory, we give a category variable of 1 for the top image and 0 for others.</p>
<p>photograph of a horse</p>
<ul>
<li>superior (in rank)</li>
<li>Other</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Specify a folder</span>
folders <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;C:\Users\aashi\umanalytics\photo\image&#34;</span>)
<span style="color:#75715e">#Specify the total number of strokes (50 x 50 x 3 in this case).</span>
image_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
dense_size <span style="color:#f92672">=</span> len(folders)

X <span style="color:#f92672">=</span> []
Y <span style="color:#f92672">=</span> []

<span style="color:#75715e">#Reads an image from each folder and converts it to a numpy array of RGB values using the Image function</span>
<span style="color:#66d9ef">for</span> i, folder <span style="color:#f92672">in</span> enumerate(folders):
  files <span style="color:#f92672">=</span> glob<span style="color:#f92672">.</span>glob(<span style="color:#e6db74">&#34;C:/Users/aashi/umanalytics/photo/image/&#34;</span> <span style="color:#f92672">+</span> folder <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/*.jpg&#34;</span>)
  index <span style="color:#f92672">=</span> i
  <span style="color:#66d9ef">for</span> k, file <span style="color:#f92672">in</span> enumerate(files):
    image <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(file)
    image <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#34;L&#34;</span>)<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#34;RGB&#34;</span>)
    image <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>resize((image_size, image_size)) <span style="color:#75715e">#I&#39;m dropping the number of pixels.</span>
 
    data <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>asarray(image)
    X<span style="color:#f92672">.</span>append(data)
    Y<span style="color:#f92672">.</span>append(index)

X <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(X)
Y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(Y)
X <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float32&#39;</span>)
X <span style="color:#f92672">=</span> X <span style="color:#f92672">/</span> <span style="color:#ae81ff">255.0</span> <span style="color:#75715e"># Conversion to 0~1</span>
X<span style="color:#f92672">.</span>shape
Y <span style="color:#f92672">=</span> np_utils<span style="color:#f92672">.</span>to_categorical(Y, dense_size)

<span style="color:#75715e">#splitting training data and test data</span>
X_train, X_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(X, Y, test_size<span style="color:#f92672">=</span><span style="color:#ae81ff">0.20</span>)
</code></pre></div><p>I&rsquo;ve been able to split the training data and the test data. What I&rsquo;m considering now is a binary classification of &ldquo;top&rdquo; and &ldquo;other&rdquo;, but I defined &ldquo;top&rdquo; as the top 3, so the data is unbalanced (about 5 times as much other data as the top data). In this case, if we train on the data as it is, it is easier to predict the label with the larger sample size (in this case, &ldquo;other&rdquo;), and the model will have a bias. Therefore, it is necessary to adjust the training data so that the sample size is the same for each of the two classes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">index_zero <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(np<span style="color:#f92672">.</span>array(np<span style="color:#f92672">.</span>where(y_train[:,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>))[<span style="color:#ae81ff">0</span>,],np<span style="color:#f92672">.</span>count_nonzero(y_train[:,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>),replace<span style="color:#f92672">=</span>False)
index_one <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(np<span style="color:#f92672">.</span>where(y_train[:,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>))[<span style="color:#ae81ff">0</span>]
y_resampled <span style="color:#f92672">=</span> y_train[np<span style="color:#f92672">.</span>hstack((index_one,index_zero))]
X_resampled <span style="color:#f92672">=</span> X_train[np<span style="color:#f92672">.</span>hstack((index_one,index_zero))]
</code></pre></div><p>We will use this <code>y_resampled</code> and <code>X_resampled</code> for the training data. Next, we will build the CNN. In <code>Keras</code>, a model is defined by specifying a <code>sequential model</code> and adding a layer by <code>add</code> method.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Sequential()
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>,input_shape<span style="color:#f92672">=</span>X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>:]))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">32</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>)))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))

model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>), padding<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;same&#39;</span>))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Conv2D(<span style="color:#ae81ff">64</span>, (<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>)))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(MaxPooling2D(pool_size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.25</span>))

model<span style="color:#f92672">.</span>add(Flatten())
model<span style="color:#f92672">.</span>add(Dense(<span style="color:#ae81ff">512</span>))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;relu&#39;</span>))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.5</span>))
model<span style="color:#f92672">.</span>add(Dense(dense_size))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74">&#39;softmax&#39;</span>))

model<span style="color:#f92672">.</span>summary()
</code></pre></div><pre><code>## Model: &quot;sequential_1&quot;
## _________________________________________________________________
## Layer (type)                 Output Shape              Param #   
## =================================================================
## conv2d_1 (Conv2D)            (None, 300, 300, 32)      896       
## _________________________________________________________________
## activation_1 (Activation)    (None, 300, 300, 32)      0         
## _________________________________________________________________
## conv2d_2 (Conv2D)            (None, 298, 298, 32)      9248      
## _________________________________________________________________
## activation_2 (Activation)    (None, 298, 298, 32)      0         
## _________________________________________________________________
## max_pooling2d_1 (MaxPooling2 (None, 149, 149, 32)      0         
## _________________________________________________________________
## dropout_1 (Dropout)          (None, 149, 149, 32)      0         
## _________________________________________________________________
## conv2d_3 (Conv2D)            (None, 149, 149, 64)      18496     
## _________________________________________________________________
## activation_3 (Activation)    (None, 149, 149, 64)      0         
## _________________________________________________________________
## conv2d_4 (Conv2D)            (None, 147, 147, 64)      36928     
## _________________________________________________________________
## activation_4 (Activation)    (None, 147, 147, 64)      0         
## _________________________________________________________________
## max_pooling2d_2 (MaxPooling2 (None, 73, 73, 64)        0         
## _________________________________________________________________
## dropout_2 (Dropout)          (None, 73, 73, 64)        0         
## _________________________________________________________________
## flatten_1 (Flatten)          (None, 341056)            0         
## _________________________________________________________________
## dense_1 (Dense)              (None, 512)               174621184 
## _________________________________________________________________
## activation_5 (Activation)    (None, 512)               0         
## _________________________________________________________________
## dropout_3 (Dropout)          (None, 512)               0         
## _________________________________________________________________
## dense_2 (Dense)              (None, 2)                 1026      
## _________________________________________________________________
## activation_6 (Activation)    (None, 2)                 0         
## =================================================================
## Total params: 174,687,778
## Trainable params: 174,687,778
## Non-trainable params: 0
## _________________________________________________________________
</code></pre><p>Now, let&rsquo;s get to the learning part. We&rsquo;ll use <code>Adadelta</code> for the algorithm. I don&rsquo;t really understand it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">optimizers <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Adadelta&#34;</span>
results <span style="color:#f92672">=</span> {}
epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
model<span style="color:#f92672">.</span>compile(loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;categorical_crossentropy&#39;</span>, optimizer<span style="color:#f92672">=</span>optimizers, metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;accuracy&#39;</span>])
results <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(X_resampled, y_resampled, validation_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>, epochs<span style="color:#f92672">=</span>epochs)
</code></pre></div><h3 id="undersampling-for-unbalanced-data-adjustment">Undersampling for unbalanced data adjustment</h3>
<p>From here, we perform binary classification with Test data, but since we are undersampling the training data, we have an undersampled sample selection bias when calculating the prediction probability. The paper is available <a href="https://www3.nd.edu/~dial/publications/dalpozzolo2015calibrating.pdf" target="_blank" rel="noopener">here</a>.</p>
<p>Therefore, I would like to formulate this part of the problem here, although a correction is needed. I will describe the current binary classification problem as the problem of predicting the objective variable <code>\(Y\)</code>, which takes a binary value from the explanatory thousand <code>\(X\)</code>. Let <code>\((X,Y)\)</code> be a dataset where the positive example is considerably less than the negative example and the sample size of the negative example is matched to the positive example as <code>\((X_s,Y_s)\)</code>. We define a categorical variable <code>\(s\)</code> that takes 1 if the <code>\((X,Y)\)</code> sample set is also included in <code>\((X_s,Y_s)\)</code> and 0 if it is not.
Given an explanatory variable <code>\(x\)</code> to the model constructed using the dataset <code>\((X,Y)\)</code>, the positive example and the conditional probability of predicting can be expressed as <code>\(P(y=1|x)\)</code>. On the other hand, the conditional probability of predicting a positive example in a model constructed using <code>\((X_s,Y_s)\)</code> can be expressed as <code>\(P(y=1|x)\)</code> using Bayes' theorem and the categorical variable <code>\(s\)</code>.</p>
<p>$$
P(y=1|x,s=1) = \frac{P(s=1|y=1)P(y=1|x)}{P(s=1|y=1)P(y=1|x) + P(s=1|y=0)P(y=0|x)}
$$
It can be written as. Since <code>\((X_s,Y_s)\)</code> matches the sample size of the negative example to the positive example, <code>\(P(s=1,y=1)=1\)</code>, the above formula is rewritten as</p>
<p>$$
P(y=1|x,s=1) = \frac{P(y=1|x)}{P(y=1|x) + P(s=1|y=0)P(y=0|x)}
= \frac{P(y=1|x)}{P(y=1|x) + P(s=1|y=0)(1-P(y=1|x))}
$$
It is self-evident from the definition of <code>\((X_s,Y_s)\)</code> that <code>\(P(s=1|y=0)\neq0\)</code> (0 would result in unbalanced data with only positive examples). Thus, as long as <code>\(P(y=0,x) \neq0\)</code>, the probability that the undersampling model will be rejected as a positive example is positively biased against the probability that the original data set will produce. What we want to find is <code>\(P(y=1|x)\)</code> with no bias, so <code>\(P=P(y=1|x),P_s=P(y|x,s=1),\beta=P(s=1,y=0)\)</code>, then we can get</p>
<p>$$
P = \frac{\beta P_s}{\beta P_s-P_s+1}
$$
and can use this relationship formula to correct for bias.
Let&rsquo;s define what we&rsquo;ve just identified as a function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calibration</span>(y_proba, beta):
    <span style="color:#66d9ef">return</span> y_proba <span style="color:#f92672">/</span> (y_proba <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> y_proba) <span style="color:#f92672">/</span> beta)

sampling_rate <span style="color:#f92672">=</span> sum(y_train[:,<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">/</span> sum(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>y_train[:,<span style="color:#ae81ff">1</span>])
y_proba_calib <span style="color:#f92672">=</span> calibration(model<span style="color:#f92672">.</span>predict(X_test), sampling_rate)
y_pred <span style="color:#f92672">=</span> np_utils<span style="color:#f92672">.</span>to_categorical(np<span style="color:#f92672">.</span>argmax(y_proba_calib,axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>), dense_size)

<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix, ConfusionMatrixDisplay, accuracy_score
score <span style="color:#f92672">=</span> accuracy_score(y_test, y_pred)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Test accuracy:&#39;</span>, score)
</code></pre></div><pre><code>## Test accuracy: 0.3220338983050847
</code></pre><p>It&rsquo;s not good at all. I ran the <code>ConfusionMatrix</code> and found out that it doesn&rsquo;t work.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ConfusionMatrixDisplay(confusion_matrix(np<span style="color:#f92672">.</span>argmax(y_test,axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>), np<span style="color:#f92672">.</span>argmax(y_pred,axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)))<span style="color:#f92672">.</span>plot()
</code></pre></div><pre><code>## &lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay object at 0x000000004A54CC88&gt;
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post18/index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()
</code></pre></div><p>I did a bias correction for the imbalance data, but the model is still very predictive of negative values. This doesn&rsquo;t work.</p>
<h2 id="3-interpretation-of-results-using-shap-values">3. Interpretation of results using Shap values</h2>
<p>I would like to consider the <code>shap</code> value of the model we just learned and interpret the results. I&rsquo;ll add an explanation of the <code>shap</code> value when I have time. Simply put, the visualization captures which parts of the image the CNN captured features and predicted the horse to be at the top. We&rsquo;ll be analyzing this horse.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>imshow(X_test[<span style="color:#ae81ff">0</span>])
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post18/index_files/figure-html/unnamed-chunk-14-3.png" width="672" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> shap
background <span style="color:#f92672">=</span> X_train[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">100</span>,replace<span style="color:#f92672">=</span>False)]

e <span style="color:#f92672">=</span> shap<span style="color:#f92672">.</span>GradientExplainer(model,background)

shap_values <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span>shap_values(X_test[[<span style="color:#ae81ff">0</span>]])
shap<span style="color:#f92672">.</span>image_plot(shap_values[<span style="color:#ae81ff">1</span>],X_test[[<span style="color:#ae81ff">0</span>]])
</code></pre></div><p><img src="../../../en/post/post18/index_files/figure-html/unnamed-chunk-15-5.png" width="576" /></p>
<p>It&rsquo;s very subtle, but it looks like you&rsquo;re appreciating the legs and buttocks, etc. It needs to be cropped to take out the horse&rsquo;s body only, since it seems to be responding to the background. I think I need to build a model for object detection. I&rsquo;ll think about this another time.</p>
<h2 id="4-finally">4. Finally</h2>
<p>To be honest, it hasn&rsquo;t worked out at all. Is it still difficult to predict rankings from the horse&rsquo;s body? Does multiplying it with other variables change the results? I don&rsquo;t think I&rsquo;m able to extract good features from the horses as it is.
Do I need to get to the point where I can get a paddock video from Youtube and analyze it with the <code>Encoder-Decoder</code> model to make it work? I&rsquo;d love to do it when I&rsquo;m good enough to do it (I don&rsquo;t know when that will be). Until then, I need to improve my PC specs. Maybe I&rsquo;ll use the cash handout.</p>

          </div>

          






<div class="article-tags">
  
  <a class="badge badge-light" href="../../../en/tag/python/">Python</a>
  
  <a class="badge badge-light" href="../../../en/tag/web_scraping/">Web_scraping</a>
  
  <a class="badge badge-light" href="../../../en/tag/machine_learning/">machine_learning</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=../../../en/post/post18/&amp;text=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN." target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/en/post/post18/&amp;t=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN." target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN.&amp;body=/en/post/post18/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=../../../en/post/post18/&amp;title=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN." target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN.%20/en/post/post18/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=../../../en/post/post18/&amp;title=I%20predicted%20the%20standings%20based%20on%20horse%20photos%20using%20CNN." target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="../../../"><img class="avatar mr-3 avatar-circle" src="../../../en/author/ayato-ashihara/avatar_hu77c0c0affdebd3b9cbda9c39412092b5_245163_270x270_fill_q90_lanczos_center.jpg" alt="Ayato Ashihara"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="../../../">Ayato Ashihara</a></h5>
      <h6 class="card-subtitle">company employee</h6>
      <p class="card-text">This blog is a nightly update by a man who is working in his forth year since completing graduate school. The content of this blog has nothing to do with the official position of the author&rsquo;s organization.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="../../../en/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/ASSIY" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/AyatoAshihara/myblog_multi" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>







<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "ayatoashihara-github-io-myblog-multi" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>




<div class="article-widget">
  
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="../../../en/post/post19/" rel="next">Is that backtest really reproducible?</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="../../../en/post/post16/" rel="prev">Predicting Horse Racing Results Using LightGBM</a>
  </div>
  
</div>

</div>





  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="../../../en/post/post16/">Predicting Horse Racing Results Using LightGBM</a></li>
      
      <li><a href="../../../en/post/post22/">Get macro panel data from OECD.org via API</a></li>
      
      <li><a href="../../../en/post/post20/">Automatically cropping the background of a horse body photo with Pytorch&#39;s Pre-trained model</a></li>
      
      <li><a href="../../../en/post/post12/">Obtaining satellite image data with the Google Earth Engine API and do nowcasting on business conditions</a></li>
      
      <li><a href="../../../en/post/post11/">Scraping past race results on yahoo horse racing on rvest (for the second time)</a></li>
      
    </ul>
  </div>
  





        </div>
      </article>
    </main>

  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.0/mermaid.min.js" integrity="sha512-ja+hSBi4JDtjSqc4LTBsSwuBT3tdZ3oKYKd07lTVYmCnTCor56AnRql00ssqnTOR9Ss4gOP/ROGB3SfcJnZkeg==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/latex.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/sql.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/cpp.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/en/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://ayatoashihara-github-io-myblog-multi.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
      
    
    
    
    <script src="../../../js/wowchemy.min.2a3f95be2bc4762ba1847fb5d7a28317.js"></script>

    


  
  
  <div class="container">
    <footer class="site-footer">
  

  
   
  <script>
  $(document).ready(function () {
    window.initializeCodeFolding("show" === "show");
  });
  </script>
  <script src="../../../js/codefolding.js"></script>


  <p class="powered-by">
    
  </p>

  
  






  <p class="powered-by">
    
    Published with
    <a href="https://wowchemy.com" target="_blank" rel="noopener">Wowchemy</a>  —
    the free, <a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">
    open source</a> website builder that empowers creators.
    

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
