<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  
  
  <meta name="generator" content="Wowchemy 4.8.0 for Hugo">
  

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Ayato Ashihara">

  
  
  
    
  
  <meta name="description" content="I cropped it because the background of the stables was in the way of the horse model I made in the previous post.">

  
  <link rel="alternate" hreflang="ja" href="../../../post/post20/">
  
  <link rel="alternate" hreflang="en-us" href="../../../en/post/post20/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="../../../js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.2/lazysizes.min.js" integrity="sha512-TmDwFLhg3UA4ZG0Eb4MIyT1O1Mb+Oww5kFG0uHqXsdbyZz9DcvYQhKpGgNkamAI6h2lGGZq2X8ftOJvF/XjTUg==" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="../../../css/wowchemy.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140804055-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-140804055-1', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="../../../en/index.webmanifest">
  <link rel="icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="../../../en/post/post20/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:url" content="/en/post/post20/">
  <meta property="og:title" content="Automatically cropping the background of a horse body photo with Pytorch&#39;s Pre-trained model | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:description" content="I cropped it because the background of the stables was in the way of the horse model I made in the previous post."><meta property="og:image" content="/en/post/post20/featured.jpg">
  <meta property="twitter:image" content="/en/post/post20/featured.jpg"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-08-12T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2020-08-12T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/en/post/post20/"
  },
  "headline": "Automatically cropping the background of a horse body photo with Pytorch's Pre-trained model",
  
  "image": [
    "/en/post/post20/featured.jpg"
  ],
  
  "datePublished": "2020-08-12T00:00:00Z",
  "dateModified": "2020-08-12T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Ayato Ashihara"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "京都の電子部品メーカーで働く社会人が研究に没頭するブログ",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "I cropped it because the background of the stables was in the way of the horse model I made in the previous post."
}
</script>

  

  


  


  





  <title>Automatically cropping the background of a horse body photo with Pytorch&#39;s Pre-trained model | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class=" ">

  
  
  
    <script>window.wcDarkLightEnabled = true;</script>
  
  
    <script>const isSiteThemeDark = false;</script>
  
  
  <script src="../../../js/load-theme.js"></script>

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="../../../en/post"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/publication"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      
      <li class="nav-item dropdown i18n-dropdown">
        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-globe mr-1" aria-hidden="true"></i><span class="d-none d-lg-inline">English</span></a>
        <div class="dropdown-menu">
          <div class="dropdown-item dropdown-item-active">
            <span>English</span>
          </div>
          
          <a class="dropdown-item" href="../../../post/post20/">
            <span>日本語</span>
          </a>
          
        </div>
      </li>
      

    </ul>

  </div>
</nav>



  <div class="container-fluid docs">
  <div class="row flex-xl-nowrap">

    <div class="d-none d-xl-block col-xl-2 docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-downloading-the-pre-trained-model">1. Downloading the pre-trained model</a></li>
        <li><a href="#2-executing-the-background-deletion-process">2. Executing the Background Deletion Process</a></li>
        <li><a href="#3-analysis-using-cnn">3. Analysis using CNN</a></li>
        <li><a href="#4-interpretation-of-results-using-shap-values">4. Interpretation of results using Shap values</a></li>
        <li><a href="#5summary">5.Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>

    <main class="col-12 col-md-0 col-xl-10 py-md-3 pl-md-5 docs-content" role="main">
      <article class="article">

        




















  
  


<div class="article-container pt-3">
  <h1>Automatically cropping the background of a horse body photo with Pytorch&#39;s Pre-trained model</h1>

  

  


<div id="code-folding-buttons" class="dropdown btn-group pull-right">
  <a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" id="allCodeToggleButton"
     data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Code
  </a>
  <div class="dropdown-menu" aria-labelledby="allCodeToggleButton">
    <a id="rmd-show-all-code" class="dropdown-item small" href="#">Show all</a>
    <a id="rmd-hide-all-code" class="dropdown-item small" href="#">Hide all</a>
  </div>
</div>



  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Aug 12, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="../../../en/post/post20/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="../../../en/category/horse-racing/">horse racing</a></span>
  

</div>

  














</div>


<div class="article-header container featured-image-wrapper mt-4 mb-4" style="max-width: 450px; max-height: 357px;">
  <div style="position: relative">
    <img src="../../../en/post/post20/featured.jpg" alt="" class="featured-image">
    
  </div>
</div>



        <div class="article-container">

          <div class="article-style">
            <p>Hi. In the last post, I built a model to predict the order of a racehorse using CNN based on its body image. The results were not so good, and we needed to refine our analysis, especially when we analyzed the factors using <code>shap</code> values, we found that the horses responded more to the stables in the background than to their bodies. This time, I would like to use Pytorch&rsquo;s Pre-trained model to cut out the background from the horse photo and re-analyze the photo with only the horse body.</p>
<h2 id="1-downloading-the-pre-trained-model">1. Downloading the pre-trained model</h2>
<p>The code is adapted from <a href="https://pytorch.org/hub/pytorch_vision_deeplabv3_resnet101/" target="_blank" rel="noopener">here</a>. First, install the packages.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> cv2
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> torchvision
<span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> transforms
<span style="color:#f92672">import</span> glob
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">import</span> PIL
<span style="color:#f92672">import</span> os
</code></pre></div><p>Next, install the pre-trained model.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Install a pre-trained model</span>
device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>device(<span style="color:#e6db74">&#34;cuda:0&#34;</span> <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>is_available() <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;cpu&#34;</span>)
model <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>segmentation<span style="color:#f92672">.</span>deeplabv3_resnet101(pretrained<span style="color:#f92672">=</span>True)
model <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>to(device)
model<span style="color:#f92672">.</span>eval()
</code></pre></div><p>Apparently, all pre-trained models assume a mini-batch of 3-channel RGB images of shape <code>\((N, 3, H, W)\)</code> normalized in the same way. Here, <code>\(N\)</code> is assumed to be the number of images and <code>\(H\)</code> and <code>\(W\)</code> are assumed to be at least 224 pixels. The images need to be scaled to a range of [0, 1] and then normalized using the mean value = [0.485, 0.456, 0.406] and the standard value = [0.229, 0.224, 0.225]. So, we define a function that does the preprocessing.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#preprocessing</span>
preprocess <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose([
    transforms<span style="color:#f92672">.</span>ToTensor(),
    transforms<span style="color:#f92672">.</span>Normalize(mean<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.485</span>, <span style="color:#ae81ff">0.456</span>, <span style="color:#ae81ff">0.406</span>], std<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.229</span>, <span style="color:#ae81ff">0.224</span>, <span style="color:#ae81ff">0.225</span>]),
])
</code></pre></div><h2 id="2-executing-the-background-deletion-process">2. Executing the Background Deletion Process</h2>
<p>Now, let&rsquo;s load the images collected by the <code>selenium</code> code in the previous post and remove the background one by one.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#Specify a folder</span>
folders <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;C:\Users\aashi\umanalytics\photo\image&#34;</span>)

<span style="color:#75715e">#Reads an image from each folder and converts it to a numpy array of RGB values using the Image function</span>
<span style="color:#66d9ef">for</span> i, folder <span style="color:#f92672">in</span> enumerate(folders):
  files <span style="color:#f92672">=</span> glob<span style="color:#f92672">.</span>glob(<span style="color:#e6db74">&#34;C:/Users/aashi/umanalytics/photo/image/&#34;</span> <span style="color:#f92672">+</span> folder <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/*.jpg&#34;</span>)
  index <span style="color:#f92672">=</span> i
  <span style="color:#66d9ef">for</span> k, file <span style="color:#f92672">in</span> enumerate(files):
    img_array <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>fromfile(file, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
    img <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imdecode(img_array, cv2<span style="color:#f92672">.</span>IMREAD_COLOR)
    h,w,_ <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>shape
    input_tensor <span style="color:#f92672">=</span> preprocess(img)
    input_batch <span style="color:#f92672">=</span> input_tensor<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>to(device)

    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
      output <span style="color:#f92672">=</span> model(input_batch)[<span style="color:#e6db74">&#39;out&#39;</span>][<span style="color:#ae81ff">0</span>]
    output_predictions <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">0</span>)
    mask_array <span style="color:#f92672">=</span> output_predictions<span style="color:#f92672">.</span>byte()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
    Image<span style="color:#f92672">.</span>fromarray(mask_array<span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>save(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\aashi\umanalytics\photo\image\mask.jpg&#39;</span>)
    mask <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>imread(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\Users\aashi\umanalytics\photo\image\mask.jpg&#39;</span>)
    bg <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>full_like(img,<span style="color:#ae81ff">255</span>)
    img <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>multiply(img<span style="color:#f92672">.</span>astype(float), mask<span style="color:#f92672">.</span>astype(float)<span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>)
    bg <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>multiply(bg<span style="color:#f92672">.</span>astype(float), <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> mask<span style="color:#f92672">.</span>astype(float)<span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>)
    outImage <span style="color:#f92672">=</span> cv2<span style="color:#f92672">.</span>add(img, bg)
    Image<span style="color:#f92672">.</span>fromarray(outImage<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8))<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#39;L&#39;</span>)<span style="color:#f92672">.</span>save(file)
</code></pre></div><p>The following <code>mask</code> image is output using the pre-trained model, and the <code>numpy</code> array and the <code>mask</code> image are merged to create a background delete image. The output looks like the following.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>gray()
plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">20</span>))
plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>)
plt<span style="color:#f92672">.</span>imshow(img)
plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">2</span>)
plt<span style="color:#f92672">.</span>imshow(mask)
plt<span style="color:#f92672">.</span>subplot(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">3</span>)
plt<span style="color:#f92672">.</span>imshow(outImage)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-8-1.png" width="1920" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()
</code></pre></div><p>Here&rsquo;s what the folders look like. Some of them are handled well and some of them show the trainer. I know there is a way to identify the objects and <code>mask</code> only the horses, but this model doesn&rsquo;t allow for object labeling, so we&rsquo;ll continue with that.</p>
<p><img src="maskhorse.PNG" alt="folder"></p>
<h2 id="3-analysis-using-cnn">3. Analysis using CNN</h2>
<p>Here is the same content as in the previous article. I will only post the results.</p>
<pre><code>## Test accuracy: 0.0
</code></pre><pre><code>## &lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay object at 0x000000002F791188&gt;
</code></pre><p><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-10-3.png" width="672" /></p>
<p>The results have been disastrous.
I have not been able to identify it at all. Aren&rsquo;t there any characteristics in the horse photos that would predict the rankings? Or is it that there is no variation in the photos of the horses in G1 races and it is impossible to identify them? Either way, it seems a bit harsh.</p>
<h2 id="4-interpretation-of-results-using-shap-values">4. Interpretation of results using Shap values</h2>
<p>As before, let&rsquo;s see how it fails using the <code>shap</code> value. We will use this image as an example.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>imshow(X_test[<span style="color:#ae81ff">4</span>])
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-11-5.png" width="672" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> shap
background <span style="color:#f92672">=</span> X_resampled[np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>choice(X_resampled<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">100</span>,replace<span style="color:#f92672">=</span>False)]

e <span style="color:#f92672">=</span> shap<span style="color:#f92672">.</span>GradientExplainer(model,background)

shap_values <span style="color:#f92672">=</span> e<span style="color:#f92672">.</span>shap_values(X_test[[<span style="color:#ae81ff">4</span>]])
shap<span style="color:#f92672">.</span>image_plot(shap_values[<span style="color:#ae81ff">1</span>],X_test[[<span style="color:#ae81ff">4</span>]])
</code></pre></div><p><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-12-7.png" width="576" /></p>
<p>They seem to be evaluating from the paws to the face. Surprisingly, they do not seem to be evaluating the buttocks.
I would like to try to visualize which aspect of the image is captured in each layer.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> keras <span style="color:#f92672">import</span> models

layer_outputs <span style="color:#f92672">=</span> [layer<span style="color:#f92672">.</span>output <span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>layers[:<span style="color:#ae81ff">8</span>]]
layer_names <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> layer <span style="color:#f92672">in</span> model<span style="color:#f92672">.</span>layers[:<span style="color:#ae81ff">8</span>]:
    layer_names<span style="color:#f92672">.</span>append(layer<span style="color:#f92672">.</span>name)
images_per_row <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>

activation_model <span style="color:#f92672">=</span> models<span style="color:#f92672">.</span>Model(inputs<span style="color:#f92672">=</span>model<span style="color:#f92672">.</span>input, outputs<span style="color:#f92672">=</span>layer_outputs)
activations <span style="color:#f92672">=</span> activation_model<span style="color:#f92672">.</span>predict(X_train[[<span style="color:#ae81ff">0</span>]])

<span style="color:#66d9ef">for</span> layer_name, layer_activation <span style="color:#f92672">in</span> zip(layer_names, activations):
    n_features <span style="color:#f92672">=</span> layer_activation<span style="color:#f92672">.</span>shape[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]

    size <span style="color:#f92672">=</span> layer_activation<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]

    n_cols <span style="color:#f92672">=</span> n_features <span style="color:#f92672">//</span> images_per_row
    display_grid <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros((size <span style="color:#f92672">*</span> n_cols, images_per_row <span style="color:#f92672">*</span> size))

    <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> range(n_cols):
        <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> range(images_per_row):
            channel_image <span style="color:#f92672">=</span> layer_activation[<span style="color:#ae81ff">0</span>,
                                             :, :,
                                             col <span style="color:#f92672">*</span> images_per_row <span style="color:#f92672">+</span> row]
            channel_image <span style="color:#f92672">-=</span> channel_image<span style="color:#f92672">.</span>mean()
            channel_image <span style="color:#f92672">/=</span> channel_image<span style="color:#f92672">.</span>std()
            channel_image <span style="color:#f92672">*=</span> <span style="color:#ae81ff">64</span>
            channel_image <span style="color:#f92672">+=</span> <span style="color:#ae81ff">128</span>
            channel_image <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>clip(channel_image, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;uint8&#39;</span>)
            display_grid[col <span style="color:#f92672">*</span> size : (col <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> size,
                         row <span style="color:#f92672">*</span> size : (row <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> size] <span style="color:#f92672">=</span> channel_image

    scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.</span> <span style="color:#f92672">/</span> size
    plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(scale <span style="color:#f92672">*</span> display_grid<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>],
                        scale <span style="color:#f92672">*</span> display_grid<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]))
    plt<span style="color:#f92672">.</span>title(layer_name)
    plt<span style="color:#f92672">.</span>grid(False)
    plt<span style="color:#f92672">.</span>imshow(display_grid, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;viridis&#39;</span>)
    plt<span style="color:#f92672">.</span>show()
    plt<span style="color:#f92672">.</span>close()
</code></pre></div><p><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-9.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-10.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-11.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-12.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-13.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-14.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-15.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-16.png" width="1536" /><img src="../../../en/post/post20/index_files/figure-html/unnamed-chunk-13-17.png" width="576" /></p>
<p>I still can&rsquo;t understand this one.</p>
<h2 id="5summary">5.Summary</h2>
<p>I removed the stable background and rerun it, but the results were the same - it was a good experience using PyTorch and removing the background, but not with any results, so I&rsquo;ll stop with the horse photos for now.</p>

          </div>

          






<div class="article-tags">
  
  <a class="badge badge-light" href="../../../en/tag/python/">Python</a>
  
  <a class="badge badge-light" href="../../../en/tag/machine_learning/">machine_learning</a>
  
  <a class="badge badge-light" href="../../../en/tag/preprocessing/">preprocessing</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=../../../en/post/post20/&amp;text=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/en/post/post20/&amp;t=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model&amp;body=/en/post/post20/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=../../../en/post/post20/&amp;title=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model%20/en/post/post20/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=../../../en/post/post20/&amp;title=Automatically%20cropping%20the%20background%20of%20a%20horse%20body%20photo%20with%20Pytorch&amp;#39;s%20Pre-trained%20model" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="../../../"><img class="avatar mr-3 avatar-circle" src="../../../en/author/ayato-ashihara/avatar_hu77c0c0affdebd3b9cbda9c39412092b5_245163_270x270_fill_q90_lanczos_center.jpg" alt="Ayato Ashihara"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="../../../">Ayato Ashihara</a></h5>
      <h6 class="card-subtitle">company employee</h6>
      <p class="card-text">This blog is a nightly update by a man who is working in his forth year since completing graduate school. The content of this blog has nothing to do with the official position of the author&rsquo;s organization.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="../../../en/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/ASSIY" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/AyatoAshihara/myblog_multi" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>







<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "ayatoashihara-github-io-myblog-multi" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>








  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="../../../en/post/post16/">Predicting Horse Racing Results Using LightGBM</a></li>
      
      <li><a href="../../../en/post/post22/">Get macro panel data from OECD.org via API</a></li>
      
      <li><a href="../../../en/post/post18/">I predicted the standings based on horse photos using CNN.</a></li>
      
      <li><a href="../../../en/post/post12/">Obtaining satellite image data with the Google Earth Engine API and do nowcasting on business conditions</a></li>
      
      <li><a href="../../../en/post/post21/">Rcpp to speed up data handling (using Tick data processing as an example)</a></li>
      
    </ul>
  </div>
  





        </div>
      </article>
    </main>

  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.0/mermaid.min.js" integrity="sha512-ja+hSBi4JDtjSqc4LTBsSwuBT3tdZ3oKYKd07lTVYmCnTCor56AnRql00ssqnTOR9Ss4gOP/ROGB3SfcJnZkeg==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/latex.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/SQL.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/C&#43;&#43;.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/en/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://ayatoashihara-github-io-myblog-multi.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="../../../js/wowchemy.min.4c2bca31150ce93c5a5e43b8a50f22fd.js"></script>

    


  
  
  <div class="container">
    <footer class="site-footer">
  

  
   
  <script>
  $(document).ready(function () {
    window.initializeCodeFolding("show" === "show");
  });
  </script>
  <script src="../../../js/codefolding.js"></script>


  <p class="powered-by">
    
  </p>

  
  






  <p class="powered-by">
    
    Published with
    <a href="https://wowchemy.com" target="_blank" rel="noopener">Wowchemy</a>  —
    the free, <a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">
    open source</a> website builder that empowers creators.
    

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
