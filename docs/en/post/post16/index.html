<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  
  
  <meta name="generator" content="Wowchemy 4.8.0 for Hugo">
  

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Ayato Ashihara">

  
  
  
    
  
  <meta name="description" content="I used Kaggler&#39;s favorite LightGBM to predict the horse race standings.">

  
  <link rel="alternate" hreflang="ja" href="../../../post/post16/">
  
  <link rel="alternate" hreflang="en-us" href="../../../en/post/post16/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="../../../js/mathjax-config.js"></script>
  

  
  
  
  
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-light">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/solarized-dark.min.css" crossorigin="anonymous" title="hl-dark" disabled>
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.2/lazysizes.min.js" integrity="sha512-TmDwFLhg3UA4ZG0Eb4MIyT1O1Mb+Oww5kFG0uHqXsdbyZz9DcvYQhKpGgNkamAI6h2lGGZq2X8ftOJvF/XjTUg==" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="../../../css/wowchemy.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-140804055-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-140804055-1', { 'anonymize_ip': true });

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="../../../en/index.webmanifest">
  <link rel="icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="../../../images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="../../../en/post/post16/">

  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@vdjgdkhvskcndj">
  <meta property="twitter:creator" content="@vdjgdkhvskcndj">
  
  <meta property="og:site_name" content="京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:url" content="/en/post/post16/">
  <meta property="og:title" content="Predicting Horse Racing Results Using LightGBM | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ">
  <meta property="og:description" content="I used Kaggler&#39;s favorite LightGBM to predict the horse race standings."><meta property="og:image" content="/en/post/post16/featured.jpg">
  <meta property="twitter:image" content="/en/post/post16/featured.jpg"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-02-29T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2020-02-29T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/en/post/post16/"
  },
  "headline": "Predicting Horse Racing Results Using LightGBM",
  
  "image": [
    "/en/post/post16/featured.jpg"
  ],
  
  "datePublished": "2020-02-29T00:00:00Z",
  "dateModified": "2020-02-29T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Ayato Ashihara"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "京都の電子部品メーカーで働く社会人が研究に没頭するブログ",
    "logo": {
      "@type": "ImageObject",
      "url": "/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "I used Kaggler's favorite LightGBM to predict the horse race standings."
}
</script>

  

  


  
  
  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js" integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css" integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin="anonymous">
  
  <script>
  window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#2962ff",
          "text": "rgb(255, 255, 255)"
        },
        "button": {
          "background": "rgb(255, 255, 255)",
          "text": "#2962ff"
        }
      },
      "theme": "classic",
      "content": {
        "message": "This website uses cookies to ensure you get the best experience on our website.",
        "dismiss": "Got it!",
        "link": "Learn more",
        "href": "https://www.cookiesandyou.com"
      }
    })});
  </script>



  





  <title>Predicting Horse Racing Results Using LightGBM | 京都の電子部品メーカーで働く社会人が研究に没頭するブログ</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class=" ">

  
  
  
    <script>window.wcDarkLightEnabled = true;</script>
  
  
    <script>const isSiteThemeDark = false;</script>
  
  
  <script src="../../../js/load-theme.js"></script>

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="../../../en">京都の電子部品メーカーで働く社会人が研究に没頭するブログ</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#about"><span>About</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link  active" href="../../../en/post"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/publication"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../../en/#contact"><span>Contact</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      
      <li class="nav-item dropdown i18n-dropdown">
        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-globe mr-1" aria-hidden="true"></i><span class="d-none d-lg-inline">English</span></a>
        <div class="dropdown-menu">
          <div class="dropdown-item dropdown-item-active">
            <span>English</span>
          </div>
          
          <a class="dropdown-item" href="../../../post/post16/">
            <span>日本語</span>
          </a>
          
        </div>
      </li>
      

    </ul>

  </div>
</nav>



  <div class="container-fluid docs">
  <div class="row flex-xl-nowrap">

    <div class="d-none d-xl-block col-xl-2 docs-toc">
      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">Contents</a></li>
      </ul>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1data-import">1.Data Import</a></li>
        <li><a href="#2-creating-a-model">2. Creating a Model</a></li>
        <li><a href="#3-interpreting-results-in-shap">3. Interpreting results in shap</a></li>
        <li><a href="#4-summary">4. Summary</a></li>
      </ul>
    </li>
  </ul>
</nav>
      
    </div>

    <main class="col-12 col-md-0 col-xl-10 py-md-3 pl-md-5 docs-content" role="main">
      <article class="article">

        




















  
  


<div class="article-container pt-3">
  <h1>Predicting Horse Racing Results Using LightGBM</h1>

  

  

<div id="code-folding-buttons" class="dropdown btn-group pull-right">
  <a class="btn btn-light btn-sm dropdown-toggle" href="#" role="button" id="allCodeToggleButton"
     data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Code
  </a>
  <div class="dropdown-menu" aria-labelledby="allCodeToggleButton">
    <a id="rmd-show-all-code" class="dropdown-item small" href="#">Show all</a>
    <a id="rmd-hide-all-code" class="dropdown-item small" href="#">Hide all</a>
  </div>
</div>



  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Feb 29, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  
  
  <span class="middot-divider"></span>
  <a href="../../../en/post/post16/#disqus_thread"></a>
  

  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder mr-1"></i><a href="../../../en/category/horse_racing/">horse_racing</a></span>
  

</div>

  














</div>


<div class="article-header container featured-image-wrapper mt-4 mb-4" style="max-width: 1200px; max-height: 787px;">
  <div style="position: relative">
    <img src="../../../en/post/post16/featured.jpg" alt="" class="featured-image">
    
  </div>
</div>



        <div class="article-container">

          <div class="article-style">
            <p>Hi. It&rsquo;s been quite a while, but I&rsquo;d like to create a model to predict the outcome of a race based on race result data previously collected from yahoo.keiba in order to study Python.</p>
<h2 id="1data-import">1.Data Import</h2>
<p>First, I get the race result data saved from <code>sqlite</code> to the <code>pandas</code> data frame.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">conn <span style="color:#f92672">=</span> sqlite3<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;C:\hogehoge\horse_data.db&#39;</span>)
sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;SELECT * FROM race_result&#39;</span>
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_sql(con<span style="color:#f92672">=</span>conn,sql<span style="color:#f92672">=</span>sql)
</code></pre></div><p>Let&rsquo;s check the contents of the data. The columns are as follows, with order being the order of arrival.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>columns
</code></pre></div><pre><code>## Index(['order', 'frame_number', 'horse_number', 'trainer', 'passing_rank',
##        'last_3F', 'time', 'margin', 'horse_name', 'horse_age', 'horse_sex',
##        'horse_weight', 'horse_weight_change', 'brinker', 'jockey',
##        'jockey_weight', 'jockey_weight_change', 'odds', 'popularity',
##        'race_date', 'race_course', 'race_name', 'race_distance', 'type',
##        'race_turn', 'race_condition', 'race_weather', 'colour', 'owner',
##        'farm', 'locality', 'horse_birthday', 'father', 'mother', 'prize',
##        'http'],
##       dtype='object')
</code></pre><p>Checking the contents of the order, you&rsquo;ll see that many of the orders have parentheses () and that they are recognized by the letter type because of the presence of cancellation, abort and disqualification. By the way, the order in parentheses is the order of entry, which means that the horse has been disqualified for interfering with another horse&rsquo;s running (<a href="http://www.jra.go.jp/judge/)">http://www.jra.go.jp/judge/)</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>loc[:,<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>unique()
</code></pre></div><pre><code>## array(['1', '7', '2', '8', '5', '15', '6', '12', '11', '14', '3', '13',
##        '4', '16', '9', '10', '取消', '中止', '除外', '17', '18', '4(3)', '2(1)',
##        '3(2)', '6(4)', '失格', '9(8)', '16(6)', '12(12)', '13(9)', '6(3)',
##        '10(7)', '6(5)', '9(3)', '11(8)', '13(2)', '12(9)', '14(7)',
##        '10(1)', '16(8)', '14(6)', '10(3)', '12(1)', '13(6)', '7(1)',
##        '12(6)', '6(2)', '11(2)', '15(6)', '13(10)', '14(4)', '7(5)',
##        '17(4)', '9(7)', '16(14)', '12(11)', '14(2)', '8(2)', '9(5)',
##        '11(5)', '12(7)', '11(1)', '12(8)', '7(4)', '5(4)', '13(12)',
##        '14(3)', '10(2)', '11(10)', '18(3)', '10(4)', '15(8)', '8(3)',
##        '5(1)', '10(5)', '7(3)', '5(2)', '9(1)', '13(3)', '16(11)',
##        '11(3)', '18(15)', '11(6)', '10(6)', '14(12)', '12(5)', '15(14)',
##        '17(8)', '18(6)', '4(2)', '18(10)', '16(7)', '13(1)', '16(10)',
##        '15(7)', '9(4)', '15(5)', '12(3)', '8(7)', '15(2)', '12(10)',
##        '14(9)', '3(1)', '6(1)', '14(5)', '15(4)', '11(4)', '12(4)',
##        '16(4)', '9(2)', '13(5)', '12(2)', '15(1)', '4(1)', '14(13)',
##        '14(1)', '13(7)', '5(3)', '8(6)', '15(13)', '7(2)', '15(11)',
##        '10(9)', '11(9)', '8(4)', '15(3)', '13(4)', '16(12)', '16(5)',
##        '18(11)', '10(8)', '18(8)', '14(8)', '16(9)', '8(5)', '8(1)',
##        '14(11)', '9(6)', '16(13)', '16(15)', '11(11)', '15(10)', '7(6)'],
##       dtype=object)
</code></pre><p>Let&rsquo;s fix this first. Remove the parentheses and change the type to int, and add the arrival order as a new column <code>arriving order</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;arriving order&#39;</span>] <span style="color:#f92672">=</span> df[df<span style="color:#f92672">.</span>order<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\d*\(\d*\)&#39;</span>,regex<span style="color:#f92672">=</span>True)][<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\d+\(&#39;</span>,<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;</span>,regex<span style="color:#f92672">=</span>True)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\)&#39;</span>,<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;</span>,regex<span style="color:#f92672">=</span>True)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;arriving order&#39;</span>]<span style="color:#f92672">.</span>unique()
</code></pre></div><pre><code>## array([nan,  3.,  1.,  2.,  4.,  8.,  6., 12.,  9.,  7.,  5., 10., 14.,
##        11., 15., 13.])
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;order&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\(\d+\)&#39;</span>,<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;</span>,regex<span style="color:#f92672">=</span>True)
df <span style="color:#f92672">=</span> df[<span style="color:#66d9ef">lambda</span> df: <span style="color:#f92672">~</span>df<span style="color:#f92672">.</span>order<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>contains(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(取消|中止|除外|失格)&#39;</span>,regex<span style="color:#f92672">=</span>True)]
</code></pre></div><pre><code>## C:\Users\aashi\ANACON~1\lib\site-packages\pandas\core\strings.py:1954: UserWarning: This pattern has match groups. To actually get the groups, use str.extract.
##   return func(self, *args, **kwargs)
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;order&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>unique()
</code></pre></div><pre><code>## array([ 1.,  7.,  2.,  8.,  5., 15.,  6., 12., 11., 14.,  3., 13.,  4.,
##        16.,  9., 10., 17., 18.])
</code></pre><p>We were able to process it into a clean <code>float</code> type. Now let&rsquo;s move on to preprocessing the last three furlongs' times. We use the last three furlongs' time of the last race for our prediction.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
df[<span style="color:#e6db74">&#39;last_3F&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;last_3F&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;character(0)&#39;</span>,np<span style="color:#f92672">.</span>nan,regex<span style="color:#f92672">=</span>False)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;last_3F&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;last_3F&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>Also include the previous race and rankings and any additional positions in the dataset.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;prerace&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;race_name&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
df[<span style="color:#e6db74">&#39;preorder&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
df[<span style="color:#e6db74">&#39;prepassing&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;passing_rank&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>The accumulated prize money earned at the time of running will also be added.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;preprize&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;prize&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
df[<span style="color:#e6db74">&#39;preprize&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;preprize&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#ae81ff">0</span>)
df[<span style="color:#e6db74">&#39;margin&#39;</span>] <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;horse_name&#39;</span>)[<span style="color:#e6db74">&#39;margin&#39;</span>]<span style="color:#f92672">.</span>shift(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>We also add missing values, data type fixes, and label encoding for categorical data.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df[<span style="color:#e6db74">&#39;horse_weight&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;horse_weight&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;margin&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;margin&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;character(0)&#39;</span>,np<span style="color:#f92672">.</span>nan,regex<span style="color:#f92672">=</span>False)
df[<span style="color:#e6db74">&#39;horse_age&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;horse_age&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;horse_weight_change&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;horse_weight_change&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;jockey_weight&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;jockey_weight&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;race_distance&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;race_distance&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;m&#39;</span>,<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;&#39;</span>,regex<span style="color:#f92672">=</span>True)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;float64&#39;</span>)
df[<span style="color:#e6db74">&#39;race_turn&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;race_turn&#39;</span>]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;character(0)&#39;</span>,np<span style="color:#f92672">.</span>nan,regex<span style="color:#f92672">=</span>False)
df<span style="color:#f92672">.</span>loc[df[<span style="color:#e6db74">&#39;order&#39;</span>]<span style="color:#f92672">!=</span><span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;order&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

df[<span style="color:#e6db74">&#39;race_turn&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;race_turn&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)
df[<span style="color:#e6db74">&#39;colour&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;colour&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)
df[<span style="color:#e6db74">&#39;prepassing&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;prepassing&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)
df[<span style="color:#e6db74">&#39;prerace&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;prerace&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)
df[<span style="color:#e6db74">&#39;father&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;father&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)
df[<span style="color:#e6db74">&#39;mother&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;mother&#39;</span>]<span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#39;missing&#39;</span>)

<span style="color:#f92672">from</span> sklearn <span style="color:#f92672">import</span> preprocessing
cat_list <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;trainer&#39;</span>, <span style="color:#e6db74">&#39;horse_name&#39;</span>, <span style="color:#e6db74">&#39;horse_sex&#39;</span>, <span style="color:#e6db74">&#39;brinker&#39;</span>, <span style="color:#e6db74">&#39;jockey&#39;</span>, <span style="color:#e6db74">&#39;race_course&#39;</span>, <span style="color:#e6db74">&#39;race_name&#39;</span>, <span style="color:#e6db74">&#39;type&#39;</span>, <span style="color:#e6db74">&#39;race_turn&#39;</span>, <span style="color:#e6db74">&#39;race_condition&#39;</span>, <span style="color:#e6db74">&#39;race_weather&#39;</span>, <span style="color:#e6db74">&#39;colour&#39;</span>, <span style="color:#e6db74">&#39;father&#39;</span>, <span style="color:#e6db74">&#39;mother&#39;</span>, <span style="color:#e6db74">&#39;prerace&#39;</span>, <span style="color:#e6db74">&#39;prepassing&#39;</span>]
<span style="color:#66d9ef">for</span> column <span style="color:#f92672">in</span> cat_list:
    target_column <span style="color:#f92672">=</span> df[column]
    le <span style="color:#f92672">=</span> preprocessing<span style="color:#f92672">.</span>LabelEncoder()
    le<span style="color:#f92672">.</span>fit(target_column)
    label_encoded_column <span style="color:#f92672">=</span> le<span style="color:#f92672">.</span>transform(target_column)
    df[column] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(label_encoded_column)<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#39;category&#39;</span>)
</code></pre></div><pre><code>## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
## LabelEncoder()
</code></pre><h2 id="2-creating-a-model">2. Creating a Model</h2>
<p>Now, let&rsquo;s try to build a prediction model with <code>LightGBM</code>. The <code>optuna</code> <code>LightGBM</code> is used to perform hyperparameter tuning and calculate the <code>confusion matrix</code>, as well as the correctness rate of test data calculated with the trained model.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> optuna.integration.lightgbm <span style="color:#f92672">as</span> lgb
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split

y <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;order&#39;</span>]
x <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;order&#39;</span>,<span style="color:#e6db74">&#39;passing_rank&#39;</span>,<span style="color:#e6db74">&#39;time&#39;</span>,<span style="color:#e6db74">&#39;odds&#39;</span>,<span style="color:#e6db74">&#39;popularity&#39;</span>,<span style="color:#e6db74">&#39;owner&#39;</span>,<span style="color:#e6db74">&#39;farm&#39;</span>,<span style="color:#e6db74">&#39;locality&#39;</span>,<span style="color:#e6db74">&#39;horse_birthday&#39;</span>,<span style="color:#e6db74">&#39;http&#39;</span>,<span style="color:#e6db74">&#39;prize&#39;</span>,<span style="color:#e6db74">&#39;race_date&#39;</span>,<span style="color:#e6db74">&#39;margin&#39;</span>],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)

X_train, X_test, y_train, y_test <span style="color:#f92672">=</span> train_test_split(x, y)
X_train, x_val, y_train, y_val <span style="color:#f92672">=</span> train_test_split(X_train, y_train)

lgb_train <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_train, y_train)
lgb_eval <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(x_val, y_val)
lgb_test <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>Dataset(X_test, y_test, reference<span style="color:#f92672">=</span>lgb_train)

lgbm_params <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;objective&#39;</span>: <span style="color:#e6db74">&#39;binary&#39;</span>,
        <span style="color:#e6db74">&#39;boost_from_average&#39;</span>: False
    }

model <span style="color:#f92672">=</span> lgb<span style="color:#f92672">.</span>train(lgbm_params, lgb_train, categorical_feature <span style="color:#f92672">=</span> cat_list, valid_sets <span style="color:#f92672">=</span> lgb_eval,  num_boost_round<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>, early_stopping_rounds<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, verbose_eval<span style="color:#f92672">=</span>False)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">calibration</span>(y_proba, beta):
    <span style="color:#66d9ef">return</span> y_proba <span style="color:#f92672">/</span> (y_proba <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> y_proba) <span style="color:#f92672">/</span> beta)

sampling_rate <span style="color:#f92672">=</span> y_train<span style="color:#f92672">.</span>sum() <span style="color:#f92672">/</span> len(y_train)
y_proba <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(X_test, num_iteration<span style="color:#f92672">=</span>model<span style="color:#f92672">.</span>best_iteration)
y_proba_calib <span style="color:#f92672">=</span> calibration(y_proba, sampling_rate)

y_pred <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>vectorize(<span style="color:#66d9ef">lambda</span> x: <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0.49</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)(y_proba_calib)
</code></pre></div><p>Visualization part.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix, ConfusionMatrixDisplay, accuracy_score, precision_score, recall_score, f1_score, roc_curve, auc
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns

<span style="color:#75715e"># Calculating the AUC (Area Under the Curve)</span>
fpr, tpr, thresholds <span style="color:#f92672">=</span> roc_curve(y_test, y_pred)
auc <span style="color:#f92672">=</span> auc(fpr, tpr)

<span style="color:#75715e"># Plot the ROC curve</span>
plt<span style="color:#f92672">.</span>plot(fpr, tpr, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ROC curve (area = </span><span style="color:#e6db74">%.2f</span><span style="color:#e6db74">)&#39;</span><span style="color:#f92672">%</span>auc)
plt<span style="color:#f92672">.</span>legend()
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;ROC curve&#39;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;False Positive Rate&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;True Positive Rate&#39;</span>)
plt<span style="color:#f92672">.</span>grid(True)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()

<span style="color:#75715e"># Generate a Confusion Matrix</span>
ConfusionMatrixDisplay(confusion_matrix(y_test, y_pred))<span style="color:#f92672">.</span>plot()
</code></pre></div><pre><code>## &lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay object at 0x00000000C690E288&gt;
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-15-2.png" width="672" /></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#f92672">.</span>close()

accuracy_score(y_test, y_pred)
</code></pre></div><pre><code>## 0.9300689387764461
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">precision_score(y_test, y_pred)
</code></pre></div><pre><code>## 0.9185022026431718
</code></pre><p>The <code>accuracy_score</code> (prediction accuracy) is over 90% and the <code>precision_Score</code> (the percentage of data correct that predicted positive = 1) is good.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">recall_score(y_test, y_pred)
</code></pre></div><pre><code>## 0.012291457878912929
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">f1_score(y_test, y_pred)
</code></pre></div><pre><code>## 0.02425828970331588
</code></pre><p>On the other hand, we can see that the <code>recall_score</code> (percentage of sample that was predicted to be positive and actually true) is low and the false negative is high. As a result, the <code>F1</code> value is also low. In the case of the horse racing prediction model, high false negatives are better than high false positives, but we have to work harder to reduce the false negatives to increase the return rate. This is an issue for the future. In the next section, I will use the <code>shapley</code> value to do a factorization.</p>
<h2 id="3-interpreting-results-in-shap">3. Interpreting results in shap</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> shap

shap<span style="color:#f92672">.</span>initjs()
</code></pre></div><pre><code>## &lt;IPython.core.display.HTML object&gt;
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">explainer <span style="color:#f92672">=</span> shap<span style="color:#f92672">.</span>TreeExplainer(model)
</code></pre></div><pre><code>## Setting feature_perturbation = &quot;tree_path_dependent&quot; because no background data was given.
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">shap_values <span style="color:#f92672">=</span> explainer<span style="color:#f92672">.</span>shap_values(X_test)
</code></pre></div><pre><code>## LightGBM binary classifier with TreeExplainer shap values output has changed to a list of ndarray
</code></pre><p>First, we&rsquo;ll see how important each feature is. The <code>summary_plot</code> method is used.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">shap<span style="color:#f92672">.</span>summary_plot(shap_values, X_test)
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-18-5.png" width="768" /></p>
<p>The horizontal axis represents the average importance of each feature (absolute value of the shap value), and we can see that preprize (amount of money won up to the last race), horse_age, and preorder (order of finish in the last race) are all important in predicting the winner of the race. The same is true for horse_age. However, it is not possible to evaluate it qualitatively just because it is important. For example, if the relationship between a higher preprize and a higher probability of being first is confirmed, that can be important information. Then you can check it. The <code>summary_plot</code> method is used.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">shap<span style="color:#f92672">.</span>summary_plot(shap_values[<span style="color:#ae81ff">1</span>], X_test)
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-19-7.png" width="768" /></p>
<p>The above figure also shows the importance of each feature (not absolute values in this case). In this case, the importance of each feature is shown in the violin plot and is colored according to the size of the feature value. For example, in the case of preprize, the red distribution occurs only where the horizontal axis is greater than 0, and this is where the feature value of preprize is large. This means that we can take the obvious interpretation that the probability of finishing first increases on average with the amount of money won up to the previous race.
Other factors such as horse_age, preorder, and last_3F seem to increase the probability of finishing first as the feature value becomes smaller, while horse_weight and jokey_weight seem to increase the probability of finishing first as the feature value becomes larger. On the other hand, there is no qualitative relationship between the two variables.</p>
<p>Next, let&rsquo;s look at the relationship between feature value and probability in more detail. We saw earlier that preprize increases the probability of being the first one to arrive as the feature value increases. But we don&rsquo;t know if the increase is linear, exponential, or diminishing as in dependence on <code>\(log x\)</code>. Let&rsquo;s find out with the <code>dependence_plot</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">shap<span style="color:#f92672">.</span>dependence_plot(ind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;preprize&#34;</span>, shap_values<span style="color:#f92672">=</span>shap_values[<span style="color:#ae81ff">1</span>], features<span style="color:#f92672">=</span>X_test)
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-20-9.png" width="720" /></p>
<p>The above figure plots the approximate form of the learned <code>LightGBM</code> as a function of preprize. As we saw earlier, the probability of being the first one to be placed increases as the feature value increases. However, the increase is gradual and diminishing, and it almost reaches its peak at over 20 million yen. Also, in the figure above, we have color-coded by HORSE_AGE, so you can see the relationship with PREPRIZE. As you might expect, the probability of horses with high preprize is higher for the youngest horses to win the race.</p>
<p>Let&rsquo;s also check the <code>dependence_plot</code> of the preorder.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">shap<span style="color:#f92672">.</span>dependence_plot(ind<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;preorder&#34;</span>, shap_values<span style="color:#f92672">=</span>shap_values[<span style="color:#ae81ff">1</span>], features<span style="color:#f92672">=</span>X_test)
</code></pre></div><p><img src="../../../en/post/post16/index_files/figure-html/unnamed-chunk-21-11.png" width="720" /></p>
<p>As expected, the higher the order of the last race, the higher the probability of finishing first. I also checked the relationship with the time of last_3F, but it doesn&rsquo;t seem to be very relevant here.</p>
<h2 id="4-summary">4. Summary</h2>
<p>I made a prediction model of horse racing using <code>LightGBM</code>. As you would expect of <code>Light GBM</code>, the prediction accuracy is very high. Also, the <code>shap</code> value was successfully used to detect important features. This will help us understand how <code>LightGBM</code> feels and improve our modeling accuracy as we continue to find better features.</p>

          </div>

          






<div class="article-tags">
  
  <a class="badge badge-light" href="../../../en/tag/python/">Python</a>
  
  <a class="badge badge-light" href="../../../en/tag/preprocessing/">preprocessing</a>
  
  <a class="badge badge-light" href="../../../en/tag/machine_learning/">machine_learning</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=../../../en/post/post16/&amp;text=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=/en/post/post16/&amp;t=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM&amp;body=/en/post/post16/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=../../../en/post/post16/&amp;title=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM%20/en/post/post16/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=../../../en/post/post16/&amp;title=Predicting%20Horse%20Racing%20Results%20Using%20LightGBM" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="../../../"><img class="avatar mr-3 avatar-circle" src="../../../en/author/ayato-ashihara/avatar_hu77c0c0affdebd3b9cbda9c39412092b5_245163_270x270_fill_q90_lanczos_center.jpg" alt="Ayato Ashihara"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="../../../">Ayato Ashihara</a></h5>
      <h6 class="card-subtitle">company employee</h6>
      
      
      
      
        
      
      
        <p class="card-text author-dynamic">
















  
  
  
    
  



  
  
  
  
  
  
  
    
  




  
  
    
      In his 2018; currently in year 8 of professional career. updates nightly. The content does not reflect the views of the author&#39;s organization.
    
  

</p>
      
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="../../../en/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.facebook.com/ASSIY" target="_blank" rel="noopener">
        <i class="fab fa-facebook"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/AyatoAshihara/myblog_multi" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/%E5%BD%A9%E4%BA%BA-%E8%91%A6%E5%8E%9F-9391b7143/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>







<section id="comments">
  
    
<div id="disqus_thread"></div>
<script>
  let disqus_config = function () {
    
    
    
  };
  (function() {
    if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
      document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
      return;
    }
    var d = document, s = d.createElement('script'); s.async = true;
    s.src = 'https://' + "ayatoashihara-github-io-myblog-multi" + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  
</section>




<div class="article-widget">
  
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Next</div>
    <a href="../../../en/post/post18/" rel="next">I predicted the standings based on horse photos using CNN.</a>
  </div>
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">Previous</div>
    <a href="../../../en/post/post14/" rel="prev">Fitting the 10-year long-term interest rate</a>
  </div>
  
</div>

</div>





  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="../../../en/post/post20/">Automatically cropping the background of a horse body photo with Pytorch&#39;s Pre-trained model</a></li>
      
      <li><a href="../../../en/post/post18/">I predicted the standings based on horse photos using CNN.</a></li>
      
      <li><a href="../../../en/post/post22/">Get macro panel data from OECD.org via API</a></li>
      
      <li><a href="../../../en/post/post12/">Obtaining satellite image data with the Google Earth Engine API and do nowcasting on business conditions</a></li>
      
      <li><a href="../../../en/post/post21/">Rcpp to speed up data handling (using Tick data processing as an example)</a></li>
      
    </ul>
  </div>
  





        </div>
      </article>
    </main>

  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.8.0/mermaid.min.js" integrity="sha512-ja+hSBi4JDtjSqc4LTBsSwuBT3tdZ3oKYKd07lTVYmCnTCor56AnRql00ssqnTOR9Ss4gOP/ROGB3SfcJnZkeg==" crossorigin="anonymous" title="mermaid"></script>
      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/latex.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/sql.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/cpp.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/en/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    
    <script id="dsq-count-scr" src="https://ayatoashihara-github-io-myblog-multi.disqus.com/count.js" async></script>
    

    
    
    
    
    
    
    
    
    
      
    
    
      
    
    
    
    <script src="../../../js/wowchemy.min.2a3f95be2bc4762ba1847fb5d7a28317.js"></script>

    


  
  
  <div class="container">
    <footer class="site-footer">
  

  
   
  <script>
  $(document).ready(function () {
    window.initializeCodeFolding("show" === "show");
  });
  </script>
  <script src="../../../js/codefolding.js"></script>


  <p class="powered-by">
    
  </p>

  
  






  <p class="powered-by">
    
    Published with
    <a href="https://wowchemy.com" target="_blank" rel="noopener">Wowchemy</a>  —
    the free, <a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">
    open source</a> website builder that empowers creators.
    

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
